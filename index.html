<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³°åœ‹ä½›å ‚_å…±ç”¨è¡Œäº‹æ›†</title>
    
    <!-- æ ¸å¿ƒå¥—ä»¶ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* =========================================
           ğŸµ æº«æ½¤æ—¥ç³»é¢¨æ ¼ (Warm & Cozy Style) - æœ€çµ‚ç‰ˆ
           ========================================= */
        
        :root {
            --bg-color: #FDFCF5;       
            --card-bg: #FFFFFF;        
            --text-primary: #5D4037;   
            --text-secondary: #8D6E63; 
            --border-color: #EFEBE9;   
            --accent-color: #8D6E63;   /* æš–è¤è‰² (æŒ‰éˆ•ä¸»è‰²) */
            --primary-action: #4FC3F7; /* æ¸…é€è— (æ–°å¢æŒ‰éˆ•) */
            --border-radius: 10px;     
        }

        body { 
            background-color: var(--bg-color);
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; 
            color: var(--text-primary);
        }
        
        .container { max-width: 1200px; margin-top: 40px; margin-bottom: 80px; }
        
        h2 { 
            font-weight: 700; 
            color: var(--text-primary); 
            letter-spacing: 1.5px; 
            font-size: 1.8rem;
            border-bottom: 3px solid #D7CCC8;
            display: inline-block;
            padding-bottom: 5px;
        }
        
        #calendar { 
            background: var(--card-bg);
            padding: 25px; 
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(141, 110, 99, 0.08);
            border: 1px solid var(--border-color);
        }
        
        /* å›ºå®šé«˜åº¦ (5è¡Œ) */
        .fc-daygrid-day-frame {
            height: 130px !important; 
            min-height: 130px !important;
            max-height: 130px !important;
            overflow: hidden;
            position: relative; 
        }

        /* å£“ç¸®æ—¥æœŸæ¬„ä½ */
        .fc-daygrid-day-top {
            flex-direction: row;
            padding: 1px 4px !important; 
            height: 24px !important;     
            min-height: 24px !important;
        }
        .fc-daygrid-day-number {
            font-size: 0.9rem;
            line-height: 1; 
            margin: 0 !important;
        }

        /* ç§»é™¤æ—¥æœŸé€£çµåº•ç·š */
        a.fc-col-header-cell-cushion, 
        a.fc-daygrid-day-number {
            text-decoration: none !important;
            color: var(--text-secondary) !important;
            cursor: pointer; 
        }
        a.fc-col-header-cell-cushion:hover, 
        a.fc-daygrid-day-number:hover {
            text-decoration: none !important; 
            color: var(--text-primary) !important;
        }

        /* æœå°‹è·³è½‰çš„é«˜äº®å‹•ç•« */
        @keyframes flash-highlight {
            0% { background-color: rgba(255, 235, 59, 0.8); box-shadow: inset 0 0 20px rgba(255, 215, 0, 0.6); }
            100% { background-color: transparent; box-shadow: none; }
        }
        .highlight-target-day {
            animation: flash-highlight 2.5s ease-out;
            position: relative;
            z-index: 10; 
        }
        
        /* --- äº‹ä»¶æ¨£å¼ --- */
        .fc-event { 
            cursor: pointer; border: none !important; 
            box-shadow: 0 1px 1px rgba(93, 64, 55, 0.1); 
            font-size: 0.8rem; 
            margin-bottom: 1px !important; 
            border-radius: 4px !important; 
            padding: 1px 6px !important;   
            line-height: 1.3 !important;   
        }
        .fc-event:hover { transform: translateY(-1px); filter: brightness(0.95); z-index: 5; }
        
        .person-pill { 
            display: inline-block !important; 
            width: auto !important; 
            margin-right: 4px !important; 
            white-space: nowrap; 
            font-weight: 500;
            color: #5D4037 !important;
        }
        
        .event-type-activity { 
            background-color: #F8BBD0; 
            border-left: 4px solid #EC407A !important; 
            color: #5D4037 !important; 
            font-weight: bold; 
            width: 100% !important; 
            display: block !important;
            margin-bottom: 2px !important; 
        }
        
        .hide-time-text .fc-event-time { display: none !important; }

        .fc-daygrid-day-events { 
            display: flex !important; flex-wrap: wrap !important; 
            align-content: flex-start !important; 
            gap: 1px !important; 
            padding: 0 2px !important; 
            margin-top: 0 !important;  
        }
        .fc-daygrid-event-harness { width: auto !important; max-width: 100%; }
        .fc-daygrid-event-harness:has(.event-type-activity) { width: 100% !important; flex-basis: 100% !important; }

        /* UI å…ƒä»¶ */
        .fc-header-toolbar { margin-bottom: 20px !important; }
        .fc-toolbar-chunk { display: flex; align-items: center; gap: 8px; }
        .fc-toolbar-title { font-size: 1.6rem !important; color: var(--text-primary); letter-spacing: 1px; font-weight: 700; margin: 0 15px !important; }
        .fc-col-header-cell { background-color: #FFF8E1; padding: 8px 0; border-bottom: 2px solid #FFE0B2; color: var(--text-primary); }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .fc-button-primary {
            background-color: var(--accent-color) !important;
            border-color: var(--accent-color) !important;
            color: #FFFFFF !important;
            border-radius: 8px !important;
            font-weight: 500 !important;
            padding: 5px 14px !important;
            box-shadow: 0 2px 4px rgba(141, 110, 99, 0.2) !important;
            transition: all 0.2s ease !important;
            opacity: 0.9;
        }
        .fc-button-primary:hover { 
            background-color: #795548 !important; 
            border-color: #795548 !important;
            transform: translateY(-1px);
            opacity: 1;
        }
        .fc-button-primary:not(:disabled).fc-button-active {
            background-color: #5D4037 !important; 
            border-color: #5D4037 !important;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2) !important;
        }
        .fc-button:focus { box-shadow: none !important; }

        /* æ–°å¢æŒ‰éˆ• */
        .btn-custom-add { 
            background-color: var(--primary-action); 
            color: #333; 
            border-radius: var(--border-radius); 
            padding: 10px 30px; 
            border: none; 
            box-shadow: 0 3px 10px rgba(79, 195, 247, 0.4); 
            transition: all 0.2s; 
            font-weight: 600;
            letter-spacing: 1px;
        }
        .btn-custom-add:hover { background-color: #29B6F6; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(79, 195, 247, 0.6); color: #333;}

        /* å›å ±æŒ‰éˆ• */
        .report-bug-container { position: fixed; bottom: 25px; right: 25px; z-index: 999; }
        .btn-report-bug {
            background-color: #90A4AE; 
            color: white;
            padding: 8px 20px;
            border-radius: 30px;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 0.95rem;
            font-weight: 600;
            display: flex; align-items: center; gap: 8px;
            transition: all 0.3s;
        }
        .btn-report-bug:hover { background-color: #78909C; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.2); }
        
        /* å„€è¡¨æ¿ */
        .dashboard-card { 
            background: #fff; 
            border: 1px solid var(--border-color); 
            border-radius: var(--border-radius); 
            padding: 20px; 
            height: 100%; 
            box-shadow: 0 4px 15px rgba(141, 110, 99, 0.05); 
        }
        .card-history { background-color: #FAFAFA; border-top: 5px solid #AED581; }
        .card-upcoming { background-color: #FAFAFA; border-top: 5px solid #FFD54F; }
        .dashboard-title { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid #EFEBE9; }
        
        .upcoming-list-container { max-height: 400px; overflow-y: auto; padding-right: 8px; }
        .upcoming-list-container::-webkit-scrollbar { width: 5px; }
        .upcoming-list-container::-webkit-scrollbar-thumb { background-color: #D7CCC8; border-radius: 10px; }
        
        .dashboard-btn { border: none; font-size: 0.9rem; box-shadow: 0 1px 3px rgba(141, 110, 99, 0.1); transition: 0.2s; position: relative; border-radius: 6px; }
        .dashboard-btn:hover { transform: translateY(-1px); opacity: 0.95; }
        
        .btn-act { width: 100%; text-align: left; padding: 8px 15px; margin-bottom: 8px; }
        .btn-person { display: inline-block; width: auto; padding: 6px 12px; margin-right: 6px; margin-bottom: 8px; border-radius: 15px; font-size: 0.85rem; font-weight: 500; }
        
        .section-label { font-size: 0.85rem; color: #A1887F; margin-top: 10px; margin-bottom: 5px; font-weight: 700; letter-spacing: 1px; border-left: 3px solid #D7CCC8; padding-left: 8px; }

        .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.2s; display: inline-block; }
        .color-swatch:hover { transform: scale(1.15); }
        .color-swatch.selected { border-color: #8D6E63; transform: scale(1.1); box-shadow: 0 0 0 2px #D7CCC8; }
        
        .modal-content { border-radius: 15px; border: none; box-shadow: 0 10px 40px rgba(141, 110, 99, 0.15); }
        .modal-header { background-color: #FFF8E1; border-radius: 15px 15px 0 0; border-bottom: 1px solid #FFE0B2; }
        .modal-title { color: #5D4037; font-weight: bold; letter-spacing: 1px; }
        .captcha-box { background: #FFF3E0; color: #5D4037; font-size: 24px; font-weight: bold; letter-spacing: 6px; text-align: center; padding: 8px; border-radius: var(--border-radius); user-select: none; border: 2px dashed #FFCC80; }
        .refresh-icon { cursor: pointer; color: #BCAAA4; transition: 0.3s; font-size: 1.2rem; margin-left: 15px; margin-top: 5px; }
        .refresh-icon:hover { color: #8D6E63; transform: rotate(180deg); }

        /* å·²å®Œæˆæ´»å‹•å€å¡Š */
        #completedSection { background-color: #F1F8E9; border: 1px solid #C5E1A5; border-radius: 12px; margin-bottom: 20px; }
        .completed-badge { color: #558B2F; font-weight: bold; font-size: 0.95rem; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .input-link { background-color: #fff !important; }
        
        /* ä¸Šæ–¹è¼¸å…¥å€ */
        #addLinkContainer { padding-bottom: 15px; border-bottom: 1px dashed #C5E1A5; margin-bottom: 10px; }
        
        /* ä¸‹æ–¹å·²å­˜é€£çµå€ */
        #savedLinksContainer h6 { color: #33691E; font-weight: bold; font-size: 0.9rem; margin-bottom: 10px; }
        .saved-link-item {
            background-color: #FFFFFF;
            border: 1px solid #AED581;
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        .saved-link-info { flex-grow: 1; overflow: hidden; }
        .saved-link-name { font-weight: bold; color: #558B2F; font-size: 0.9rem; display: block; }
        .saved-link-url { color: #0277BD; font-size: 0.85rem; text-decoration: none; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .saved-link-url:hover { text-decoration: underline; }
        .link-safety-badge { font-size: 0.75rem; margin-left: 5px; padding: 1px 5px; border-radius: 4px; vertical-align: middle; }
        .badge-safe { background-color: #E8F5E9; color: #2E7D32; border: 1px solid #A5D6A7; }
        .badge-unsafe { background-color: #FFEBEE; color: #C62828; border: 1px solid #EF9A9A; }

        /* å„²å­˜æŒ‰éˆ• (æµ®å‹•) */
        .btn-save-modal {
            background-color: var(--primary-action);
            color: #333;
            border: none;
            border-radius: 8px;
            box-shadow: 0 3px 8px rgba(79, 195, 247, 0.3);
            transition: all 0.2s;
            font-weight: 600;
        }
        .btn-save-modal:hover {
            background-color: #29B6F6;
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(79, 195, 247, 0.5);
            color: #333;
        }

        /* åˆªé™¤æŒ‰éˆ• (ç™½å­—) */
        .btn-delete-modal {
            border: 1px solid #ef9a9a;
            color: #d32f2f;
            background-color: transparent;
            border-radius: 8px;
            transition: all 0.2s;
            font-weight: 600;
        }
        .btn-delete-modal:hover {
            background-color: #ef9a9a;
            color: white !important; 
            box-shadow: 0 3px 8px rgba(239, 154, 154, 0.4);
            transform: translateY(-1px);
        }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fa-solid fa-calendar-days me-2" style="color: #A1887F;"></i>æ³°åœ‹ä½›å ‚_å…±ç”¨è¡Œäº‹æ›†</h2>
        <button class="btn btn-custom-add" onclick="openAddModal()">
            <i class="fa-solid fa-plus me-1"></i> æ–°å¢è³‡æ–™
        </button>
    </div>
    
    <div id="calendar" class="mb-5"></div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="dashboard-card card-history">
                <div class="dashboard-title"><i class="fa-solid fa-clock-rotate-left me-2 text-secondary"></i>æ­·å²ç´€éŒ„æŸ¥è©¢</div>
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label text-muted small">å¹´ä»½</label>
                        <select class="form-select form-select-sm" id="searchYear" onchange="filterHistoryResult()"><option value="">é¸æ“‡å¹´ä»½...</option></select>
                    </div>
                    <div class="col-6">
                        <label class="form-label text-muted small">é¡å‹</label>
                        <select class="form-select form-select-sm" id="searchType" onchange="filterHistoryResult()"><option value="all">å…¨éƒ¨</option><option value="activity">æ´»å‹•</option><option value="person">äººå“¡åƒèˆ‡</option></select>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted small">æœå°‹çµæœ</label>
                    <select class="form-select" id="searchResult"><option value="">è«‹å…ˆé¸æ“‡å¹´ä»½èˆ‡é¡å‹...</option></select>
                </div>
                <div class="d-grid">
                    <button class="btn btn-secondary btn-sm" onclick="jumpToSelectedEvent()" style="background-color: #8D6E63; border:none; border-radius: 8px;">å‰å¾€è©²æœˆä»½ <i class="fa-solid fa-arrow-right ms-1"></i></button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="dashboard-card card-upcoming">
                <div class="dashboard-title"><i class="fa-regular fa-calendar-plus me-2 text-secondary"></i>å³å°‡åˆ°ä¾†</div>
                <div class="upcoming-list-container" id="upcomingList"><div class="text-center text-muted py-4">è®€å–ä¸­...</div></div>
            </div>
        </div>
    </div>
</div>

<!-- å›å ±æŒ‰éˆ• -->
<div class="report-bug-container">
    <button class="btn-report-bug" onclick="openReportModal()">
        <i class="fa-solid fa-bug"></i> å›å ±å•é¡Œ
    </button>
</div>

<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">æ–°å¢è³‡æ–™</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="eventForm">
                    <input type="hidden" id="eventId">
                    <input type="hidden" id="selectedColor">

                    <!-- å·²å®Œæˆæ´»å‹•åˆ†äº«å€å¡Š -->
                    <div id="completedSection" class="p-3 mb-4" style="display: none;">
                        <div class="completed-badge"><i class="fa-solid fa-circle-check"></i> æ´»å‹•å·²å®Œæˆ - ç´€éŒ„åˆ†äº« <span id="linkCountBadge" class="ms-2 badge rounded-pill bg-secondary" style="font-size:0.7rem;">0/3</span></div>
                        
                        <!-- ä¸Šæ–¹ï¼šæ–°å¢/ä¿®æ”¹è¼¸å…¥å€ -->
                        <div id="addLinkContainer">
                            <label class="form-label small text-secondary mb-1 fw-bold"><i class="fa-solid fa-pen"></i> æ–°å¢é€£çµ</label>
                            <div class="input-group mb-1">
                                <input type="text" class="form-control input-link" id="linkName" placeholder="åç¨± (å¦‚: ç›¸ç°¿)">
                            </div>
                            <div class="input-group">
                                <input type="url" class="form-control input-link" id="linkUrl" placeholder="https://..." oninput="UIManager.checkUrlSafety(this.value)">
                                <button type="button" class="btn btn-sm btn-success" onclick="UIManager.addLinkToLocal()"><i class="fa-solid fa-plus"></i> åŠ å…¥</button>
                            </div>
                            <div id="urlSafetyFeedback" class="mt-1"></div>
                        </div>

                        <!-- ä¸‹æ–¹ï¼šå·²å­˜é€£çµåˆ—è¡¨ -->
                        <div id="savedLinksContainer" style="display:none;">
                            <h6>å·²å­˜é€£çµåˆ—è¡¨</h6>
                            <div id="savedLinksList">
                                <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-secondary small fw-bold">é¡å‹</label>
                        <select class="form-select" id="eventType" onchange="toggleFormFields()"><option value="activity">ğŸ‰ æ´»å‹•</option><option value="person">ğŸ‘¤ äººå“¡åƒèˆ‡</option></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-secondary small fw-bold" id="nameLabel">æ´»å‹•åç¨±</label>
                        <input type="text" class="form-control" id="eventTitle" placeholder="è«‹è¼¸å…¥å…§å®¹..." required>
                    </div>
                    <div class="row mb-3">
                        <label class="form-label text-secondary small fw-bold">é–‹å§‹</label>
                        <div class="col-7"><input type="date" class="form-control" id="startDate" required onchange="syncDates()"></div>
                        <div class="col-5 time-field-group"><select class="form-select" id="startTime" onchange="syncTimes()"></select></div>
                    </div>
                    <div class="row mb-3">
                        <label class="form-label text-secondary small fw-bold">çµæŸ</label>
                        <div class="col-7"><input type="date" class="form-control" id="endDate" required></div>
                        <div class="col-5 time-field-group"><select class="form-select" id="endTime"></select></div>
                    </div>

                    <div class="mb-3" id="colorSection">
                        <label class="form-label text-secondary small fw-bold">æ¨™ç±¤é¡è‰²</label>
                        <!-- data-color å±¬æ€§å·²ç¶å®šï¼Œç¢ºä¿é¸è‰²æ­£ç¢º -->
                        <div id="colorPalette" class="d-flex flex-wrap gap-2"></div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-secondary small fw-bold">é©—è­‰ç¢¼</label>
                        <div class="d-flex align-items-center">
                            <div id="captchaDisplay" class="captcha-box flex-grow-1"></div>
                            <i class="fa-solid fa-arrows-rotate refresh-icon" onclick="generateCaptcha()" title="æ›´æ›é©—è­‰ç¢¼"></i>
                        </div>
                        <input type="text" class="form-control mt-2" id="captchaInput" placeholder="è«‹è¼¸å…¥ä¸Šæ–¹æ•¸å­—" required>
                    </div>
                    <div class="d-grid gap-2">
                        <!-- å„²å­˜æŒ‰éˆ• -->
                        <button type="submit" class="btn btn-save-modal">å„²å­˜è³‡æ–™</button>
                        <!-- åˆªé™¤æŒ‰éˆ• -->
                        <button type="button" id="deleteBtn" class="btn btn-delete-modal" style="display:none;" onclick="confirmDelete()">åˆªé™¤æ­¤è³‡æ–™</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// ==========================================
// âš™ï¸ å…¨åŸŸè¨­å®š
// ==========================================
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwezycs59fxhwvksKUgWzByIj9a5bHRH2ByH0O7848HFxM7Ls2YjflGfqwx4okxROEE/exec';

const ACTIVITY_COLOR = '#F48FB1'; 

const PERSON_COLORS = [
    '#AED581', '#81D4FA', '#9FA8DA', '#E6EE9C', '#FFCC80', '#B0BEC5', 
    '#BCAAA4', '#80CBC4', '#CE93D8', '#FFF59D', '#90CAF9', '#CFD8DC'
];

// ==========================================
// â›” æ ¸å¿ƒé‚è¼¯å€ï¼šæ—¥æœŸé‹ç®— (Date Engine)
// ==========================================
const DateEngine = {
    getLocalDateString: function(isoStr) {
        if (!isoStr) return '';
        const date = new Date(isoStr);
        const offset = date.getTimezoneOffset() * 60000;
        const localDate = new Date(date.getTime() - offset);
        return localDate.toISOString().split('T')[0];
    },
    addDaysToDateString: function(dateStr, days) {
        const parts = dateStr.split('-');
        const y = parseInt(parts[0], 10);
        const m = parseInt(parts[1], 10) - 1;
        const d = parseInt(parts[2], 10);
        const tempDate = new Date(y, m, d);
        tempDate.setDate(tempDate.getDate() + days);
        const newY = tempDate.getFullYear();
        const newM = (tempDate.getMonth() + 1).toString().padStart(2, '0');
        const newD = tempDate.getDate().toString().padStart(2, '0');
        return `${newY}-${newM}-${newD}`;
    }
};

// ==========================================
// ğŸ“¦ è³‡æ–™ç®¡ç†å€
// ==========================================
const DataManager = {
    allEventsData: [], 

    fetchAndSplit: function(info, successCallback, failureCallback) {
        if (DataManager.allEventsData.length === 0) {
            Swal.fire({ title: 'è³‡æ–™åŒæ­¥ä¸­...', didOpen: () => { Swal.showLoading() }, toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
        }
        
        fetch(SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                if(data.result && data.result.startsWith("Error")) { return; }
                let explodedEvents = [];
                DataManager.allEventsData = []; 

                data.forEach(item => {
                    const type = item.type || (item.extendedProps && item.extendedProps.type) || 'person';
                    const isActivity = (type === 'activity');
                    const originalStartTimestamp = new Date(item.start).getTime();
                    const itemOrder = isActivity ? -1 : 10;

                    DataManager.allEventsData.push({
                        id: item.id, title: item.title, start: item.start, end: item.end,
                        backgroundColor: item.backgroundColor, textColor: item.textColor,
                        extendedProps: { 
                            type: type, 
                            order: itemOrder,
                            linkName: item.linkName || '',
                            linkUrl: item.linkUrl || ''
                        }, 
                        order: itemOrder, type: type
                    });

                    if (item.start) {
                        const startDateStr = DateEngine.getLocalDateString(item.start);
                        let endDateStr = item.end ? DateEngine.getLocalDateString(item.end) : startDateStr;

                        if (isActivity) {
                            endDateStr = DateEngine.addDaysToDateString(endDateStr, 1);
                        }

                        let currentStr = startDateStr;
                        while (currentStr < endDateStr) {
                            const classList = ['hide-time-text'];
                            if (isActivity) classList.push('event-type-activity');
                            else classList.push('person-pill');

                            explodedEvents.push({
                                id: item.id, title: item.title, start: currentStr, end: currentStr, allDay: true,
                                backgroundColor: item.backgroundColor, textColor: item.textColor,
                                extendedProps: { type: type, order: itemOrder },
                                originalStart: originalStartTimestamp, 
                                order: itemOrder,
                                classNames: classList
                            });
                            currentStr = DateEngine.addDaysToDateString(currentStr, 1);
                        }
                    }
                });

                UIManager.renderDashboard();
                successCallback(explodedEvents); 
                Swal.close();
            })
            .catch(err => { failureCallback(err); });
    },

    save: function(data, action) {
        Swal.fire({title:'å„²å­˜ä¸­...',didOpen:()=>{Swal.showLoading()}});
        fetch(SCRIPT_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain'}, body:JSON.stringify({action:action,...data}) })
        .then(()=>{ setTimeout(()=>{ 
            Swal.fire({icon:'success',title:'å®Œæˆ',timer:1500,showConfirmButton:false}); 
            calendar.refetchEvents(); 
            bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide(); 
        },2000); })
        .catch(()=>{ Swal.fire('é€£ç·šç•°å¸¸','è«‹æª¢æŸ¥ç¶²è·¯','error'); });
    },

    delete: function(id) {
        Swal.fire({title:'åˆªé™¤ä¸­...',didOpen:()=>{Swal.showLoading()}});
        fetch(SCRIPT_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain'}, body:JSON.stringify({action:'delete',id:id}) })
        .then(()=>{ setTimeout(()=>{ 
            Swal.fire('å·²åˆªé™¤','','success'); 
            calendar.refetchEvents(); 
            bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide(); 
        },2000); });
    },

    sendReport: function(content) {
        Swal.fire({title:'å‚³é€ä¸­...',didOpen:()=>{Swal.showLoading()}});
        fetch(SCRIPT_URL, { 
            method:'POST', 
            mode:'no-cors', 
            headers:{'Content-Type':'text/plain'}, 
            body:JSON.stringify({ action: 'send_report', content: content }) 
        })
        .then(() => {
            Swal.fire('å·²å›å ±', 'æ„Ÿè¬æ‚¨çš„å›é¥‹ï¼Œæˆ‘å€‘æœƒç›¡å¿«è™•ç†ï¼', 'success');
        })
        .catch(() => {
            Swal.fire('å¤±æ•—', 'ç„¡æ³•å‚³é€å›å ±ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        });
    }
};

// ==========================================
// ğŸ¨ ä»‹é¢ç®¡ç†å€ (UI Manager)
// ==========================================
const UIManager = {
    currentCaptcha: "",
    currentReportCaptcha: "", 
    isEditingPastActivity: false, 
    currentLinks: [], 

    renderDashboard: function() {
        this.renderUpcoming();
        this.initHistorySearch();
    },

    renderUpcoming: function() {
        const listContainer = document.getElementById('upcomingList');
        const todayStr = DateEngine.getLocalDateString(new Date().toISOString());
        
        const upcomingEvents = DataManager.allEventsData.filter(e => DateEngine.getLocalDateString(e.start) >= todayStr);
        if (upcomingEvents.length === 0) { listContainer.innerHTML = '<div class="text-center text-muted py-4 small">è¿‘æœŸç„¡æ´»å‹•</div>'; return; }
        
        const activities = upcomingEvents.filter(e => (e.extendedProps?.type || e.type) === 'activity').sort((a,b)=>new Date(a.start)-new Date(b.start));
        const people = upcomingEvents.filter(e => (e.extendedProps?.type || e.type) !== 'activity').sort((a,b)=>new Date(a.start)-new Date(b.start));
        
        let html = '';
        if (activities.length > 0) {
            html += `<div class="section-label">è¿‘æœŸæ´»å‹•</div>`;
            activities.forEach(e => {
                const datePart = DateEngine.getLocalDateString(e.start);
                const timePart = e.start.substring(11, 16);
                html += `<button class="btn dashboard-btn btn-act" style="background:${e.backgroundColor};color:#333;" onclick="jumpToDate('${e.start}')"><div class="d-flex justify-content-between"><strong>${e.title}</strong><small>${datePart} ${timePart}</small></div></button>`;
            });
        }
        if (people.length > 0) {
            html += `<div class="section-label">è¿‘æœŸåƒèˆ‡äººå“¡</div><div class="d-block">`;
            people.forEach(e => {
                const datePart = DateEngine.getLocalDateString(e.start);
                html += `<button class="btn dashboard-btn btn-person" style="background:${e.backgroundColor};color:#333;" onclick="jumpToDate('${e.start}')">${datePart} ${e.title}</button>`;
            });
            html += `</div>`;
        }
        listContainer.innerHTML = html;
    },

    initHistorySearch: function() {
        const years = new Set(DataManager.allEventsData.map(e => DateEngine.getLocalDateString(e.start).substring(0, 4)));
        const sorted = Array.from(years).sort((a,b)=>b-a);
        const sel = document.getElementById('searchYear');
        sel.innerHTML = '<option value="">é¸æ“‡å¹´ä»½...</option>';
        sorted.forEach(y => sel.innerHTML += `<option value="${y}">${y}å¹´</option>`);
    },

    filterHistoryResult: function() {
        const yVal = document.getElementById('searchYear').value;
        const tVal = document.getElementById('searchType').value;
        const resSel = document.getElementById('searchResult');
        resSel.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
        if(!yVal) return;
        
        const todayStr = DateEngine.getLocalDateString(new Date().toISOString());
        
        const filtered = DataManager.allEventsData.filter(e => {
            const dateStr = DateEngine.getLocalDateString(e.start);
            const y = dateStr.substring(0, 4);
            const type = e.extendedProps?.type || e.type || 'person';
            return y === yVal && (tVal==='all' || type===tVal) && (dateStr < todayStr);
        }).sort((a,b)=>new Date(a.start)-new Date(b.start));
        
        if(filtered.length===0) { resSel.innerHTML='<option value="">æŸ¥ç„¡è³‡æ–™</option>'; return; }
        filtered.forEach(e => {
            const datePart = DateEngine.getLocalDateString(e.start);
            resSel.innerHTML += `<option value="${e.start}">${datePart} - ${e.title}</option>`;
        });
    },

    populateTimeSelects: function() {
        const s = document.getElementById('startTime'), e = document.getElementById('endTime');
        let opt=''; for(let h=0;h<24;h++) for(let m=0;m<60;m+=15) { 
            let t = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; 
            opt+=`<option value="${t}">${t}</option>`; 
        }
        s.innerHTML=opt; e.innerHTML=opt;
    },

    renderColorPalette: function() {
        const palette = document.getElementById('colorPalette');
        let html = '';
        PERSON_COLORS.forEach((color, index) => {
            const selectedClass = index === 0 ? 'selected' : '';
            html += `<div class="color-swatch ${selectedClass}" style="background-color: ${color};" data-color="${color}" onclick="selectColor(this, '${color}')"></div>`;
        });
        palette.innerHTML = html;
        document.getElementById('selectedColor').value = PERSON_COLORS[0];
    },

    selectSwatchByColor: function(color) {
        document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('selected'));
        if (!color) return;
        const swatch = document.querySelector(`.color-swatch[data-color="${color}"]`);
        if (swatch) {
            swatch.classList.add('selected');
            document.getElementById('selectedColor').value = color;
        } else {
            const firstSwatch = document.querySelector('.color-swatch');
            if (firstSwatch) {
                firstSwatch.classList.add('selected');
                document.getElementById('selectedColor').value = firstSwatch.getAttribute('data-color');
            }
        }
    },

    toggleFormFields: function() {
        const type = document.getElementById('eventType').value;
        document.getElementById('nameLabel').innerText = type==='activity'?'æ´»å‹•åç¨±':'åƒèˆ‡äººå§“å';
        document.querySelectorAll('.time-field-group').forEach(el => el.style.display = type==='activity'?'block':'none');
        
        const colorSection = document.getElementById('colorSection');
        if (type === 'activity') {
            colorSection.style.display = 'none';
            document.getElementById('selectedColor').value = ACTIVITY_COLOR;
            
            // ã€ä¿®æ­£ã€‘é‚è¼¯åˆ¤æ–·ï¼šåªåœ¨ (1) ç·¨è¼¯æ¨¡å¼ (2) æ˜¯æ´»å‹• (3) æ—¥æœŸå·²éæ™‚ é¡¯ç¤ºé€£çµå€
            const completedSection = document.getElementById('completedSection');
            if (this.isEditingPastActivity) {
                completedSection.style.display = 'block';
                this.renderLinkList();
            } else {
                completedSection.style.display = 'none';
            }
        } else {
            colorSection.style.display = 'block';
            const lastColor = localStorage.getItem('lastPersonColor');
            const defaultColor = (lastColor && PERSON_COLORS.includes(lastColor)) ? lastColor : PERSON_COLORS[0];
            
            // æ–°å¢æ¨¡å¼ä¸‹ï¼Œç›´æ¥èª¿ç”¨ selectSwatchByColor
            this.selectSwatchByColor(defaultColor);
            
            document.getElementById('completedSection').style.display = 'none';
        }
    },
    
    addLinkToLocal: function() {
        if (this.currentLinks.length >= 3) {
            Swal.fire('æ•¸é‡é™åˆ¶', 'æœ€å¤šåªèƒ½æ–°å¢ 3 å€‹é€£çµ', 'warning');
            return;
        }
        const name = document.getElementById('linkName').value.trim();
        const url = document.getElementById('linkUrl').value.trim();
        
        if (!name || !url) { Swal.fire('è«‹è¼¸å…¥è³‡æ–™', 'åç¨±èˆ‡ç¶²å€çš†ç‚ºå¿…å¡«', 'warning'); return; }
        
        this.currentLinks.push({ name: name, url: url });
        this.renderLinkList();
        document.getElementById('linkName').value = '';
        document.getElementById('linkUrl').value = '';
        document.getElementById('urlSafetyFeedback').innerHTML = '';
    },

    renderLinkList: function() {
        const container = document.getElementById('savedLinksContainer');
        const list = document.getElementById('savedLinksList');
        const badge = document.getElementById('linkCountBadge');
        list.innerHTML = '';
        
        badge.innerText = `${this.currentLinks.length}/3`;

        if (this.currentLinks.length === 0) {
            container.style.display = 'none';
            return;
        }
        container.style.display = 'block';

        this.currentLinks.forEach((link, index) => {
            let badgeHtml = '';
            try {
                const u = new URL(link.url);
                if (u.protocol === 'https:') badgeHtml = '<span class="link-safety-badge badge-safe"><i class="fa-solid fa-lock"></i> å®‰å…¨</span>';
                else badgeHtml = '<span class="link-safety-badge badge-unsafe"><i class="fa-solid fa-unlock"></i> ä¸å®‰å…¨</span>';
            } catch(e) { badgeHtml = '<span class="link-safety-badge badge-unsafe">æ ¼å¼éŒ¯èª¤</span>'; }

            const html = `
                <div class="saved-link-item">
                    <div class="saved-link-info">
                        <span class="saved-link-name">${link.name}</span>
                        <div>
                            <a href="${link.url}" target="_blank" class="saved-link-url">${link.url}</a>
                            ${badgeHtml}
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger border-0 ms-2" onclick="UIManager.openDeleteLinkCaptchaModal(${index})">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            `;
            list.insertAdjacentHTML('beforeend', html);
        });
    },

    openDeleteLinkCaptchaModal: function(index) {
        this.refreshReportCaptcha();
        Swal.fire({
            title: 'åˆªé™¤é€£çµç¢ºèª',
            html: `
                <p class="text-secondary mb-2">è«‹è¼¸å…¥é©—è­‰ç¢¼ä»¥åˆªé™¤æ­¤é€£çµ</p>
                <div class="d-flex align-items-center mb-2">
                    <div id="reportCaptchaDisplay" class="captcha-box flex-grow-1">${this.currentReportCaptcha}</div>
                    <i class="fa-solid fa-arrows-rotate refresh-icon" onclick="UIManager.refreshReportCaptcha()"></i>
                </div>
                <input type="text" id="deleteLinkCaptchaInput" class="form-control" placeholder="è«‹è¼¸å…¥ä¸Šæ–¹é©—è­‰ç¢¼">
            `,
            showCancelButton: true,
            confirmButtonText: 'ç¢ºèªåˆªé™¤',
            confirmButtonColor: '#d32f2f',
            cancelButtonText: 'å–æ¶ˆ',
            preConfirm: () => {
                const input = document.getElementById('deleteLinkCaptchaInput').value;
                if (input !== this.currentReportCaptcha) {
                    Swal.showValidationMessage('é©—è­‰ç¢¼éŒ¯èª¤');
                    return false;
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                this.currentLinks.splice(index, 1);
                this.renderLinkList();
            }
        });
    },

    openAddModal: function() {
        document.getElementById('eventForm').reset();
        document.getElementById('eventId').value = '';
        document.getElementById('modalTitle').innerText = 'æ–°å¢è³‡æ–™';
        document.getElementById('deleteBtn').style.display = 'none';
        
        this.isEditingPastActivity = false;
        this.currentLinks = []; 
        document.getElementById('completedSection').style.display = 'none'; 
        document.getElementById('urlSafetyFeedback').innerHTML = '';
        
        const currentDate = calendar.getDate(); 
        const today = new Date();
        let targetDate = currentDate;
        if (currentDate.getMonth() === today.getMonth() && currentDate.getFullYear() === today.getFullYear()) {
            targetDate = today;
        }
        const dStr = DateEngine.getLocalDateString(targetDate.toISOString());
        
        document.getElementById('startDate').value = dStr; document.getElementById('endDate').value = dStr;
        const r = 15-(new Date().getMinutes()%15); 
        const now = new Date(); now.setMinutes(now.getMinutes()+r);
        const t = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        document.getElementById('startTime').value = t; document.getElementById('endTime').value = t;
        
        this.generateCaptcha(); 
        // é‡ç½®ç‚ºç©ºï¼Œç¢ºä¿ toggleFormFields æœƒå»æŠ“ localStorage
        document.getElementById('selectedColor').value = ''; 
        this.toggleFormFields();
        new bootstrap.Modal(document.getElementById('eventModal')).show();
    },

    openEditModal: function(e) {
        document.getElementById('eventId').value = e.id;
        document.getElementById('modalTitle').innerText = 'ç·¨è¼¯è³‡æ–™';
        document.getElementById('deleteBtn').style.display = 'block';
        
        const type = e.extendedProps?.type || 'person';
        document.getElementById('eventType').value = type;
        document.getElementById('eventTitle').value = e.title;

        const originalEvent = DataManager.allEventsData.find(evt => evt.id === e.id) || e; 
        const props = originalEvent.extendedProps || {};

        const todayStr = DateEngine.getLocalDateString(new Date().toISOString());
        
        // ã€é—œéµä¿®æ­£ã€‘ç²¾æº–åˆ¤æ–·æ˜¯å¦ç‚ºã€Œéå»æ´»å‹•ã€
        this.isEditingPastActivity = false;
        if (originalEvent.start && type === 'activity') {
            // å–å¾—çµæŸæ—¥ (è‹¥ç„¡å‰‡ç”¨é–‹å§‹æ—¥)
            const evtEndStr = originalEvent.end ? DateEngine.getLocalDateString(originalEvent.end) : DateEngine.getLocalDateString(originalEvent.start);
            
            // å› ç‚º FullCalendar çš„ end æ˜¯ exclusive (+1å¤©)ï¼Œæ‰€ä»¥æˆ‘å€‘æ¯”è¼ƒæ™‚è¦å°å¿ƒ
            // ä½†æˆ‘å€‘å­˜æª”é‚è¼¯æ˜¯ end = userEnd + 1
            // æ‰€ä»¥å¦‚æœ evtEndStr <= todayStrï¼Œä»£è¡¨æ´»å‹•çœŸçš„çµæŸäº†
            // ä¾‹å¦‚ï¼šæ´»å‹• 1è™Ÿ~1è™Ÿï¼Œå­˜ 1~2ã€‚ä»Šå¤©3è™Ÿã€‚evtEndStr(2) < 3ã€‚æˆç«‹ã€‚
            
            if (evtEndStr <= todayStr) {
                this.isEditingPastActivity = true;
            }
        }

        // è§£æé€£çµ (JSONå­—ä¸² -> é™£åˆ—)
        try {
            this.currentLinks = JSON.parse(props.linkUrl || '[]');
        } catch(err) {
            if (props.linkUrl && !props.linkUrl.startsWith('[')) {
                this.currentLinks = [{name: props.linkName || 'é€£çµ', url: props.linkUrl}];
            } else {
                this.currentLinks = [];
            }
        }
        
        document.getElementById('linkName').value = '';
        document.getElementById('linkUrl').value = '';
        document.getElementById('urlSafetyFeedback').innerHTML = '';

        // å…ˆè¨­å®šç‹€æ…‹ï¼Œå†æ›´æ–° UI
        this.toggleFormFields();

        // ã€ä¿®æ­£ã€‘é‚„åŸé¡è‰² (å¿…é ˆåœ¨ toggle ä¹‹å¾Œ)
        const bgColor = originalEvent.backgroundColor;
        if (type !== 'activity' && bgColor) {
             this.selectSwatchByColor(bgColor);
        }

        if(originalEvent.start) {
            const sStr = DateEngine.getLocalDateString(originalEvent.start);
            document.getElementById('startDate').value = sStr;

            if (type === 'person') {
                 const eStrRaw = originalEvent.end ? DateEngine.getLocalDateString(originalEvent.end) : sStr;
                 const correctEndStr = DateEngine.addDaysToDateString(eStrRaw, -1);
                 document.getElementById('endDate').value = correctEndStr;
            } else {
                 const startT = originalEvent.start.substring(11, 16);
                 document.getElementById('startTime').value = startT;
                 if(originalEvent.end) {
                     const endDStr = DateEngine.getLocalDateString(originalEvent.end);
                     const endT = originalEvent.end.substring(11, 16);
                     document.getElementById('endDate').value = endDStr;
                     document.getElementById('endTime').value = endT;
                 }
            }
        }
        this.generateCaptcha(); 
        new bootstrap.Modal(document.getElementById('eventModal')).show();
    },

    jumpToDate: function(str) {
        calendar.changeView('dayGridMonth', str);
        document.getElementById('calendar').scrollIntoView({behavior:'smooth'});
        
        const targetDateStr = DateEngine.getLocalDateString(str);

        setTimeout(() => {
            document.querySelectorAll('.highlight-target-day').forEach(el => el.classList.remove('highlight-target-day'));
            const targetEl = document.querySelector(`.fc-daygrid-day[data-date="${targetDateStr}"]`);
            if (targetEl) {
                targetEl.classList.add('highlight-target-day');
                targetEl.scrollIntoView({behavior: "smooth", block: "center", inline: "center"});
            }
        }, 200);
    },

    checkUrlSafety: function(url) {
        const feedback = document.getElementById('urlSafetyFeedback');
        if (!url) { feedback.innerHTML = ''; return; }
        try {
            const urlObj = new URL(url);
            if (urlObj.protocol === 'https:') {
                 feedback.innerHTML = '<span class="text-success small fw-bold"><i class="fa-solid fa-circle-check me-1"></i>é€£çµæ ¼å¼å®‰å…¨ (HTTPS)</span>';
            } else {
                 feedback.innerHTML = '<span class="text-warning small fw-bold"><i class="fa-solid fa-triangle-exclamation me-1"></i>éåŠ å¯† (HTTP) æˆ–æ ¼å¼æœ‰èª¤ï¼Œè«‹æª¢æŸ¥</span>';
            }
        } catch (e) {
             feedback.innerHTML = '<span class="text-danger small fw-bold"><i class="fa-solid fa-xmark me-1"></i>ç¶²å€æ ¼å¼éŒ¯èª¤</span>';
        }
    },

    openReportModal: function() {
        this.refreshReportCaptcha(); 
        Swal.fire({
            title: 'å›å ±å•é¡Œ',
            html: `
                <textarea id="reportText" class="form-control mb-3" rows="4" placeholder="è«‹æè¿°æ‚¨é‡åˆ°çš„éŒ¯èª¤æˆ–å»ºè­°..."></textarea>
                <div class="d-flex align-items-center mb-2">
                    <div id="reportCaptchaDisplay" class="captcha-box flex-grow-1">${this.currentReportCaptcha}</div>
                    <i class="fa-solid fa-arrows-rotate refresh-icon" onclick="UIManager.refreshReportCaptcha()"></i>
                </div>
                <input type="text" id="reportCaptchaInput" class="form-control" placeholder="è«‹è¼¸å…¥ä¸Šæ–¹é©—è­‰ç¢¼">
            `,
            showCancelButton: true,
            confirmButtonText: 'é€å‡ºå›å ±',
            confirmButtonColor: '#90A4AE',
            cancelButtonText: 'å–æ¶ˆ',
            preConfirm: () => {
                const content = document.getElementById('reportText').value;
                const inputCaptcha = document.getElementById('reportCaptchaInput').value;
                if (!content) { Swal.showValidationMessage('è«‹è¼¸å…¥å›å ±å…§å®¹'); return false; }
                if (inputCaptcha !== this.currentReportCaptcha) { Swal.showValidationMessage('é©—è­‰ç¢¼éŒ¯èª¤'); return false; }
                return content;
            }
        }).then((result) => {
            if (result.isConfirmed) DataManager.sendReport(result.value);
        });
    },

    refreshReportCaptcha: function() {
        this.currentReportCaptcha = Math.floor(1000 + Math.random()*9000).toString();
        const display = document.getElementById('reportCaptchaDisplay');
        if (display) display.innerText = this.currentReportCaptcha;
    },

    generateCaptcha: function() {
        this.currentCaptcha = Math.floor(1000 + Math.random()*9000).toString();
        document.getElementById('captchaDisplay').innerText = this.currentCaptcha;
        document.getElementById('captchaInput').value = '';
    }
};

// ==========================================
// ğŸš€ æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•å€
// ==========================================
let calendar; 

document.addEventListener('DOMContentLoaded', function() {
    UIManager.populateTimeSelects(); 
    UIManager.renderColorPalette(); 

    var calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'zh-tw',
        headerToolbar: { left: 'myToday', center: 'prev,title,next', right: 'dayGridMonth,timeGridWeek,listWeek' },
        buttonText: { month: 'æœˆ', week: 'é€±', list: 'åˆ—è¡¨' },
        
        customButtons: {
            myToday: {
                text: 'ä»Šå¤©',
                click: function() {
                    calendar.today();
                    const todayStr = DateEngine.getLocalDateString(new Date().toISOString());
                    UIManager.jumpToDate(todayStr);
                }
            }
        },
        
        eventDisplay: 'block',
        contentHeight: 'auto', 
        dayMaxEvents: 4, 
        fixedWeekCount: false,      
        
        eventOrder: 'order,originalStart,title', 
        
        navLinks: true,
        navLinkDayClick: function(date, jsEvent) { 
            UIManager.jumpToDate(date); 
        },
        
        events: DataManager.fetchAndSplit, 

        eventClick: function(info) {
            if (info.view.type === 'listWeek' || info.view.type === 'list') {
                UIManager.jumpToDate(info.event.start);
            } else {
                UIManager.openEditModal(info.event);
            }
        },
        eventTimeFormat: { hour: '2-digit', minute: '2-digit', meridiem: false, hour12: false }
    });
    calendar.render();
});

// å…¨åŸŸç¶å®š
function filterHistoryResult() { UIManager.filterHistoryResult(); }
function jumpToSelectedEvent() { 
    const val = document.getElementById('searchResult').value;
    if(val) {
        UIManager.jumpToDate(val); 
    } else {
        Swal.fire({icon:'info',title:'æç¤º',text:'è«‹å…ˆé¸æ“‡ä¸€å€‹æœå°‹çµæœ'});
    }
}
function jumpToDate(str) {
    UIManager.jumpToDate(str); 
}
function toggleFormFields() { UIManager.toggleFormFields(); }
function syncDates() {
    const s = document.getElementById('startDate'), e = document.getElementById('endDate');
    if(!e.value || e.value < s.value) e.value = s.value;
}
function syncTimes() {
    const s = document.getElementById('startTime'), e = document.getElementById('endTime');
    const sDate = document.getElementById('startDate').value;
    const eDate = document.getElementById('endDate').value;
    
    if (sDate === eDate) {
        if(e.value < s.value) e.value = s.value;
    }
}
function selectColor(el, color) { selectColor.call(this, el, color); } 
window.selectColor = function(element, color) {
    UIManager.selectSwatchByColor(color);
}

function openAddModal() { UIManager.openAddModal(); }
function openReportModal() { UIManager.openReportModal(); }
function generateCaptcha() { UIManager.generateCaptcha(); }
function confirmDelete() {
    if (document.getElementById('captchaInput').value !== UIManager.currentCaptcha) { Swal.fire({icon:'error',title:'é©—è­‰ç¢¼éŒ¯èª¤'}); return; }
    Swal.fire({title:'ç¢ºå®šåˆªé™¤ï¼Ÿ',icon:'warning',showCancelButton:true,confirmButtonColor:'#ef9a9a',confirmButtonText:'åˆªé™¤'})
    .then((r)=>{ if(r.isConfirmed) DataManager.delete(document.getElementById('eventId').value); });
}

document.getElementById('eventForm').addEventListener('submit', function(e) {
    e.preventDefault();
    if (document.getElementById('captchaInput').value !== UIManager.currentCaptcha) {
        Swal.fire({ icon: 'error', title: 'é©—è­‰ç¢¼éŒ¯èª¤' }); return;
    }
    
    // è‡ªå‹•åŠ å…¥é€£çµé˜²å‘†
    const pendingName = document.getElementById('linkName').value.trim();
    const pendingUrl = document.getElementById('linkUrl').value.trim();
    if (pendingName && pendingUrl && UIManager.currentLinks.length < 3) {
        UIManager.addLinkToLocal();
    }

    const id = document.getElementById('eventId').value;
    const type = document.getElementById('eventType').value;
    const sDate = document.getElementById('startDate').value; 
    const eDate = document.getElementById('endDate').value;   
    const linkJson = JSON.stringify(UIManager.currentLinks);
    
    let startStr, endStr;
    if (type === 'activity') {
        startStr = `${sDate}T${document.getElementById('startTime').value}`;
        endStr = `${eDate}T${document.getElementById('endTime').value}`;
    } else {
        startStr = sDate;
        endStr = DateEngine.addDaysToDateString(eDate, 1);
    }
    
    let selectedColor = (type === 'activity') ? ACTIVITY_COLOR : document.getElementById('selectedColor').value;
    let textColor = '#333333';

    if (type !== 'activity') {
        localStorage.setItem('lastPersonColor', selectedColor);
    }

    const eventData = {
        id: id || ('evt_' + Date.now()),
        title: document.getElementById('eventTitle').value,
        type: type, start: startStr, end: endStr,
        backgroundColor: selectedColor, textColor: textColor,
        order: type==='activity'?-1:10,
        linkName: 'MultiLinks', 
        linkUrl: linkJson       
    };
    DataManager.save(eventData, id?'update':'create');
});
</script>
</body>
</html>