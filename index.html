<!-- ç‰ˆæœ¬ç·¨è™Ÿ: v1.2 (åŸºæ–¼ç©©å®šç‰ˆ v1.0 ä¿®å¾©ï¼šé˜²å´©æ½°ã€RWDå„ªåŒ–ã€é€£çµç®¡ç†ã€æ¨£å¼é‚„åŸ) -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- RWD é—œéµè¨­å®š -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³°åœ‹ä½›å ‚_å…±ç”¨è¡Œäº‹æ›†</title>
    
    <!-- æ ¸å¿ƒå¥—ä»¶ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/zh-tw.js"></script>

    <style>
        /* =========================================
           ğŸµ æº«æ½¤æ—¥ç³»é¢¨æ ¼ (Warm & Cozy Style)
           ========================================= */
        
        :root {
            --bg-color: #FDFCF5;       
            --card-bg: #FFFFFF;        
            --text-primary: #5D4037;   
            --text-secondary: #8D6E63; 
            --border-color: #EFEBE9;   
            --accent-color: #8D6E63;   
            --primary-action: #a3daff; 
            --border-radius: 10px;     
        }

        body { 
            background-color: var(--bg-color);
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; 
            color: var(--text-primary);
        }
        
        .container { max-width: 1200px; margin-top: 40px; margin-bottom: 80px; }
        
        h2 { 
            font-weight: 700; 
            color: var(--text-primary); 
            letter-spacing: 1.5px; 
            font-size: 1.8rem;
            border-bottom: 3px solid #D7CCC8;
            display: inline-block;
            padding-bottom: 5px;
        }
        
        #calendar { 
            background: var(--card-bg);
            padding: 25px; 
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(141, 110, 99, 0.08);
            border: 1px solid var(--border-color);
        }

        /* --- RWD éŸ¿æ‡‰å¼é«˜åº¦æ§åˆ¶ --- */
        /* é›»è…¦ç‰ˆï¼šå›ºå®šé«˜åº¦ 150px (5è¡Œ) */
        @media (min-width: 768px) {
            .fc-daygrid-day-frame {
                height: 150px !important; 
                min-height: 150px !important;
                max-height: 150px !important;
                overflow: hidden;
            }
        }
        /* æ‰‹æ©Ÿç‰ˆï¼šè‡ªå‹•é«˜åº¦ï¼Œæ¨™é¡Œæ›è¡Œ */
        @media (max-width: 767.98px) {
            .fc-daygrid-day-frame {
                height: auto !important; 
                min-height: 80px !important;
            }
            .fc-header-toolbar { flex-direction: column; gap: 10px; }
            .modal-dialog { margin: 10px auto !important; max-width: 95% !important; }
            
            /* æ‰‹æ©Ÿç‰ˆå­—é«”å¾®ç¸® */
            .fc-event { font-size: 0.75rem !important; }
        }

        /* å£“ç¸®æ—¥æœŸæ¬„ä½ & ç§»é™¤åº•ç·š */
        .fc-daygrid-day-top { flex-direction: row; padding: 1px 4px !important; height: 24px !important; min-height: 24px !important; }
        .fc-daygrid-day-number { font-size: 0.9rem; line-height: 1; margin: 0 !important; text-decoration: none !important; color: var(--text-secondary); }
        a.fc-col-header-cell-cushion { text-decoration: none !important; color: var(--text-primary); }
        a:hover { text-decoration: none !important; }

        /* æœå°‹è·³è½‰çš„é«˜äº®å‹•ç•« */
        @keyframes flash-highlight {
            0% { background-color: rgba(255, 235, 59, 0.8); box-shadow: inset 0 0 20px rgba(255, 215, 0, 0.6); }
            100% { background-color: transparent; box-shadow: none; }
        }
        .highlight-target-day { animation: flash-highlight 2.5s ease-out; position: relative; z-index: 10; }
        
        /* --- äº‹ä»¶æ¨£å¼ --- */
        .fc-event { 
            cursor: pointer; border: none !important; 
            box-shadow: 0 1px 1px rgba(93, 64, 55, 0.1); 
            font-size: 0.8rem; margin-bottom: 1px !important; border-radius: 4px !important; 
            padding: 1px 6px !important; line-height: 1.3 !important;   
        }
        .fc-event:hover { transform: translateY(-1px); filter: brightness(0.95); z-index: 5; }
        
        /* äººå“¡æ¨£å¼ (è† å›Š) */
        .person-pill { 
            display: inline-block !important; width: auto !important; 
            margin-right: 4px !important; white-space: nowrap; 
            font-weight: 500; color: #5D4037 !important;
        }
        
        /* æ´»å‹•æ¨£å¼ (ç½®é ‚æ»¿ç‰ˆ) */
        .event-type-activity { 
            background-color: #F8BBD0; border-left: 4px solid #EC407A !important; 
            color: #5D4037 !important; font-weight: bold; width: 100% !important; 
            display: block !important; margin-bottom: 2px !important; 
        }
        
        .hide-time-text .fc-event-time { display: none !important; }
        .fc-daygrid-day-events { margin-top: 0 !important; padding: 0 2px !important; display: flex; flex-wrap: wrap; gap: 1px; }
        .fc-daygrid-event-harness { width: auto !important; max-width: 100%; }
        .fc-daygrid-event-harness:has(.event-type-activity) { width: 100% !important; flex-basis: 100% !important; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .fc-button-primary {
            background-color: var(--accent-color) !important; border-color: var(--accent-color) !important;
            color: #FFFFFF !important; border-radius: 8px !important; font-weight: 500 !important;
        }
        .btn-custom-add { 
            background-color: var(--primary-action); color: #333; 
            border-radius: var(--border-radius); padding: 10px 30px; border: none; font-weight: 600;
            box-shadow: 0 3px 10px rgba(163, 218, 255, 0.4); 
        }
        .btn-custom-add:hover { background-color: #81D4FA; transform: translateY(-2px); }

        /* å›å ±æŒ‰éˆ• */
        .report-bug-container { position: fixed; bottom: 25px; right: 25px; z-index: 999; }
        .btn-report-bug {
            background-color: #90A4AE; color: white; padding: 8px 20px; border-radius: 30px; border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 0.95rem; font-weight: 600;
            display: flex; align-items: center; gap: 8px; transition: all 0.3s;
        }
        .btn-report-bug:hover { background-color: #78909C; transform: translateY(-2px); }

        /* å„€è¡¨æ¿ */
        .dashboard-card { background: #fff; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 20px; height: 100%; box-shadow: 0 4px 15px rgba(141, 110, 99, 0.05); }
        .card-history { background-color: #FAFAFA; border-top: 5px solid #AED581; }
        .card-upcoming { background-color: #FAFAFA; border-top: 5px solid #FFD54F; }
        .dashboard-title { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid #EFEBE9; }
        
        .upcoming-list-container { max-height: 400px; overflow-y: auto; padding-right: 8px; }
        .upcoming-list-container::-webkit-scrollbar { width: 5px; }
        .upcoming-list-container::-webkit-scrollbar-thumb { background-color: #D7CCC8; border-radius: 10px; }

        .dashboard-btn { border: none; font-size: 0.9rem; box-shadow: 0 1px 3px rgba(141, 110, 99, 0.1); transition: 0.2s; position: relative; border-radius: 6px; }
        .dashboard-btn:hover { transform: translateY(-1px); opacity: 0.95; }
        .btn-act { width: 100%; text-align: left; padding: 8px 15px; margin-bottom: 8px; }
        .btn-person { display: inline-block; width: auto; padding: 6px 12px; margin-right: 6px; margin-bottom: 8px; border-radius: 15px; font-size: 0.85rem; font-weight: 500; }
        .section-label { font-size: 0.85rem; color: #A1887F; margin-top: 10px; margin-bottom: 5px; font-weight: 700; border-left: 3px solid #D7CCC8; padding-left: 8px; }

        /* è‰²ç¥¨èˆ‡è¼¸å…¥ */
        .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.2s; display: inline-block; }
        .color-swatch.selected { border-color: #8D6E63; transform: scale(1.1); box-shadow: 0 0 0 2px #D7CCC8; }
        
        .modal-content { border-radius: 15px; border: none; box-shadow: 0 10px 40px rgba(141, 110, 99, 0.15); }
        .modal-header { background-color: #FFF8E1; border-radius: 15px 15px 0 0; border-bottom: 1px solid #FFE0B2; }
        .modal-title { color: #5D4037; font-weight: bold; letter-spacing: 1px; }
        .captcha-box { background: #FFF3E0; color: #5D4037; font-size: 24px; font-weight: bold; padding: 8px; border-radius: 10px; text-align: center; border: 2px dashed #FFCC80; }
        .refresh-icon { cursor: pointer; color: #BCAAA4; transition: 0.3s; font-size: 1.2rem; margin-left: 15px; }
        
        /* é€£çµç®¡ç†å€å¡Š */
        #completedSection { background-color: #F1F8E9; border: 1px solid #C5E1A5; border-radius: 12px; margin-bottom: 20px; }
        .completed-badge { color: #558B2F; font-weight: bold; font-size: 0.95rem; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        #addLinkContainer { padding-bottom: 15px; border-bottom: 1px dashed #C5E1A5; margin-bottom: 10px; }
        #savedLinksContainer h6 { color: #33691E; font-weight: bold; font-size: 0.9rem; margin-bottom: 10px; }
        .saved-link-item { background-color: #FFFFFF; border: 1px solid #AED581; border-radius: 8px; padding: 8px 12px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .saved-link-name { font-weight: bold; color: #558B2F; font-size: 0.9rem; display: block; }
        .saved-link-url { color: #0277BD; font-size: 0.85rem; text-decoration: none; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .saved-link-url:hover { text-decoration: underline; }
        .link-safety-badge { font-size: 0.75rem; margin-left: 5px; padding: 1px 5px; border-radius: 4px; vertical-align: middle; }
        .badge-safe { background-color: #E8F5E9; color: #2E7D32; border: 1px solid #A5D6A7; }
        .badge-unsafe { background-color: #FFEBEE; color: #C62828; border: 1px solid #EF9A9A; }
        .input-link { background-color: #fff !important; }
        
        .time-input-style { background-color: #fff; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fa-solid fa-calendar-days me-2" style="color: #A1887F;"></i>æ³°åœ‹ä½›å ‚_å…±ç”¨è¡Œäº‹æ›†</h2>
        <button class="btn btn-custom-add" onclick="openAddModal()">
            <i class="fa-solid fa-plus me-1"></i> æ–°å¢è³‡æ–™
        </button>
    </div>
    <div id="calendar"></div>
    
    <!-- å„€è¡¨æ¿ -->
    <div class="row g-4 mt-4">
        <div class="col-md-6">
            <div class="dashboard-card card-history">
                <div class="dashboard-title"><i class="fa-solid fa-clock-rotate-left me-2 text-secondary"></i>æ­·å²ç´€éŒ„æŸ¥è©¢</div>
                <div class="row g-2 mb-3">
                    <div class="col-6"><select class="form-select form-select-sm" id="searchYear" onchange="filterHistoryResult()"><option>å¹´ä»½</option></select></div>
                    <div class="col-6"><select class="form-select form-select-sm" id="searchType" onchange="filterHistoryResult()"><option value="all">å…¨éƒ¨</option><option value="activity">æ´»å‹•</option><option value="person">äººå“¡</option></select></div>
                </div>
                <div class="mb-3"><select class="form-select" id="searchResult"><option>æœå°‹çµæœ</option></select></div>
                <div class="d-grid"><button class="btn btn-secondary btn-sm" onclick="jumpToSelectedEvent()" style="background-color: #8D6E63; border:none;">å‰å¾€è©²æœˆä»½ <i class="fa-solid fa-arrow-right"></i></button></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="dashboard-card card-upcoming">
                <div class="dashboard-title"><i class="fa-regular fa-calendar-plus me-2 text-secondary"></i>å³å°‡åˆ°ä¾†</div>
                <div class="upcoming-list-container" id="upcomingList"><div class="text-center text-muted py-3">è®€å–ä¸­...</div></div>
            </div>
        </div>
    </div>
</div>

<!-- å›å ±æŒ‰éˆ• -->
<div class="report-bug-container">
    <button class="btn-report-bug" onclick="openReportModal()">
        <i class="fa-solid fa-bug"></i> å›å ±å•é¡Œ
    </button>
</div>

<!-- Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">æ–°å¢è³‡æ–™</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="eventForm">
                    <input type="hidden" id="eventId">
                    <input type="hidden" id="selectedColor">

                    <!-- å·²å®Œæˆæ´»å‹•å€å¡Š -->
                    <div id="completedSection" class="p-3 mb-4" style="display: none;">
                        <div class="completed-badge"><i class="fa-solid fa-circle-check"></i> æ´»å‹•å·²å®Œæˆ - ç´€éŒ„åˆ†äº« <span id="linkCountBadge" class="ms-2 badge rounded-pill bg-secondary" style="font-size:0.7rem;">0/3</span></div>
                        <div id="addLinkContainer">
                            <label class="form-label small text-secondary mb-1 fw-bold"><i class="fa-solid fa-pen"></i> æ–°å¢é€£çµ</label>
                            <div class="input-group mb-1"><input type="text" class="form-control input-link" id="linkName" placeholder="åç¨±"></div>
                            <div class="input-group"><input type="url" class="form-control input-link" id="linkUrl" placeholder="https://..." oninput="checkUrlSafety(this.value)"><button type="button" class="btn btn-sm btn-success" onclick="addLinkToLocal()"><i class="fa-solid fa-plus"></i> åŠ å…¥</button></div>
                            <div id="urlSafetyFeedback" class="mt-1"></div>
                        </div>
                        <div id="savedLinksContainer" style="display:none;"><h6>å·²å­˜é€£çµåˆ—è¡¨</h6><div id="savedLinksList"></div></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-secondary small fw-bold">é¡å‹</label>
                        <select class="form-select" id="eventType" onchange="toggleFormFields()"><option value="activity">ğŸ‰ æ´»å‹•</option><option value="person">ğŸ‘¤ äººå“¡åƒèˆ‡</option></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-secondary small fw-bold" id="nameLabel">æ´»å‹•åç¨±</label>
                        <input type="text" class="form-control" id="eventTitle" placeholder="è«‹è¼¸å…¥å…§å®¹..." required>
                    </div>
                    <div class="row mb-3">
                        <label class="form-label text-secondary small fw-bold">é–‹å§‹</label>
                        <div class="col-7"><input type="text" class="form-control time-input-style" id="startDate" required></div>
                        <div class="col-5 time-field-group"><input type="text" class="form-control time-input-style" id="startTime" readonly></div>
                    </div>
                    <div class="row mb-3">
                        <label class="form-label text-secondary small fw-bold">çµæŸ</label>
                        <div class="col-7"><input type="text" class="form-control time-input-style" id="endDate" required></div>
                        <div class="col-5 time-field-group"><input type="text" class="form-control time-input-style" id="endTime" readonly></div>
                    </div>

                    <div class="mb-3" id="colorSection">
                        <label class="form-label text-secondary small fw-bold">æ¨™ç±¤é¡è‰²</label>
                        <div id="colorPalette" class="d-flex flex-wrap gap-2"></div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-secondary small fw-bold">é©—è­‰ç¢¼</label>
                        <div class="d-flex align-items-center">
                            <div id="captchaDisplay" class="captcha-box flex-grow-1"></div>
                            <i class="fa-solid fa-arrows-rotate refresh-icon ms-2" onclick="generateCaptcha()"></i>
                        </div>
                        <input type="text" class="form-control mt-2" id="captchaInput" placeholder="è«‹è¼¸å…¥ä¸Šæ–¹æ•¸å­—" required>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" style="background-color: #a3daff; color:#333; border:none; font-weight:600;">å„²å­˜è³‡æ–™</button>
                        <button type="button" id="deleteBtn" class="btn btn-outline-danger mt-2" style="display:none;" onclick="confirmDelete()">åˆªé™¤æ­¤è³‡æ–™</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwezycs59fxhwvksKUgWzByIj9a5bHRH2ByH0O7848HFxM7Ls2YjflGfqwx4okxROEE/exec';
    const ACTIVITY_COLOR = '#F48FB1';
    const PERSON_COLORS = ['#AED581', '#81D4FA', '#9FA8DA', '#E6EE9C', '#FFCC80', '#B0BEC5', '#BCAAA4', '#80CBC4', '#CE93D8', '#FFF59D', '#90CAF9', '#CFD8DC'];

    let calendar, currentCaptcha = "", currentReportCaptcha = "", currentLinks = [];
    let allEventsData = [];
    let fpStartDate, fpEndDate, fpStartTime, fpEndTime;
    let isEditingPastActivity = false;

    // --- æ—¥æœŸé‹ç®—å·¥å…· (ç´”å­—ä¸²æ“ä½œï¼Œé¿å…æ™‚å€å•é¡Œ) ---
    function getLocalDateString(isoStr) {
        if(!isoStr) return '';
        const d = new Date(isoStr);
        const offset = d.getTimezoneOffset() * 60000;
        return new Date(d.getTime() - offset).toISOString().split('T')[0];
    }
    function addDaysToDateString(dateStr, days) {
        const p = dateStr.split('-');
        const d = new Date(p[0], p[1]-1, p[2]);
        d.setDate(d.getDate() + days);
        const year = d.getFullYear();
        const month = (d.getMonth()+1).toString().padStart(2,'0');
        const day = d.getDate().toString().padStart(2,'0');
        return `${year}-${month}-${day}`;
    }

    document.addEventListener('DOMContentLoaded', function() {
        renderColorPalette();
        
        const fpConfigDate = { locale: "zh_tw", dateFormat: "Y-m-d", onChange: function(selectedDates, dateStr) { syncDates(dateStr); } };
        const fpConfigTime = { locale: "zh_tw", enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true, minuteIncrement: 15, disableMobile: "true" };
        
        fpStartDate = flatpickr("#startDate", fpConfigDate);
        fpEndDate = flatpickr("#endDate", fpConfigDate);
        fpStartTime = flatpickr("#startTime", fpConfigTime);
        fpEndTime = flatpickr("#endTime", fpConfigTime);

        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'zh-tw',
            headerToolbar: { left: 'myToday', center: 'prev,title,next', right: 'dayGridMonth,timeGridWeek,listWeek' },
            buttonText: { month: 'æœˆ', week: 'é€±', list: 'åˆ—è¡¨' },
            customButtons: {
                myToday: { text: 'ä»Šå¤©', click: function() { calendar.today(); jumpToDate(new Date().toISOString()); } }
            },
            eventDisplay: 'block', contentHeight: 'auto', dayMaxEvents: 4, fixedWeekCount: false,
            eventOrder: 'typeOrder,start,title',
            navLinks: true, navLinkDayClick: function(date) { jumpToDate(date); },
            events: fetchEventsFromGoogleSheet,
            eventClick: function(info) {
                if (info.view.type.includes('list')) jumpToDate(info.event.start);
                else openEditModal(info.event);
            },
            eventTimeFormat: { hour: '2-digit', minute: '2-digit', meridiem: false, hour12: false }
        });
        calendar.render();
    });

    function fetchEventsFromGoogleSheet(info, successCallback, failureCallback) {
        if(allEventsData.length === 0) Swal.fire({ title: 'è®€å–ä¸­...', didOpen: () => Swal.showLoading(), toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
        
        fetch(SCRIPT_URL).then(res => res.json()).then(data => {
            if(data.result && data.result.startsWith("Error")) return;
            allEventsData = [];
            let explodedEvents = [];
            
            data.forEach(item => {
                const type = item.type || item.extendedProps?.type || 'person';
                const isAct = type === 'activity';
                const itemOrder = isAct ? 1 : 2;

                // å‚™ä»½åŸå§‹è³‡æ–™
                allEventsData.push({
                    id: item.id, title: item.title, start: item.start, end: item.end,
                    backgroundColor: item.backgroundColor, textColor: item.textColor,
                    extendedProps: { type, linkUrl: item.linkUrl || '', linkName: item.linkName || '' },
                    type: type
                });

                if (item.start) {
                    const startDateStr = getLocalDateString(item.start);
                    let endDateStr = item.end ? getLocalDateString(item.end) : startDateStr;
                    if (isAct) endDateStr = addDaysToDateString(endDateStr, 1);

                    let currentStr = startDateStr;
                    let safety = 0;
                    // æ‹†è§£æ—¥æœŸï¼Œç¢ºä¿æ¯æ ¼ç¨ç«‹
                    while (currentStr < endDateStr) {
                        if(safety++ > 365) break; // å®‰å…¨ä¿éšª
                        
                        const classList = ['hide-time-text'];
                        if (isAct) classList.push('event-type-activity');
                        else classList.push('person-pill');

                        explodedEvents.push({
                            id: item.id, title: item.title, start: currentStr, end: currentStr, allDay: true,
                            backgroundColor: item.backgroundColor, textColor: item.textColor,
                            extendedProps: { type, typeOrder: itemOrder },
                            classNames: classList
                        });
                        currentStr = addDaysToDateString(currentStr, 1);
                    }
                }
            });
            renderDashboard();
            successCallback(explodedEvents);
            Swal.close();
        }).catch(err => failureCallback(err));
    }

    // --- é€£çµç®¡ç† ---
    function addLinkToLocal() {
        if (currentLinks.length >= 3) { Swal.fire('é™åˆ¶', 'æœ€å¤š3å€‹é€£çµ', 'warning'); return; }
        const name = document.getElementById('linkName').value.trim();
        const url = document.getElementById('linkUrl').value.trim();
        if (!name || !url) { Swal.fire('è«‹è¼¸å…¥è³‡æ–™', '', 'warning'); return; }
        currentLinks.push({ name, url });
        renderLinkList();
        document.getElementById('linkName').value = '';
        document.getElementById('linkUrl').value = '';
        document.getElementById('urlSafetyFeedback').innerHTML = '';
    }

    function renderLinkList() {
        const list = document.getElementById('savedLinksList');
        const container = document.getElementById('savedLinksContainer');
        const badge = document.getElementById('linkCountBadge');
        list.innerHTML = '';
        badge.innerText = `${currentLinks.length}/3`;
        
        if (currentLinks.length === 0) { container.style.display = 'none'; return; }
        container.style.display = 'block';

        currentLinks.forEach((link, index) => {
            let badgeHtml = '';
            try {
                const u = new URL(link.url);
                badgeHtml = u.protocol === 'https:' ? '<span class="link-safety-badge badge-safe"><i class="fa-solid fa-lock"></i> å®‰å…¨</span>' : '<span class="link-safety-badge badge-unsafe">ä¸å®‰å…¨</span>';
            } catch(e) { badgeHtml = '<span class="link-safety-badge badge-unsafe">æ ¼å¼éŒ¯èª¤</span>'; }

            list.insertAdjacentHTML('beforeend', `
                <div class="saved-link-item">
                    <div class="saved-link-info">
                        <span class="saved-link-name">${link.name}</span>
                        <div><a href="${link.url}" target="_blank" class="saved-link-url">${link.url}</a>${badgeHtml}</div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger border-0 ms-2" onclick="openDeleteLinkCaptchaModal(${index})"><i class="fa-solid fa-trash"></i></button>
                </div>`);
        });
    }

    function openDeleteLinkCaptchaModal(index) {
        refreshReportCaptcha();
        Swal.fire({
            title: 'åˆªé™¤é€£çµç¢ºèª',
            html: `<div class="d-flex align-items-center mb-2"><div id="reportCaptchaDisplay" class="captcha-box flex-grow-1">${currentReportCaptcha}</div></div><input type="text" id="delLinkInput" class="form-control" placeholder="è¼¸å…¥é©—è­‰ç¢¼">`,
            showCancelButton: true, confirmButtonText: 'åˆªé™¤', confirmButtonColor: '#d32f2f',
            preConfirm: () => { if(document.getElementById('delLinkInput').value !== currentReportCaptcha) { Swal.showValidationMessage('é©—è­‰ç¢¼éŒ¯èª¤'); return false; } }
        }).then((res) => { if(res.isConfirmed) { currentLinks.splice(index, 1); renderLinkList(); } });
    }

    function checkUrlSafety(url) {
        const feedback = document.getElementById('urlSafetyFeedback');
        if (!url) { feedback.innerHTML = ''; return; }
        try {
            const u = new URL(url);
            feedback.innerHTML = u.protocol === 'https:' ? '<span class="text-success small fw-bold"><i class="fa-solid fa-circle-check"></i> å®‰å…¨ (HTTPS)</span>' : '<span class="text-warning small fw-bold">éåŠ å¯†é€£çµ</span>';
        } catch (e) { feedback.innerHTML = '<span class="text-danger small fw-bold">æ ¼å¼éŒ¯èª¤</span>'; }
    }

    // --- UI é‚è¼¯ ---
    function renderColorPalette() {
        const p = document.getElementById('colorPalette');
        let h = ''; PERSON_COLORS.forEach(c => h += `<div class="color-swatch" style="background:${c}" onclick="selectColor('${c}')" data-color="${c}"></div>`);
        p.innerHTML = h;
    }
    function selectColor(c) {
        document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('selected'));
        const s = document.querySelector(`.color-swatch[data-color="${c}"]`);
        if(s) s.classList.add('selected');
        document.getElementById('selectedColor').value = c;
    }
    
    function toggleFormFields() {
        const type = document.getElementById('eventType').value;
        const isAct = type === 'activity';
        document.getElementById('nameLabel').innerText = isAct ? 'æ´»å‹•åç¨±' : 'åƒèˆ‡äººå§“å';
        document.querySelectorAll('.time-field-group').forEach(el => el.style.display = isAct ? 'block' : 'none');
        
        document.getElementById('colorSection').style.display = isAct ? 'none' : 'block';
        
        if (isAct) {
            document.getElementById('selectedColor').value = ACTIVITY_COLOR;
            document.getElementById('completedSection').style.display = isEditingPastActivity ? 'block' : 'none';
        } else {
            if(!document.getElementById('eventId').value) {
                const last = localStorage.getItem('lastPersonColor') || PERSON_COLORS[0];
                selectColor(last);
            }
            document.getElementById('completedSection').style.display = 'none';
        }
    }

    function openAddModal() {
        document.getElementById('eventForm').reset();
        document.getElementById('eventId').value = '';
        document.getElementById('modalTitle').innerText = 'æ–°å¢è³‡æ–™';
        document.getElementById('deleteBtn').style.display = 'none';
        isEditingPastActivity = false; currentLinks = [];
        document.getElementById('completedSection').style.display = 'none';
        
        const curr = calendar.getDate(); const today = new Date();
        const target = (curr.getMonth()===today.getMonth() && curr.getFullYear()===today.getFullYear()) ? today : curr;
        const dStr = getLocalDateString(target.toISOString());
        
        fpStartDate.setDate(dStr); fpEndDate.setDate(dStr);
        fpStartTime.setDate("08:00"); fpEndTime.setDate("08:00");
        
        generateCaptcha(); toggleFormFields();
        new bootstrap.Modal(document.getElementById('eventModal')).show();
    }

    function openEditModal(e) {
        const original = allEventsData.find(evt => evt.id === e.id) || e;
        document.getElementById('eventId').value = original.id;
        document.getElementById('modalTitle').innerText = 'ç·¨è¼¯è³‡æ–™';
        document.getElementById('deleteBtn').style.display = 'block';
        
        const type = original.extendedProps?.type || 'person';
        document.getElementById('eventType').value = type;
        document.getElementById('eventTitle').value = original.title;
        
        const todayStr = getLocalDateString(new Date().toISOString());
        const endCheck = original.end ? getLocalDateString(original.end) : getLocalDateString(original.start);
        isEditingPastActivity = (type === 'activity' && endCheck <= todayStr);

        try { currentLinks = JSON.parse(original.extendedProps?.linkUrl || '[]'); } catch(err) { currentLinks = []; }
        renderLinkList();
        
        toggleFormFields();
        if(type !== 'activity') selectColor(original.backgroundColor);
        
        const sStr = getLocalDateString(original.start);
        fpStartDate.setDate(sStr);
        
        if (type === 'activity') {
            fpStartTime.setDate(original.start.substring(11, 16));
            if (original.end) {
                fpEndDate.setDate(getLocalDateString(original.end));
                fpEndTime.setDate(original.end.substring(11, 16));
            }
        } else {
            if (original.end) {
                fpEndDate.setDate(addDaysToDateString(getLocalDateString(original.end), -1));
            } else {
                fpEndDate.setDate(sStr);
            }
        }
        
        generateCaptcha();
        new bootstrap.Modal(document.getElementById('eventModal')).show();
    }

    function saveEventToCloud(data, action) {
        Swal.fire({title:'å„²å­˜ä¸­...',didOpen:()=>Swal.showLoading()});
        fetch(SCRIPT_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain'}, body:JSON.stringify({action:action,...data}) })
        .then(()=>{ setTimeout(()=>{ Swal.fire({icon:'success',title:'å®Œæˆ',timer:1500,showConfirmButton:false}); calendar.refetchEvents(); bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide(); },2000); });
    }

    function deleteEventFromCloud(id) {
        Swal.fire({title:'åˆªé™¤ä¸­...',didOpen:()=>Swal.showLoading()});
        fetch(SCRIPT_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain'}, body:JSON.stringify({action:'delete',id:id}) })
        .then(()=>{ setTimeout(()=>{ Swal.fire('å·²åˆªé™¤','','success'); calendar.refetchEvents(); bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide(); },2000); });
    }
    
    function sendReport(c) {
        Swal.fire({title:'å‚³é€ä¸­...',didOpen:()=>Swal.showLoading()});
        fetch(SCRIPT_URL, {method:'POST',mode:'no-cors',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'send_report',content:c})})
        .then(()=>Swal.fire('å·²å›å ±','','success'));
    }

    // --- è¼”åŠ© ---
    function syncDates(dStr) { if(dStr){ const s=new Date(document.getElementById('startDate').value), e=new Date(document.getElementById('endDate').value); if(e<s) fpEndDate.setDate(s); } }
    function syncTimes() { /* Flatpickr handled */ }
    function generateCaptcha() { currentCaptcha = Math.floor(1000+Math.random()*9000).toString(); document.getElementById('captchaDisplay').innerText = currentCaptcha; document.getElementById('captchaInput').value = ''; }
    function refreshReportCaptcha() { currentReportCaptcha = Math.floor(1000+Math.random()*9000).toString(); if(document.getElementById('reportCaptchaDisplay')) document.getElementById('reportCaptchaDisplay').innerText = currentReportCaptcha; }
    function openReportModal() {
        refreshReportCaptcha();
        Swal.fire({ title:'å›å ±å•é¡Œ', html: `<textarea id="repTxt" class="form-control mb-2"></textarea>é©—è­‰ç¢¼: <span id="reportCaptchaDisplay">${currentReportCaptcha}</span><br><input id="repCap" class="form-control mt-2">`, showCancelButton:true, preConfirm: () => {
            if(document.getElementById('repCap').value !== currentReportCaptcha) { Swal.showValidationMessage('é©—è­‰ç¢¼éŒ¯èª¤'); return false; }
            return document.getElementById('repTxt').value;
        }}).then(r => { if(r.isConfirmed) sendReport(r.value); });
    }
    function confirmDelete() { if(document.getElementById('captchaInput').value!==currentCaptcha){Swal.fire('é©—è­‰ç¢¼éŒ¯èª¤');return;} Swal.fire({title:'åˆªé™¤?',showCancelButton:true}).then(r=>{if(r.isConfirmed) deleteEventFromCloud(document.getElementById('eventId').value)}); }
    
    function jumpToDate(s) { 
        calendar.changeView('dayGridMonth', s); 
        setTimeout(()=>{
            document.querySelectorAll('.highlight-target-day').forEach(el=>el.classList.remove('highlight-target-day'));
            const el = document.querySelector(`.fc-daygrid-day[data-date="${getLocalDateString(s)}"]`);
            if(el) { el.classList.add('highlight-target-day'); el.scrollIntoView({behavior:"smooth",block:"center"}); }
        },200);
    }

    // å„€è¡¨æ¿
    function renderDashboard() {
        const list = document.getElementById('upcomingList');
        const today = getLocalDateString(new Date().toISOString());
        const up = allEventsData.filter(e => getLocalDateString(e.start) >= today).sort((a,b)=>new Date(a.start)-new Date(b.start));
        
        let h = '';
        const acts = up.filter(e=>(e.extendedProps?.type||e.type)==='activity');
        const ppl = up.filter(e=>(e.extendedProps?.type||e.type)!=='activity');
        
        if(acts.length) {
            h+='<div class="section-label">è¿‘æœŸæ´»å‹•</div>';
            acts.forEach(e=>h+=`<button class="btn dashboard-btn btn-act" style="background:${e.backgroundColor};color:#333" onclick="jumpToDate('${e.start}')"><b>${e.title}</b> <small>${getLocalDateString(e.start)}</small></button>`);
        }
        if(ppl.length) {
            h+='<div class="section-label">è¿‘æœŸäººå“¡</div><div class="d-block">';
            ppl.forEach(e=>h+=`<button class="btn dashboard-btn btn-person" style="background:${e.backgroundColor};color:#333" onclick="jumpToDate('${e.start}')">${getLocalDateString(e.start)} ${e.title}</button>`);
            h+='</div>';
        }
        list.innerHTML = h || '<div class="text-center text-muted">ç„¡è¿‘æœŸæ´»å‹•</div>';
        
        const ys = new Set(allEventsData.map(e=>getLocalDateString(e.start).substring(0,4)));
        const sel = document.getElementById('searchYear'); sel.innerHTML='<option>å¹´ä»½</option>';
        Array.from(ys).sort().reverse().forEach(y=> sel.innerHTML+=`<option value="${y}">${y}å¹´</option>`);
    }
    function filterHistoryResult() {
        const y = document.getElementById('searchYear').value;
        const t = document.getElementById('searchType').value;
        const res = document.getElementById('searchResult');
        res.innerHTML = '<option>é¸æ“‡çµæœ</option>';
        if(y === 'å¹´ä»½') return;
        
        const today = getLocalDateString(new Date().toISOString());
        const fil = allEventsData.filter(e => getLocalDateString(e.start).substring(0,4)===y && (t==='all' || e.type===t) && getLocalDateString(e.start) < today).sort((a,b)=>new Date(a.start)-new Date(b.start));
        fil.forEach(e => res.innerHTML += `<option value="${e.start}">${getLocalDateString(e.start)} ${e.title}</option>`);
    }
    function jumpToSelectedEvent() { const v = document.getElementById('searchResult').value; if(v && v!=='é¸æ“‡çµæœ') jumpToDate(v); }

    document.getElementById('eventForm').addEventListener('submit', function(e) {
        e.preventDefault();
        if(document.getElementById('captchaInput').value !== currentCaptcha) { Swal.fire('é©—è­‰ç¢¼éŒ¯èª¤'); return; }
        
        const ln=document.getElementById('linkName').value.trim(), lu=document.getElementById('linkUrl').value.trim();
        if(ln && lu && currentLinks.length<3) currentLinks.push({name:ln, url:lu});

        const id=document.getElementById('eventId').value, type=document.getElementById('eventType').value;
        const sDate=document.getElementById('startDate').value, eDate=document.getElementById('endDate').value;
        
        let sStr, eStr;
        if(type==='activity') {
            sStr = `${sDate}T${document.getElementById('startTime').value}`;
            eStr = `${eDate}T${document.getElementById('endTime').value}`;
        } else {
            sStr = sDate;
            eStr = addDaysToDateString(eDate, 1);
        }
        
        let color = (type==='activity') ? ACTIVITY_COLOR : document.getElementById('selectedColor').value;
        if(type!=='activity') localStorage.setItem('lastPersonColor', color);

        const evt = {
            id: id || ('evt_' + Date.now()),
            title: document.getElementById('eventTitle').value,
            type: type, start: sStr, end: eStr,
            backgroundColor: color, textColor: '#333',
            order: type==='activity'?-1:10,
            linkName: 'MultiLinks', linkUrl: JSON.stringify(currentLinks)
        };
        saveEventToCloud(evt, id?'update':'create');
    });
</script>
</body>
</html>