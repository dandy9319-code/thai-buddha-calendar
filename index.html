<!-- v1.4 | Fix ReferenceError & Dynamic Captcha | 2025-09-30 -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³°åœ‹ä½›å ‚_å…±ç”¨è¡Œäº‹æ›†</title>
    
    <!-- æ ¸å¿ƒå¥—ä»¶ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* =========================================
           ğŸµ æº«æ½¤æ—¥ç³»é¢¨æ ¼ (Warm & Cozy Style) - v1.3 Mobile Optimized
           ========================================= */
        :root {
            --bg-color: #FDFCF5;        
            --card-bg: #FFFFFF;        
            --text-primary: #5D4037;    
            --text-secondary: #8D6E63; 
            --border-color: #EFEBE9;    
            --accent-color: #8D6E63;    /* æš–è¤è‰² (ä¸€èˆ¬æŒ‰éˆ•) */
            --primary-action: #a3daff; /* äº®è—è‰² (æ–°å¢æŒ‰éˆ•) */
            --border-radius: 10px;      
        }

        body { 
            background-color: var(--bg-color);
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; 
            color: var(--text-primary);
        }
        
        /* é è¨­ Container (é›»è…¦ç‰ˆ) */
        .container { max-width: 1200px; margin-top: 40px; margin-bottom: 40px; }
        
        h2 { 
            font-weight: 700; 
            color: var(--text-primary); 
            letter-spacing: 1.5px; 
            font-size: 1.8rem;
            border-bottom: 3px solid #D7CCC8;
            display: inline-block;
            padding-bottom: 5px;
        }
        
        #calendar { 
            background: var(--card-bg);
            padding: 25px; 
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(141, 110, 99, 0.08);
            border: 1px solid var(--border-color);
        }

        /* =========================================
           ğŸ“± æ‰‹æ©Ÿç‰ˆé©é… (< 768px) - v1.3 æ¥µè‡´å„ªåŒ–
           ç›®æ¨™ï¼šé¡ Google Calendar APP é«”é©— (æ»¿ç‰ˆã€ç²¾ç°¡ã€FABæŒ‰éˆ•)
           ========================================= */
        @media (max-width: 767.98px) {
            /* 1. æ»¿ç‰ˆè¨­å®š & èƒŒæ™¯ç´”æ·¨åŒ– */
            body { background-color: #FFFFFF; } 
            
            .container { 
                max-width: 100%; 
                margin: 0; 
                padding: 0; 
                overflow-x: hidden;
            }
            
            /* æ¨™é¡Œåˆ—ï¼šæ”¹ç‚ºç½®é ‚å›ºå®šï¼Œå¢åŠ ç©ºé–“åˆ©ç”¨ç‡ */
            .d-flex.justify-content-between {
                padding: 10px 15px;
                background-color: var(--bg-color);
                position: sticky;
                top: 0;
                z-index: 100;
                border-bottom: 1px solid #EFEBE9;
                margin-bottom: 0 !important;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            }
            
            h2 { 
                font-size: 1.2rem; 
                margin: 0; 
                border: none; 
                padding: 0; 
            }
            
            /* 2. è¡Œäº‹æ›†æœ¬é«”ï¼šå»æ¡†ã€å»å…§è·ã€æ»¿ç‰ˆ */
            #calendar { 
                padding: 0; 
                border: none; 
                border-radius: 0; 
                box-shadow: none;
                margin-bottom: 20px !important;
            }
            
            /* å·¥å…·åˆ— (ä¸Šå€‹æœˆ/ä¸‹å€‹æœˆ) */
            .fc-header-toolbar {
                padding: 8px 5px;
                margin-bottom: 5px !important;
            }
            .fc-toolbar-title { font-size: 1.1rem !important; }
            .fc-button { 
                padding: 4px 10px !important; 
                font-size: 0.8rem !important; 
            }

            /* 3. æ ¼å­èˆ‡å­—é«”æ¥µå°åŒ– */
            .fc-daygrid-day-frame {
                min-height: 70px !important; 
            }
            .fc-col-header-cell {
                padding: 5px 0;
                font-size: 0.8rem; /* æ˜ŸæœŸå¹¾çš„å­—ç¸®å° */
            }
            .fc-daygrid-day-number {
                font-size: 0.75rem !important; /* æ—¥æœŸæ•¸å­—ç¸®å° */
                color: #777;
                padding: 2px 4px !important;
            }
            
            /* äº‹ä»¶æ¢ï¼šæ›´ç·Šæ¹Š */
            .fc-event {
                font-size: 0.7rem !important; /* ç´„ 11-12px */
                padding: 1px 3px !important;
                border-radius: 2px !important;
                margin: 1px 0 !important;
                line-height: 1.2 !important;
            }
            
            /* 4. ã€Œæ–°å¢ã€æŒ‰éˆ•å„ªåŒ–ï¼šæ”¹ç‚ºæ‡¸æµ®æŒ‰éˆ• (FAB) */
            .btn-custom-add {
                position: fixed;
                bottom: 30px;
                right: 20px;
                width: 56px;
                height: 56px;
                border-radius: 50%;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                font-size: 0 !important; /* éš±è—æ–‡å­— */
                background-color: var(--primary-action);
            }
            /* å¼·åˆ¶é¡¯ç¤º icon ä¸¦æ”¾å¤§ */
            .btn-custom-add i {
                font-size: 1.5rem !important; 
                margin: 0 !important;
                display: block !important;
            }
            .btn-custom-add:hover { transform: scale(1.05); }

            /* 5. å„€è¡¨æ¿èˆ‡å›å ±æŒ‰éˆ•èª¿æ•´ */
            .dashboard-card {
                margin: 0 10px 15px 10px; /* å¡ç‰‡å·¦å³ç•™ä¸€é»é‚Šè· */
                border-radius: 8px;
            }
            
            /* å›å ±æŒ‰éˆ•ï¼šé¿å…è¢« FAB æ“‹ä½ï¼Œæ”¹ç‚ºç½®ä¸­ä¸¦å¢Šé«˜ */
            .report-bug-container {
                justify-content: center;
                padding-bottom: 90px; /* é ç•™ FAB ç©ºé–“ */
                margin-top: 10px;
            }
            .btn-report-bug {
                background-color: rgba(144, 164, 174, 0.9);
                font-size: 0.8rem;
                padding: 5px 15px;
            }
            
            /* Modal æ»¿ç‰ˆå¾®èª¿ */
            .modal-dialog { margin: 10px; }
        }

        /* é›»è…¦ç‰ˆè¨­å®š (ç¶­æŒåŸæ¨£) */
        @media (min-width: 768px) {
            .fc-daygrid-day-frame {
                height: 130px !important; 
                min-height: 130px !important;
                max-height: 130px !important;
                overflow: hidden;
                position: relative; 
            }
            /* é›»è…¦ç‰ˆå›å ±æŒ‰éˆ•ä½ç½® */
            .report-bug-container { 
                display: flex;
                justify-content: flex-end;
                margin-top: 20px;
                padding-bottom: 20px;
                width: 100%;
            }
        }

        /* é€šç”¨æ¨£å¼ (æ—¥æœŸé€£çµå»åº•ç·š) */
        .fc-daygrid-day-top { flex-direction: row; padding: 1px 4px !important; height: 24px !important; min-height: 24px !important; }
        .fc-daygrid-day-number { font-size: 0.9rem; line-height: 1; margin: 0 !important; }
        a.fc-col-header-cell-cushion, a.fc-daygrid-day-number { text-decoration: none !important; color: var(--text-secondary) !important; cursor: pointer; }
        a.fc-col-header-cell-cushion:hover, a.fc-daygrid-day-number:hover { text-decoration: none !important; color: var(--text-primary) !important; }

        /* Highlight Animation */
        @keyframes flash-highlight {
            0% { background-color: rgba(255, 235, 59, 0.8); box-shadow: inset 0 0 20px rgba(255, 215, 0, 0.6); }
            100% { background-color: transparent; box-shadow: none; }
        }
        .highlight-target-day { animation: flash-highlight 2.5s ease-out; position: relative; z-index: 10; }
        
        /* Event Styles */
        .fc-event { cursor: pointer; border: none !important; box-shadow: 0 1px 1px rgba(93, 64, 55, 0.1); font-size: 0.8rem; margin-bottom: 1px !important; border-radius: 4px !important; padding: 1px 6px !important; line-height: 1.3 !important; }
        .fc-event:hover { transform: translateY(-1px); filter: brightness(0.95); z-index: 5; }
        .person-pill { display: inline-block !important; width: auto !important; margin-right: 4px !important; white-space: nowrap; font-weight: 500; color: #5D4037 !important; background-color: var(--event-color, #eee); }
        .event-type-activity { background-color: #F8BBD0; border-left: 4px solid #EC407A !important; color: #5D4037 !important; font-weight: bold; width: 100% !important; display: block !important; margin-bottom: 2px !important; }
        .hide-time-text .fc-event-time { display: none !important; }
        .fc-daygrid-day-events { display: flex !important; flex-wrap: wrap !important; align-content: flex-start !important; gap: 1px !important; padding: 0 2px !important; margin-top: 0 !important; }
        .fc-daygrid-event-harness { width: auto !important; max-width: 100%; }
        .fc-daygrid-event-harness:has(.event-type-activity) { width: 100% !important; flex-basis: 100% !important; }

        /* UI Components */
        .fc-col-header-cell { background-color: #FFF8E1; padding: 8px 0; border-bottom: 2px solid #FFE0B2; color: var(--text-primary); }
        
        /* Button Styles */
        .fc-button-primary { background-color: var(--accent-color) !important; border-color: var(--accent-color) !important; color: #FFFFFF !important; border-radius: 8px !important; font-weight: 500 !important; padding: 5px 14px !important; box-shadow: 0 2px 4px rgba(141, 110, 99, 0.2) !important; transition: all 0.2s ease !important; opacity: 0.9; }
        .fc-button-primary:hover { background-color: #795548 !important; border-color: #795548 !important; transform: translateY(-1px); opacity: 1; }
        .fc-button-primary:not(:disabled).fc-button-active { background-color: #5D4037 !important; border-color: #5D4037 !important; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2) !important; }
        .fc-button:focus { box-shadow: none !important; }

        /* Custom Add Button (Desktop Default) */
        .btn-custom-add { background-color: var(--primary-action); color: #333; border-radius: var(--border-radius); padding: 10px 30px; border: none; box-shadow: 0 3px 10px rgba(163, 218, 255, 0.4); transition: all 0.2s; font-weight: 600; letter-spacing: 1px; }
        .btn-custom-add:hover { background-color: #81D4FA; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(163, 218, 255, 0.6); color: #333;}

        /* Report Button (Default) */
        .btn-report-bug { background-color: #90A4AE; color: white; padding: 8px 20px; border-radius: 30px; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 0.95rem; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.3s; }
        .btn-report-bug:hover { background-color: #78909C; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        
        /* Dashboard */
        .dashboard-card { background: #fff; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 20px; height: 100%; box-shadow: 0 4px 15px rgba(141, 110, 99, 0.05); }
        .card-history { background-color: #FAFAFA; border-top: 5px solid #AED581; }
        .card-upcoming { background-color: #FAFAFA; border-top: 5px solid #FFD54F; }
        .dashboard-title { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid #EFEBE9; }
        .upcoming-list-container { max-height: 400px; overflow-y: auto; padding-right: 8px; }
        .upcoming-list-container::-webkit-scrollbar { width: 5px; }
        .upcoming-list-container::-webkit-scrollbar-thumb { background-color: #D7CCC8; border-radius: 10px; }
        .dashboard-btn { border: none; font-size: 0.9rem; box-shadow: 0 1px 3px rgba(141, 110, 99, 0.1); transition: 0.2s; position: relative; border-radius: 6px; }
        .dashboard-btn:hover { transform: translateY(-1px); opacity: 0.95; }
        .btn-act { width: 100%; text-align: left; padding: 8px 15px; margin-bottom: 8px; }
        .btn-person { display: inline-block; width: auto; padding: 6px 12px; margin-right: 6px; margin-bottom: 8px; border-radius: 15px; font-size: 0.85rem; font-weight: 500; }
        .section-label { font-size: 0.85rem; color: #A1887F; margin-top: 10px; margin-bottom: 5px; font-weight: 700; letter-spacing: 1px; border-left: 3px solid #D7CCC8; padding-left: 8px; }

        /* Misc */
        .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.2s; display: inline-block; }
        .color-swatch:hover { transform: scale(1.15); }
        .color-swatch.selected { border-color: #8D6E63; transform: scale(1.1); box-shadow: 0 0 0 2px #D7CCC8; }
        .modal-content { border-radius: 15px; border: none; box-shadow: 0 10px 40px rgba(141, 110, 99, 0.15); }
        .modal-header { background-color: #FFF8E1; border-radius: 15px 15px 0 0; border-bottom: 1px solid #FFE0B2; }
        .modal-title { color: #5D4037; font-weight: bold; letter-spacing: 1px; }
        .captcha-box { background: #FFF3E0; color: #5D4037; font-size: 24px; font-weight: bold; letter-spacing: 6px; text-align: center; padding: 8px; border-radius: var(--border-radius); user-select: none; border: 2px dashed #FFCC80; }
        .refresh-icon { cursor: pointer; color: #BCAAA4; transition: 0.3s; font-size: 1.2rem; margin-left: 15px; margin-top: 5px; }
        .refresh-icon:hover { color: #8D6E63; transform: rotate(180deg); }
        #completedSection { background-color: #F1F8E9; border: 1px solid #C5E1A5; border-radius: 12px; margin-bottom: 20px; }
        .completed-badge { color: #558B2F; font-weight: bold; font-size: 0.95rem; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .input-link { background-color: #fff !important; }
        #addLinkContainer { padding-bottom: 15px; border-bottom: 1px dashed #C5E1A5; margin-bottom: 10px; }
        #savedLinksContainer h6 { color: #33691E; font-weight: bold; font-size: 0.9rem; margin-bottom: 10px; }
        .saved-link-item { background-color: #FFFFFF; border: 1px solid #AED581; border-radius: 8px; padding: 8px 12px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .saved-link-info { flex-grow: 1; overflow: hidden; }
        .saved-link-name { font-weight: bold; color: #558B2F; font-size: 0.9rem; display: block; }
        .saved-link-url { color: #0277BD; font-size: 0.85rem; text-decoration: none; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .saved-link-url:hover { text-decoration: underline; }
        .link-safety-badge { font-size: 0.75rem; margin-left: 5px; padding: 1px 5px; border-radius: 4px; vertical-align: middle; }
        .badge-safe { background-color: #E8F5E9; color: #2E7D32; border: 1px solid #A5D6A7; }
        .badge-unsafe { background-color: #FFEBEE; color: #C62828; border: 1px solid #EF9A9A; }
        .btn-save-modal { background-color: var(--primary-action); color: #333; border: none; border-radius: 8px; box-shadow: 0 3px 8px rgba(79, 195, 247, 0.3); transition: all 0.2s; font-weight: 600; }
        .btn-save-modal:hover { background-color: #29B6F6; transform: translateY(-2px); box-shadow: 0 5px 12px rgba(79, 195, 247, 0.5); color: #333; }
        .btn-delete-modal { border: 1px solid #ef9a9a; color: #d32f2f; background-color: transparent; border-radius: 8px; transition: all 0.2s; font-weight: 600; }
        .btn-delete-modal:hover { background-color: #ef9a9a; color: white !important; box-shadow: 0 3px 8px rgba(239, 154, 154, 0.4); transform: translateY(-1px); }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h2><i class="fa-solid fa-calendar-days me-2" style="color: #A1887F;"></i>æ³°åœ‹ä½›å ‚_å…±ç”¨è¡Œäº‹æ›†</h2>
        <button class="btn btn-custom-add" onclick="openAddModal()">
            <i class="fa-solid fa-plus me-1"></i> æ–°å¢è³‡æ–™
        </button>
    </div>
    
    <div id="calendar" class="mb-5"></div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="dashboard-card card-history">
                <div class="dashboard-title"><i class="fa-solid fa-clock-rotate-left me-2 text-secondary"></i>æ­·å²ç´€éŒ„æŸ¥è©¢</div>
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label text-muted small">å¹´ä»½</label>
                        <select class="form-select form-select-sm" id="searchYear" onchange="filterHistoryResult()"><option value="">é¸æ“‡å¹´ä»½...</option></select>
                    </div>
                    <div class="col-6">
                        <label class="form-label text-muted small">é¡å‹</label>
                        <select class="form-select form-select-sm" id="searchType" onchange="filterHistoryResult()"><option value="all">å…¨éƒ¨</option><option value="activity">æ´»å‹•</option><option value="person">äººå“¡åƒèˆ‡</option></select>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted small">æœå°‹çµæœ</label>
                    <select class="form-select" id="searchResult"><option value="">è«‹å…ˆé¸æ“‡å¹´ä»½èˆ‡é¡å‹...</option></select>
                </div>
                <div class="d-grid">
                    <button class="btn btn-secondary btn-sm" onclick="jumpToSelectedEvent()" style="background-color: #8D6E63; border:none; border-radius: 8px;">å‰å¾€è©²æœˆä»½ <i class="fa-solid fa-arrow-right ms-1"></i></button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="dashboard-card card-upcoming">
                <div class="dashboard-title"><i class="fa-regular fa-calendar-plus me-2 text-secondary"></i>å³å°‡åˆ°ä¾†</div>
                <div class="upcoming-list-container" id="upcomingList"><div class="text-center text-muted py-4">è®€å–ä¸­...</div></div>
            </div>
        </div>
    </div>

    <!-- å›å ±æŒ‰éˆ• (ç§»è‡³åº•éƒ¨å›ºå®šæµ) -->
    <div class="report-bug-container">
        <button class="btn-report-bug" onclick="openReportModal()">
            <i class="fa-solid fa-bug"></i> å›å ±å•é¡Œ
        </button>
    </div>
</div>

<!-- Modal å€å¡Š (é‚è¼¯ç”± UIManager æ§åˆ¶) -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">æ–°å¢è³‡æ–™</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="eventForm">
                    <input type="hidden" id="eventId">
                    <input type="hidden" id="selectedColor">

                    <div id="completedSection" class="p-3 mb-4" style="display: none;">
                        <div class="completed-badge"><i class="fa-solid fa-circle-check"></i> æ´»å‹•å·²å®Œæˆ - ç´€éŒ„åˆ†äº« <span id="linkCountBadge" class="ms-2 badge rounded-pill bg-secondary" style="font-size:0.7rem;">0/3</span></div>
                        <div id="addLinkContainer">
                            <label class="form-label small text-secondary mb-1 fw-bold"><i class="fa-solid fa-pen"></i> æ–°å¢é€£çµ</label>
                            <div class="input-group mb-1">
                                <input type="text" class="form-control input-link" id="linkName" placeholder="åç¨± (å¦‚: ç›¸ç°¿)">
                            </div>
                            <div class="input-group">
                                <input type="url" class="form-control input-link" id="linkUrl" placeholder="https://..." oninput="checkUrlSafety(this.value)">
                                <button type="button" class="btn btn-sm btn-success" onclick="addLinkToLocal()"><i class="fa-solid fa-plus"></i> åŠ å…¥</button>
                            </div>
                            <div id="urlSafetyFeedback" class="mt-1"></div>
                        </div>
                        <div id="savedLinksContainer" style="display:none;">
                            <h6>å·²å­˜é€£çµåˆ—è¡¨</h6>
                            <div id="savedLinksList"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-secondary small fw-bold">é¡å‹</label>
                        <select class="form-select" id="eventType" onchange="toggleFormFields()"><option value="activity">ğŸ‰ æ´»å‹•</option><option value="person">ğŸ‘¤ äººå“¡åƒèˆ‡</option></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-secondary small fw-bold" id="nameLabel">æ´»å‹•åç¨±</label>
                        <input type="text" class="form-control" id="eventTitle" placeholder="è«‹è¼¸å…¥å…§å®¹..." required>
                    </div>
                    <div class="row mb-3">
                        <label class="form-label text-secondary small fw-bold">é–‹å§‹</label>
                        <div class="col-7"><input type="date" class="form-control" id="startDate" required onchange="syncDates()"></div>
                        <div class="col-5 time-field-group"><select class="form-select" id="startTime" onchange="syncTimes()"></select></div>
                    </div>
                    <div class="row mb-3">
                        <label class="form-label text-secondary small fw-bold">çµæŸ</label>
                        <div class="col-7"><input type="date" class="form-control" id="endDate" required></div>
                        <div class="col-5 time-field-group"><select class="form-select" id="endTime"></select></div>
                    </div>

                    <div class="mb-3" id="colorSection">
                        <label class="form-label text-secondary small fw-bold">æ¨™ç±¤é¡è‰²</label>
                        <div id="colorPalette" class="d-flex flex-wrap gap-2"></div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-secondary small fw-bold">é©—è­‰ç¢¼</label>
                        <div class="d-flex align-items-center">
                            <div id="captchaDisplay" class="captcha-box flex-grow-1"></div>
                            <i class="fa-solid fa-arrows-rotate refresh-icon" onclick="generateCaptcha()" title="æ›´æ›é©—è­‰ç¢¼"></i>
                        </div>
                        <input type="text" class="form-control mt-2" id="captchaInput" placeholder="è«‹è¼¸å…¥ä¸Šæ–¹æ•¸å­—" required>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-save-modal">å„²å­˜è³‡æ–™</button>
                        <button type="button" id="deleteBtn" class="btn btn-delete-modal" style="display:none;" onclick="confirmDelete()">åˆªé™¤æ­¤è³‡æ–™</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// ==========================================
// ğŸ—ï¸ ç³»çµ±æ¶æ§‹ (System Architecture) - v1.4
// ==========================================

// 1. Config: éœæ…‹è¨­å®šæª”
class Config {
    static get API_URL() { return 'https://script.google.com/macros/s/AKfycbwezycs59fxhwvksKUgWzByIj9a5bHRH2ByH0O7848HFxM7Ls2YjflGfqwx4okxROEE/exec'; }
    static get COLOR_ACTIVITY() { return '#F48FB1'; }
    static get COLORS_PERSON() { 
        return ['#AED581', '#81D4FA', '#9FA8DA', '#E6EE9C', '#FFCC80', '#B0BEC5', '#BCAAA4', '#80CBC4', '#CE93D8', '#FFF59D', '#90CAF9', '#CFD8DC'];
    }
}

// 2. DateUtils: æ—¥æœŸå·¥å…· (Pure Functions)
class DateUtils {
    static getLocalDateString(isoStr) {
        if (!isoStr) return '';
        const date = new Date(isoStr);
        const offset = date.getTimezoneOffset() * 60000;
        const localDate = new Date(date.getTime() - offset);
        return localDate.toISOString().split('T')[0];
    }

    static addDaysToDateString(dateStr, days) {
        const parts = dateStr.split('-');
        const y = parseInt(parts[0], 10);
        const m = parseInt(parts[1], 10) - 1;
        const d = parseInt(parts[2], 10);
        const tempDate = new Date(y, m, d);
        tempDate.setDate(tempDate.getDate() + days);
        const newY = tempDate.getFullYear();
        const newM = (tempDate.getMonth() + 1).toString().padStart(2, '0');
        const newD = tempDate.getDate().toString().padStart(2, '0');
        return `${newY}-${newM}-${newD}`;
    }

    static getTodayString() {
        return this.getLocalDateString(new Date().toISOString());
    }
}

// 3. APIService: é›²ç«¯æœå‹™å±¤ (ç„¡ UI)
class APIService {
    static async fetchEvents() {
        try {
            const res = await fetch(Config.API_URL);
            return await res.json();
        } catch (error) {
            console.error("Fetch Error:", error);
            throw error;
        }
    }

    static async saveEvent(data, action) {
        return fetch(Config.API_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ action: action, ...data })
        });
    }

    static async deleteEvent(id) {
        return fetch(Config.API_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ action: 'delete', id: id })
        });
    }

    static async sendReport(content) {
        return fetch(Config.API_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ action: 'send_report', content: content })
        });
    }
}

// 4. CaptchaSystem: é©—è­‰ç¢¼ç³»çµ± (Fixed Dynamic Element Binding)
class CaptchaSystem {
    constructor(displayId, inputId) {
        this.displayId = displayId;
        this.inputId = inputId;
        this.currentCode = "";
    }

    generate() {
        // Re-fetch elements every time to handle dynamic modals
        const displayEl = document.getElementById(this.displayId);
        const inputEl = document.getElementById(this.inputId);
        
        this.currentCode = Math.floor(1000 + Math.random() * 9000).toString();
        
        if (displayEl) displayEl.innerText = this.currentCode;
        if (inputEl) inputEl.value = '';
        
        return this.currentCode;
    }

    validate() {
        const inputEl = document.getElementById(this.inputId);
        if (!inputEl) return false;
        return inputEl.value === this.currentCode;
    }
}

// 5. LinkManager: é€£çµç®¡ç†é‚è¼¯
class LinkManager {
    constructor() {
        this.links = [];
        this.maxLinks = 3;
    }

    setLinks(links) {
        this.links = Array.isArray(links) ? links : [];
    }

    addLink(name, url) {
        if (this.links.length >= this.maxLinks) throw new Error('æ•¸é‡é™åˆ¶ï¼šæœ€å¤š 3 å€‹é€£çµ');
        if (!name || !url) throw new Error('è«‹è¼¸å…¥åç¨±èˆ‡ç¶²å€');
        this.links.push({ name, url });
    }

    removeLink(index) {
        if (index >= 0 && index < this.links.length) {
            this.links.splice(index, 1);
        }
    }

    getLinks() { return this.links; }
    getJson() { return JSON.stringify(this.links); }
    
    static checkSafety(url) {
        try {
            const u = new URL(url);
            return u.protocol === 'https:';
        } catch { return false; }
    }
}

// 6. EventManager: è³‡æ–™é‚è¼¯å±¤
class EventManager {
    constructor() {
        this.allEvents = [];
    }

    setEvents(rawData) {
        this.allEvents = [];
        if (rawData.result && rawData.result.startsWith("Error")) return [];
        
        rawData.forEach(item => {
            const type = item.type || (item.extendedProps && item.extendedProps.type) || 'person';
            const isActivity = (type === 'activity');
            const itemOrder = isActivity ? -1 : 10;
            
            this.allEvents.push({
                id: item.id,
                title: item.title,
                start: item.start,
                end: item.end,
                backgroundColor: item.backgroundColor,
                textColor: item.textColor,
                extendedProps: {
                    type: type,
                    order: itemOrder,
                    linkName: item.linkName || '',
                    linkUrl: item.linkUrl || ''
                },
                order: itemOrder,
                type: type
            });
        });
    }

    getExplodedEvents() {
        let exploded = [];
        this.allEvents.forEach(item => {
            if (!item.start) return;

            const isActivity = (item.type === 'activity');
            const startDateStr = DateUtils.getLocalDateString(item.start);
            let endDateStr = item.end ? DateUtils.getLocalDateString(item.end) : startDateStr;

            if (isActivity) endDateStr = DateUtils.addDaysToDateString(endDateStr, 1);

            let currentStr = startDateStr;
            let safetyLoop = 0;
            const originalStartTimestamp = new Date(item.start).getTime();

            while (currentStr < endDateStr) {
                if (safetyLoop++ > 365) break;

                const classList = ['hide-time-text'];
                if (isActivity) classList.push('event-type-activity');
                else classList.push('person-pill');

                exploded.push({
                    id: item.id,
                    title: item.title,
                    start: currentStr,
                    end: currentStr,
                    allDay: true,
                    backgroundColor: item.backgroundColor,
                    textColor: item.textColor,
                    extendedProps: item.extendedProps,
                    originalStart: originalStartTimestamp,
                    order: item.extendedProps.order,
                    classNames: classList
                });
                currentStr = DateUtils.addDaysToDateString(currentStr, 1);
            }
        });
        return exploded;
    }

    getUpcomingEvents() {
        const todayStr = DateUtils.getTodayString();
        return this.allEvents.filter(e => DateUtils.getLocalDateString(e.start) >= todayStr);
    }

    getHistoryEvents(year, type) {
        const todayStr = DateUtils.getTodayString();
        return this.allEvents.filter(e => {
            const dateStr = DateUtils.getLocalDateString(e.start);
            const y = dateStr.substring(0, 4);
            const eType = e.type || 'person';
            return y === year && (type === 'all' || eType === type) && (dateStr < todayStr);
        }).sort((a, b) => new Date(a.start) - new Date(b.start));
    }

    getYearsList() {
        const years = new Set(this.allEvents.map(e => DateUtils.getLocalDateString(e.start).substring(0, 4)));
        return Array.from(years).sort((a, b) => b - a);
    }

    findEventById(id) {
        return this.allEvents.find(e => e.id === id);
    }
}

// 7. UIManager: ä»‹é¢ç¸½ç®¡
class UIManager {
    constructor(app) {
        this.app = app;
        this.linkManager = new LinkManager();
        this.mainCaptcha = new CaptchaSystem('captchaDisplay', 'captchaInput');
        this.reportCaptcha = new CaptchaSystem('reportCaptchaDisplay', 'reportCaptchaInput');
        this.deleteLinkCaptcha = new CaptchaSystem('reportCaptchaDisplay', 'deleteLinkCaptchaInput'); 
        
        this.isEditingPastActivity = false;
        
        this.modalEl = new bootstrap.Modal(document.getElementById('eventModal'));
        this.bindEvents();
    }

    bindEvents() {
        document.getElementById('eventForm').addEventListener('submit', (e) => this.handleFormSubmit(e));
        
        const palette = document.getElementById('colorPalette');
        let html = '';
        Config.COLORS_PERSON.forEach((color, index) => {
            html += `<div class="color-swatch" style="background-color: ${color};" data-color="${color}" onclick="app.ui.selectColor('${color}')"></div>`;
        });
        palette.innerHTML = html;
    }

    renderDashboard() {
        const upcoming = this.app.eventManager.getUpcomingEvents();
        const listContainer = document.getElementById('upcomingList');
        
        if (upcoming.length === 0) {
            listContainer.innerHTML = '<div class="text-center text-muted py-4 small">è¿‘æœŸç„¡æ´»å‹•</div>';
        } else {
            const activities = upcoming.filter(e => e.type === 'activity').sort((a,b)=>new Date(a.start)-new Date(b.start));
            const people = upcoming.filter(e => e.type !== 'activity').sort((a,b)=>new Date(a.start)-new Date(b.start));
            
            let html = '';
            if (activities.length > 0) {
                html += `<div class="section-label">è¿‘æœŸæ´»å‹•</div>`;
                activities.forEach(e => {
                    const d = DateUtils.getLocalDateString(e.start);
                    const t = e.start.substring(11, 16);
                    html += `<button class="btn dashboard-btn btn-act" style="background:${e.backgroundColor};color:#333;" onclick="jumpToDate('${e.start}')"><div class="d-flex justify-content-between"><strong>${e.title}</strong><small>${d} ${t}</small></div></button>`;
                });
            }
            if (people.length > 0) {
                html += `<div class="section-label">è¿‘æœŸåƒèˆ‡äººå“¡</div><div class="d-block">`;
                people.forEach(e => {
                    const d = DateUtils.getLocalDateString(e.start);
                    html += `<button class="btn dashboard-btn btn-person" style="background:${e.backgroundColor};color:#333;" onclick="jumpToDate('${e.start}')">${d} ${e.title}</button>`;
                });
                html += `</div>`;
            }
            listContainer.innerHTML = html;
        }
        
        const years = this.app.eventManager.getYearsList();
        const sel = document.getElementById('searchYear');
        sel.innerHTML = '<option value="">é¸æ“‡å¹´ä»½...</option>';
        years.forEach(y => sel.innerHTML += `<option value="${y}">${y}å¹´</option>`);
    }

    renderHistoryResult() {
        const yVal = document.getElementById('searchYear').value;
        const tVal = document.getElementById('searchType').value;
        const resSel = document.getElementById('searchResult');
        resSel.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
        if(!yVal) return;

        const results = this.app.eventManager.getHistoryEvents(yVal, tVal);
        if(results.length === 0) { resSel.innerHTML = '<option value="">æŸ¥ç„¡è³‡æ–™</option>'; return; }
        
        results.forEach(e => {
            const d = DateUtils.getLocalDateString(e.start);
            resSel.innerHTML += `<option value="${e.start}">${d} - ${e.title}</option>`;
        });
    }

    openAddModal() {
        document.getElementById('eventForm').reset();
        document.getElementById('eventId').value = '';
        document.getElementById('modalTitle').innerText = 'æ–°å¢è³‡æ–™';
        document.getElementById('deleteBtn').style.display = 'none';
        
        this.isEditingPastActivity = false;
        this.linkManager.setLinks([]);
        document.getElementById('completedSection').style.display = 'none';
        document.getElementById('urlSafetyFeedback').innerHTML = '';

        const currentDate = this.app.calendar.getDate();
        const today = new Date();
        let targetDate = (currentDate.getMonth() === today.getMonth()) ? today : currentDate;
        const dStr = DateUtils.getLocalDateString(targetDate.toISOString());
        
        document.getElementById('startDate').value = dStr;
        document.getElementById('endDate').value = dStr;
        
        const r = 15 - (new Date().getMinutes() % 15);
        const now = new Date(); now.setMinutes(now.getMinutes() + r);
        const t = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        document.getElementById('startTime').value = t; 
        document.getElementById('endTime').value = t;

        this.mainCaptcha.generate();
        document.getElementById('selectedColor').value = ''; 
        this.toggleFormFields();
        this.modalEl.show();
    }

    openEditModal(fcEvent) {
        const e = this.app.eventManager.findEventById(fcEvent.id) || fcEvent;
        const props = e.extendedProps || {};
        const type = props.type || 'person';

        document.getElementById('eventId').value = e.id;
        document.getElementById('modalTitle').innerText = 'ç·¨è¼¯è³‡æ–™';
        document.getElementById('deleteBtn').style.display = 'block';
        document.getElementById('eventType').value = type;
        document.getElementById('eventTitle').value = e.title;

        if(e.backgroundColor) this.selectColor(e.backgroundColor);

        const todayStr = DateUtils.getTodayString();
        this.isEditingPastActivity = false;
        if (e.start && type === 'activity') {
            const endStr = e.end ? DateUtils.getLocalDateString(e.end) : DateUtils.getLocalDateString(e.start);
            if (endStr <= todayStr) this.isEditingPastActivity = true;
        }

        try {
            this.linkManager.setLinks(JSON.parse(props.linkUrl || '[]'));
        } catch {
            if(props.linkUrl && !props.linkUrl.startsWith('[')) {
                this.linkManager.setLinks([{name: props.linkName || 'é€£çµ', url: props.linkUrl}]);
            } else {
                this.linkManager.setLinks([]);
            }
        }
        document.getElementById('linkName').value = '';
        document.getElementById('linkUrl').value = '';
        document.getElementById('urlSafetyFeedback').innerHTML = '';

        this.toggleFormFields(); 

        if(e.start) {
            const sStr = DateUtils.getLocalDateString(e.start);
            document.getElementById('startDate').value = sStr;
            if (type === 'person') {
                const eStrRaw = e.end ? DateUtils.getLocalDateString(e.end) : sStr;
                const correctEnd = DateUtils.addDaysToDateString(eStrRaw, -1);
                document.getElementById('endDate').value = correctEnd;
            } else {
                document.getElementById('startTime').value = e.start.substring(11, 16);
                if(e.end) {
                    document.getElementById('endDate').value = DateUtils.getLocalDateString(e.end);
                    document.getElementById('endTime').value = e.end.substring(11, 16);
                }
            }
        }

        this.mainCaptcha.generate();
        this.modalEl.show();
    }

    toggleFormFields() {
        const type = document.getElementById('eventType').value;
        const colorSection = document.getElementById('colorSection');
        const completedSection = document.getElementById('completedSection');
        
        document.getElementById('nameLabel').innerText = type === 'activity' ? 'æ´»å‹•åç¨±' : 'åƒèˆ‡äººå§“å';
        document.querySelectorAll('.time-field-group').forEach(el => el.style.display = type === 'activity' ? 'block' : 'none');

        if (type === 'activity') {
            colorSection.style.display = 'none';
            document.getElementById('selectedColor').value = Config.COLOR_ACTIVITY;
            
            if (this.isEditingPastActivity) {
                completedSection.style.display = 'block';
                this.renderLinkList();
            } else {
                completedSection.style.display = 'none';
            }
        } else {
            colorSection.style.display = 'block';
            completedSection.style.display = 'none';
            
            if (!document.getElementById('eventId').value) {
                const lastColor = localStorage.getItem('lastPersonColor');
                const defaultColor = (lastColor && Config.COLORS_PERSON.includes(lastColor)) ? lastColor : Config.COLORS_PERSON[0];
                this.selectColor(defaultColor);
            }
        }
    }

    selectColor(color) {
        document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('selected'));
        const swatch = document.querySelector(`.color-swatch[data-color="${color}"]`);
        if (swatch) swatch.classList.add('selected');
        document.getElementById('selectedColor').value = color;
    }

    addLink() {
        try {
            const name = document.getElementById('linkName').value.trim();
            const url = document.getElementById('linkUrl').value.trim();
            this.linkManager.addLink(name, url);
            this.renderLinkList();
            document.getElementById('linkName').value = '';
            document.getElementById('linkUrl').value = '';
            document.getElementById('urlSafetyFeedback').innerHTML = '';
        } catch (e) {
            Swal.fire('æç¤º', e.message, 'warning');
        }
    }

    renderLinkList() {
        const list = document.getElementById('savedLinksList');
        const badge = document.getElementById('linkCountBadge');
        const links = this.linkManager.getLinks();
        
        badge.innerText = `${links.length}/3`;
        document.getElementById('savedLinksContainer').style.display = links.length ? 'block' : 'none';
        list.innerHTML = '';

        links.forEach((link, index) => {
            const isSafe = LinkManager.checkSafety(link.url);
            const badgeHtml = isSafe 
                ? '<span class="link-safety-badge badge-safe"><i class="fa-solid fa-lock"></i> å®‰å…¨</span>'
                : '<span class="link-safety-badge badge-unsafe"><i class="fa-solid fa-unlock"></i> ä¸å®‰å…¨</span>';
            
            const html = `
                <div class="saved-link-item">
                    <div class="saved-link-info">
                        <span class="saved-link-name">${link.name}</span>
                        <div><a href="${link.url}" target="_blank" class="saved-link-url">${link.url}</a>${badgeHtml}</div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger border-0 ms-2" onclick="app.ui.openDeleteLinkModal(${index})">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>`;
            list.insertAdjacentHTML('beforeend', html);
        });
    }

    checkUrlSafety(url) {
        const feedback = document.getElementById('urlSafetyFeedback');
        if (!url) { feedback.innerHTML = ''; return; }
        if (LinkManager.checkSafety(url)) {
            feedback.innerHTML = '<span class="text-success small fw-bold"><i class="fa-solid fa-circle-check me-1"></i>é€£çµæ ¼å¼å®‰å…¨ (HTTPS)</span>';
        } else {
            feedback.innerHTML = '<span class="text-warning small fw-bold"><i class="fa-solid fa-triangle-exclamation me-1"></i>éåŠ å¯† (HTTP) æˆ–æ ¼å¼æœ‰èª¤</span>';
        }
    }

    handleFormSubmit(e) {
        e.preventDefault();
        if (!this.mainCaptcha.validate()) { Swal.fire({ icon: 'error', title: 'é©—è­‰ç¢¼éŒ¯èª¤' }); return; }

        const pName = document.getElementById('linkName').value.trim();
        const pUrl = document.getElementById('linkUrl').value.trim();
        if (pName && pUrl) try { this.linkManager.addLink(pName, pUrl); } catch {}

        const id = document.getElementById('eventId').value;
        const type = document.getElementById('eventType').value;
        const sDate = document.getElementById('startDate').value;
        const eDate = document.getElementById('endDate').value;
        
        let startStr, endStr;
        if (type === 'activity') {
            startStr = `${sDate}T${document.getElementById('startTime').value}`;
            endStr = `${eDate}T${document.getElementById('endTime').value}`;
        } else {
            startStr = sDate;
            endStr = DateUtils.addDaysToDateString(eDate, 1);
        }

        const color = document.getElementById('selectedColor').value;
        if (type !== 'activity') localStorage.setItem('lastPersonColor', color);

        const data = {
            id: id || ('evt_' + Date.now()),
            title: document.getElementById('eventTitle').value,
            type: type, start: startStr, end: endStr,
            backgroundColor: color, textColor: '#333333',
            order: type === 'activity' ? -1 : 10,
            linkName: 'MultiLinks',
            linkUrl: this.linkManager.getJson()
        };

        this.app.saveEvent(data, id ? 'update' : 'create');
    }

    openDeleteLinkModal(index) {
        // Force regenerate immediately when opening modal
        const code = this.reportCaptcha.generate(); 
        
        Swal.fire({
            title: 'åˆªé™¤é€£çµç¢ºèª',
            html: `
                <p class="text-secondary mb-2">è«‹è¼¸å…¥é©—è­‰ç¢¼ä»¥åˆªé™¤æ­¤é€£çµ</p>
                <div class="d-flex align-items-center mb-2">
                    <div id="reportCaptchaDisplay" class="captcha-box flex-grow-1">${code}</div>
                    <i class="fa-solid fa-arrows-rotate refresh-icon" onclick="app.ui.reportCaptcha.generate()"></i>
                </div>
                <input type="text" id="deleteLinkCaptchaInput" class="form-control" placeholder="è«‹è¼¸å…¥ä¸Šæ–¹é©—è­‰ç¢¼">
            `,
            showCancelButton: true, confirmButtonText: 'ç¢ºèªåˆªé™¤', confirmButtonColor: '#d32f2f',
            didOpen: () => {
                // Re-bind captcha element inside Swal after it opens
                // But since we put code in HTML string, it displays correctly.
                // The generate() call inside onclick will work because CaptchaSystem now re-fetches elements.
            },
            preConfirm: () => {
                const input = document.getElementById('deleteLinkCaptchaInput').value;
                if (input !== this.reportCaptcha.currentCode) { Swal.showValidationMessage('é©—è­‰ç¢¼éŒ¯èª¤'); return false; }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                this.linkManager.removeLink(index);
                this.renderLinkList();
            }
        });
    }

    openReportModal() {
        const code = this.reportCaptcha.generate();
        Swal.fire({
            title: 'å›å ±å•é¡Œ',
            html: `
                <textarea id="reportText" class="form-control mb-3" rows="4" placeholder="è«‹æè¿°æ‚¨é‡åˆ°çš„éŒ¯èª¤æˆ–å»ºè­°..."></textarea>
                <div class="d-flex align-items-center mb-2">
                    <div id="reportCaptchaDisplay" class="captcha-box flex-grow-1">${code}</div>
                    <i class="fa-solid fa-arrows-rotate refresh-icon" onclick="app.ui.reportCaptcha.generate()"></i>
                </div>
                <input type="text" id="reportCaptchaInput" class="form-control" placeholder="è«‹è¼¸å…¥ä¸Šæ–¹é©—è­‰ç¢¼">
            `,
            showCancelButton: true, confirmButtonText: 'é€å‡ºå›å ±', confirmButtonColor: '#90A4AE',
            preConfirm: () => {
                const content = document.getElementById('reportText').value;
                const input = document.getElementById('reportCaptchaInput').value;
                if (!content) { Swal.showValidationMessage('è«‹è¼¸å…¥å›å ±å…§å®¹'); return false; }
                if (input !== this.reportCaptcha.currentCode) { Swal.showValidationMessage('é©—è­‰ç¢¼éŒ¯èª¤'); return false; }
                return content;
            }
        }).then((res) => {
            if (res.isConfirmed) this.app.sendReport(res.value);
        });
    }

    confirmDelete() {
        if (!this.mainCaptcha.validate()) { Swal.fire({icon:'error', title:'é©—è­‰ç¢¼éŒ¯èª¤'}); return; }
        Swal.fire({title:'ç¢ºå®šåˆªé™¤ï¼Ÿ', icon:'warning', showCancelButton:true, confirmButtonColor:'#ef9a9a', confirmButtonText:'åˆªé™¤'})
            .then(r => {
                if(r.isConfirmed) this.app.deleteEvent(document.getElementById('eventId').value);
            });
    }
}

// 8. App: ä¸»ç¨‹å¼å…¥å£
class App {
    constructor() {
        this.eventManager = new EventManager();
        this.ui = new UIManager(this);
        this.calendar = null;
    }

    init() {
        const opts = this.generateTimeOptions();
        document.getElementById('startTime').innerHTML = opts;
        document.getElementById('endTime').innerHTML = opts;
        this.initCalendar();
    }

    generateTimeOptions() {
        let opt=''; 
        for(let h=0;h<24;h++) for(let m=0;m<60;m+=15) { 
            let t = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`; 
            opt+=`<option value="${t}">${t}</option>`; 
        }
        return opt;
    }

    initCalendar() {
        const calendarEl = document.getElementById('calendar');
        this.calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'zh-tw',
            headerToolbar: { left: 'myToday', center: 'prev,title,next', right: 'dayGridMonth,timeGridWeek,listWeek' },
            buttonText: { month: 'æœˆ', week: 'é€±', list: 'åˆ—è¡¨' },
            customButtons: {
                myToday: {
                    text: 'ä»Šå¤©',
                    click: () => {
                        this.calendar.today();
                        this.ui.jumpToDate(DateUtils.getTodayString());
                    }
                }
            },
            eventDisplay: 'block',
            contentHeight: 'auto', 
            dayMaxEvents: 4, 
            fixedWeekCount: false,      
            eventOrder: 'order,originalStart,title', 
            navLinks: true,
            navLinkDayClick: (date) => this.jumpToDate(date),
            events: (info, success, fail) => this.fetchEventsWrapper(info, success, fail),
            eventClick: (info) => {
                if (info.view.type.includes('list')) this.jumpToDate(info.event.start);
                else this.ui.openEditModal(info.event);
            },
            eventTimeFormat: { hour: '2-digit', minute: '2-digit', meridiem: false, hour12: false }
        });
        this.calendar.render();
        this.ui.jumpToDate = (d) => this.jumpToDate(d);
    }

    fetchEventsWrapper(info, successCallback, failureCallback) {
        if (this.eventManager.allEvents.length === 0) {
            Swal.fire({ title: 'è³‡æ–™åŒæ­¥ä¸­...', didOpen: () => { Swal.showLoading() }, toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
        }
        
        APIService.fetchEvents()
            .then(data => {
                this.eventManager.setEvents(data);
                this.ui.renderDashboard();
                successCallback(this.eventManager.getExplodedEvents());
                Swal.close();
            })
            .catch(err => failureCallback(err));
    }

    saveEvent(data, action) {
        Swal.fire({title:'å„²å­˜ä¸­...', didOpen:()=>{Swal.showLoading()}});
        APIService.saveEvent(data, action)
            .then(() => {
                setTimeout(() => { 
                    Swal.fire({icon:'success', title:'å®Œæˆ', timer:1500, showConfirmButton:false}); 
                    this.calendar.refetchEvents(); 
                    this.ui.modalEl.hide(); 
                }, 2000);
            })
            .catch(() => Swal.fire('é€£ç·šç•°å¸¸','è«‹æª¢æŸ¥ç¶²è·¯','error'));
    }

    deleteEvent(id) {
        Swal.fire({title:'åˆªé™¤ä¸­...', didOpen:()=>{Swal.showLoading()}});
        APIService.deleteEvent(id)
            .then(() => {
                setTimeout(() => { 
                    Swal.fire('å·²åˆªé™¤','','success'); 
                    this.calendar.refetchEvents(); 
                    this.ui.modalEl.hide(); 
                }, 2000);
            });
    }

    sendReport(content) {
        Swal.fire({title:'å‚³é€ä¸­...', didOpen:()=>{Swal.showLoading()}});
        APIService.sendReport(content)
            .then(() => Swal.fire('å·²å›å ±', 'æ„Ÿè¬æ‚¨çš„å›é¥‹', 'success'))
            .catch(() => Swal.fire('å¤±æ•—', 'è«‹ç¨å¾Œå†è©¦', 'error'));
    }

    jumpToDate(dateVal) {
        this.calendar.changeView('dayGridMonth', dateVal);
        document.getElementById('calendar').scrollIntoView({behavior:'smooth'});
        const targetStr = typeof dateVal === 'string' ? DateUtils.getLocalDateString(dateVal) : DateUtils.getLocalDateString(dateVal.toISOString());
        
        setTimeout(() => {
            document.querySelectorAll('.highlight-target-day').forEach(el => el.classList.remove('highlight-target-day'));
            const targetEl = document.querySelector(`.fc-daygrid-day[data-date="${targetStr}"]`);
            if (targetEl) {
                targetEl.classList.add('highlight-target-day');
                targetEl.scrollIntoView({behavior: "smooth", block: "center", inline: "center"});
            }
        }, 200);
    }
}

// ==========================================
// ğŸš€ å•Ÿå‹• & Global Bridge (ç‚ºäº† HTML ç›¸å®¹æ€§)
// ==========================================
let app; // Declare global variable

document.addEventListener('DOMContentLoaded', () => {
    // Initialize App only after DOM is ready
    app = new App();
    app.init();
});

// Bridge functions for HTML onclick attributes
window.openAddModal = () => app.ui.openAddModal();
window.openReportModal = () => app.ui.openReportModal();
window.jumpToDate = (d) => app.jumpToDate(d);
window.jumpToSelectedEvent = () => {
    const val = document.getElementById('searchResult').value;
    if(val) app.jumpToDate(val);
    else Swal.fire({icon:'info', title:'æç¤º', text:'è«‹å…ˆé¸æ“‡ä¸€å€‹æœå°‹çµæœ'});
};
window.filterHistoryResult = () => app.ui.renderHistoryResult();
window.generateCaptcha = () => app.ui.mainCaptcha.generate();
window.refreshReportCaptcha = () => app.ui.reportCaptcha.generate();
window.confirmDelete = () => app.ui.confirmDelete();
window.addLinkToLocal = () => app.ui.addLink();
window.checkUrlSafety = (v) => app.ui.checkUrlSafety(v);
window.syncDates = () => {
    const s = document.getElementById('startDate').value;
    const e = document.getElementById('endDate');
    if(!e.value || e.value < s) e.value = s;
};
window.syncTimes = () => {
    const sDate = document.getElementById('startDate').value;
    const eDate = document.getElementById('endDate').value;
    if (sDate === eDate) {
        const sTime = document.getElementById('startTime').value;
        const eTime = document.getElementById('endTime');
        if(eTime.value < sTime) eTime.value = sTime;
    }
};
window.toggleFormFields = () => app.ui.toggleFormFields();
window.openDeleteLinkCaptchaModal = (idx) => app.ui.openDeleteLinkModal(idx);

</script>
</body>
</html>