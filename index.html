<!-- v2.54 | Fix: Resolve Link Data Mapping Issue (Deep Access) | 2025-12-02 -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³°åœ‹å¤©èŒ‚ä½›å ‚_å…±åŒè¡Œäº‹æ›† (v2.54)</title>
    
    <!-- æ ¸å¿ƒå¥—ä»¶ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* =========================================
           ğŸµ æº«æ½¤æ—¥ç³»é¢¨æ ¼ (Warm & Cozy Style) - v2.32 Base
           ========================================= */
        :root {
            --bg-color: #FDFCF5;    
            --card-bg: #FFFFFF;    
            --text-primary: #5D4037;    
            --text-secondary: #8D6E63;
            --border-color: #EFEBE9;    
            --accent-color: #8D6E63;    /* æš–è¤è‰² (ä¸€èˆ¬æŒ‰éˆ•) */
            --primary-action: #a3daff; /* äº®è—è‰² (æ–°å¢æŒ‰éˆ•) */
            --border-radius: 10px;    
        }

        body {    
            background-color: var(--bg-color);
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;    
            color: var(--text-primary);
            overscroll-behavior-y: none;    
        }
        
        .container { max-width: 1200px; margin-top: 40px; margin-bottom: 40px; }
        
        h2 {    
            font-weight: 700;    
            color: var(--text-primary);    
            letter-spacing: 1.5px;    
            font-size: 1.8rem;
            border-bottom: 3px solid #D7CCC8;
            display: inline-block;
            padding-bottom: 5px;
        }
        
        #calendar {    
            background: var(--card-bg);
            padding: 25px;    
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(141, 110, 99, 0.08);
            border: 1px solid var(--border-color);
        }

        /* --------------------------------------
           [v2.13 Fix] å…¨åŸŸç§»é™¤è¡Œäº‹æ›†é€£çµåº•ç·š
           -------------------------------------- */
        #calendar a {
            text-decoration: none !important;
            color: inherit;    
        }
        
        .fc-daygrid-day-number,
        .fc-col-header-cell-cushion {
            text-decoration: none !important;
            color: var(--text-secondary) !important;
        }
        
        .fc-daygrid-day-number:hover,
        .fc-col-header-cell-cushion:hover {
            text-decoration: none !important;
            color: var(--text-primary) !important;
        }

        /* --------------------------------------
           æŒ‰éˆ•èˆ‡æ¨™é¡Œæ¨£å¼
           -------------------------------------- */
        .fc-button-primary {
            background-color: transparent !important;    
            border: 1px solid var(--accent-color) !important;    
            color: var(--text-secondary) !important;    
            
            border-radius: 4px !important;    
            padding: 0px 6px !important;    
            font-size: 0.8rem !important;
            box-shadow: none !important;    
            font-weight: 600 !important;
            transition: all 0.2s ease !important;
            line-height: 1.8 !important;    
            height: 28px !important;        
            margin: 0 1px !important;
        }
        
        .fc-button-primary.fc-button-active,    
        .fc-button-primary:active {
            background-color: var(--accent-color) !important;
            color: #ffffff !important;
            box-shadow: none !important;
        }

        .fc-button-primary:hover {
            background-color: rgba(141, 110, 99, 0.1) !important;
            color: var(--text-primary) !important;
            transform: translateY(-1px);
        }
        
        .fc-button-primary.fc-button-active:hover {
            background-color: var(--text-primary) !important;
            color: #ffffff !important;
        }
        
        .fc-button-primary:focus { box-shadow: none !important; }
        
        .fc-icon { font-size: 0.9rem !important; vertical-align: middle; }
        
        /* [v2.21 Update] Increase space around title (prev/title/next) */
        .fc-toolbar-title { 
            font-size: 1.4rem !important; 
            color: var(--text-primary); 
            font-weight: 700;
            margin: 0 20px !important; /* å¢åŠ å·¦å³é–“è· */
        }
        
        /* [v2.21 New] Add margin between button chunks for desktop */
        .fc-toolbar-chunk:nth-child(1) {
            margin-right: 20px;
        }

        /* --------------------------------------
           äº‹ä»¶èˆ‡æ ¼å­æ¨£å¼
           -------------------------------------- */
        
        /* 1. é›»è…¦ç‰ˆè¨­å®š */
        @media (min-width: 768px) {
            .fc-daygrid-day-frame {
                height: 120px !important;    
                min-height: 120px !important;
                max-height: 120px !important;
                overflow: hidden;    
                position: relative;    
            }
            
            .fc-event {    
                cursor: pointer; border: none !important;    
                box-shadow: 0 1px 1px rgba(93, 64, 55, 0.1);    
                font-size: 0.8rem;    
                margin-bottom: 1px !important;    
                margin-top: 0 !important;
                border-radius: 3px !important;    
                padding: 0 4px !important;        
                line-height: 1.2 !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                display: block !important;
            }
        }

        /* [v2.18] More Link å®šä½ï¼šå›æ­¸è‡ªç„¶æµï¼Œä½†é å·¦ä¸Šæ–¹ */
        .fc-daygrid-more-link {
            position: relative !important;    
            display: inline-block !important; /* æ”¹ç‚º inline-block ç¢ºä¿ä¸ä½”ç”¨æ•´è¡Œå¯¬åº¦ */
            width: auto;
            text-align: left;
            margin-top: 1px !important;
            margin-left: 2px; /* ç¨å¾®æ¨é–‹ */
            z-index: 10;
            background-color: transparent; /* ä¸å†éœ€è¦é®ç½© */
        }

        .fc-event-main {
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            display: block !important;
        }

        /* [v2.17] Activity Color Class Updated */
        .event-type-activity {    
            background-color: #ffe9f3; /* Lighter Macaron Pink */
            border-left: 4px solid #fa436b !important; /* Dark Pink Border */
            color: #5D4037 !important;    
            font-weight: bold;    
            width: 100% !important;    
            display: block !important;    
            margin-bottom: 2px !important;    
        }

        /* More Link æ–‡å­—æ¨£å¼ */
        .fc-more-link {
            color: var(--text-secondary) !important;
            font-size: 0.75rem;
            font-weight: 700;
            text-decoration: none !important;
            display: inline-block;
            opacity: 0.9;
            width: 100%;
        }
        .fc-more-link:hover { color: var(--text-primary) !important; opacity: 1; background-color: rgba(0,0,0,0.03); }

        /* =========================================
           ğŸ“± æ‰‹æ©Ÿç‰ˆ RWD ç´°ç¯€
           ========================================= */
        @media (max-width: 767.98px) {
            body { background-color: #FFFFFF; }    
            .container { max-width: 100%; margin: 0; padding: 0; overflow-x: hidden; }
            
            /* é€šç”¨æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•å£“ç¸® */
            .fc-toolbar-chunk { display: flex; align-items: center; gap: 1px; } 
            .fc-toolbar-title { font-size: 0.9rem !important; margin: 0 3px !important; white-space: nowrap; }
            .fc-button {    
                padding: 0px 3px !important;
                font-size: 0.65rem !important;
                height: 22px !important;
                line-height: 22px !important;
            }

            /* [v2.34 New] SCENARIO 1: Month View (One Line) */
            /* Using data-attribute selector set by JS */
            #calendar[data-current-view="dayGridMonth"] .fc-header-toolbar {
                display: flex !important;
                flex-wrap: nowrap !important; /* Force single line */
                align-items: center !important;
                justify-content: space-between !important;
                gap: 0px !important;
                margin-bottom: 5px !important;
            }
            
            /* [v2.34 New] SCENARIO 2: Week & List View (Two Lines, Date Centered) */
            #calendar[data-current-view="timeGridWeek"] .fc-header-toolbar,
            #calendar[data-current-view="listWeek"] .fc-header-toolbar {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 4px !important;
            }

            /* Line 1: Date Navigation (Center) */
            #calendar[data-current-view="timeGridWeek"] .fc-toolbar-chunk:nth-child(2),
            #calendar[data-current-view="listWeek"] .fc-toolbar-chunk:nth-child(2) {
                order: 1;
                width: 100%;
                display: flex;
                justify-content: center !important; /* Center the date title */
            }

            /* Line 2: Left (Today) & Right (Views) */
            #calendar[data-current-view="timeGridWeek"] .fc-toolbar-chunk:nth-child(1),
            #calendar[data-current-view="listWeek"] .fc-toolbar-chunk:nth-child(1) {
                order: 2;
            }
            #calendar[data-current-view="timeGridWeek"] .fc-toolbar-chunk:nth-child(3),
            #calendar[data-current-view="listWeek"] .fc-toolbar-chunk:nth-child(3) {
                order: 3;
                margin-left: auto; /* Push to right */
            }

            #stickyHeader {
                padding: 8px 15px;
                background-color: #fff;
                position: sticky;
                top: 0;
                z-index: 100;
                border-bottom: 1px solid #eee;
                margin-bottom: 0 !important;
            }
            h2 { font-size: 1.1rem; margin: 0; border: none; padding: 0; }
            
            #calendar { padding: 0; border: none; border-radius: 0; box-shadow: none; margin-bottom: 10px !important; }
            
            /* æ ¼å­é«˜åº¦ç”± JS æ§åˆ¶ */
            .fc-daygrid-day-frame {    
                overflow: hidden;    
                position: relative;
            }    
            
            .fc-daygrid-day-top {    
                flex-direction: row;    
                padding: 0px 2px !important;    
                margin-bottom: 0 !important;
                height: 18px !important;    
                min-height: 18px !important;
            }
            .fc-daygrid-day-number {    
                font-size: 0.7rem !important;    
                color: #999;    
                padding: 0 !important;    
                line-height: 18px !important;
                margin: 0 !important;
            }
            .fc-col-header-cell { padding: 2px 0; font-size: 0.75rem; }
            .fc-daygrid-day-events { margin-top: 0 !important; margin-bottom: 0 !important; display: block !important; }
            
            .fc-event {
                cursor: pointer; border: none !important;    
                box-shadow: 0 1px 1px rgba(93, 64, 55, 0.1);    
                font-size: 0.65rem !important;    
                padding: 0px 2px !important;        
                border-radius: 2px !important;
                margin: 0px 0 1px 0 !important;    
                line-height: 1.1 !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                display: block !important;
            }
            .fc-event.event-type-activity { border-left: 4px solid #fa436b !important; }
            .fc-more-link { font-size: 0.7rem; margin-top: 0; display: block !important; text-align: left; padding-left: 2px; background-color: transparent; }

            .dashboard-card { border: none; padding: 15px; margin: 0; border-radius: 0; border-top: 1px solid #eee; }
            .dashboard-btn { border: none !important; border-radius: 4px !important; padding: 4px 8px !important; margin-bottom: 4px !important; font-size: 0.8rem !important; box-shadow: none !important; }
            .btn-act { width: 100% !important; display: block; text-align: left; }
            .btn-act div { display: flex; justify-content: space-between; align-items: center; }
            
            .btn-custom-add {
                position: fixed; bottom: 30px; right: 20px; width: 50px; height: 50px;
                border-radius: 50%; padding: 0; display: flex; align-items: center; justify-content: center;
                z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 0 !important;
                background-color: var(--primary-action);
                color: #333 !important;    
            }
            .btn-custom-add i { font-size: 1.4rem !important; margin: 0 !important; display: block !important; }
            
            /* [v2.32 Update] Desktop/Global: Justify space-between for Left(Buttons) & Right(Version) */
            .report-bug-container {    
                justify-content: space-between !important;    
                padding-left: 20px;    
                padding-bottom: 40px;    
                margin-top: 5px;    
                display: flex; /* Ensure items are inline */
                align-items: center;
                gap: 10px; 
            }
            .btn-report-bug { background-color: #f0f0f0; color: #999; font-size: 0.75rem; padding: 4px 12px; box-shadow: none; border: 1px solid #ddd; }
        }

        /* --------------------------------------
           é€šç”¨ç´°ç¯€
           -------------------------------------- */
        @keyframes flash-highlight {
            0% { background-color: rgba(255, 235, 59, 0.8); box-shadow: inset 0 0 20px rgba(255, 215, 0, 0.6); }
            100% { background-color: transparent; box-shadow: none; }
        }
        .highlight-target-day { animation: flash-highlight 2.5s ease-out; position: relative; z-index: 10; }
        
        .person-pill { display: inline-block !important; width: auto !important; margin-right: 4px !important; white-space: nowrap; font-weight: 500; color: #5D4037 !important; background-color: var(--event-color, #eee); }
        .event-type-activity { background-color: #F8BBD0; border-left: 4px solid #EC407A !important; color: #5D4037 !important; font-weight: bold; width: 100% !important; display: block !important; margin-bottom: 2px !important; }
        .hide-time-text .fc-event-time { display: none !important; }
        .fc-daygrid-day-events { display: flex !important; flex-wrap: wrap !important; align-content: flex-start !important; gap: 1px !important; padding: 0 2px !important; margin-top: 0 !important; }
        .fc-daygrid-event-harness { width: auto !important; max-width: 100%; }
        .fc-daygrid-event-harness:has(.event-type-activity) { width: 100% !important; flex-basis: 100% !important; }

        .btn-custom-add { background-color: var(--primary-action); color: #333; border-radius: var(--border-radius); padding: 10px 30px; border: none; box-shadow: 0 3px 10px rgba(163, 218, 255, 0.4); transition: all 0.2s; font-weight: 600; letter-spacing: 1px; }
        .btn-custom-add:hover { background-color: #81D4FA; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(163, 218, 255, 0.6); color: #333;}

        .btn-report-bug { background-color: #90A4AE; color: white; padding: 8px 20px; border-radius: 30px; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 0.95rem; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.3s; }
        .btn-report-bug:hover { background-color: #78909C; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        
        /* [v2.31 New] Share Button Style */
        .btn-share { 
            background-color: #4DB6AC; /* Teal/Share color */
            color: white; 
            padding: 8px 20px; 
            border-radius: 30px; 
            border: none; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            font-size: 0.95rem; 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            transition: all 0.3s; 
        }
        .btn-share:hover { 
            background-color: #26A69A; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); 
        }

        /* [v2.32 Update] Desktop/Global: Justify space-between for Left(Buttons) & Right(Version) */
        .report-bug-container { 
            display: flex; 
            justify-content: space-between; 
            margin-top: 20px; 
            padding-bottom: 20px; 
            width: 100%; 
            align-items: center;
            gap: 10px; 
        }
        
        /* [v2.21 New] Version Display Style: Smaller and Lighter */
        #appVersionDisplay {
            font-size: 0.75rem !important;
            color: #BCAAA4 !important; /* Lighter color (same as refresh icon) */
            font-weight: 500 !important;
        }

        /* [v2.22 New] Person Date Text Style (R2) */
        .person-date-text {
            font-size: 0.75rem; /* Smaller font for date/time */
            color: var(--text-secondary) !important; /* Lighter color */
            font-weight: 500 !important;
            margin-left: 10px; /* Separator space */
        }
        
        /* [v2.23 New] Narrow Pill Style for Upcoming People (Fix for R2 Width issue) */
        .btn-person-pill {
            display: inline-flex !important; /* Use inline-flex for pill shape & inner alignment */
            width: auto !important; /* Restore auto width for pill shape */
            padding: 6px 12px !important; /* Tighter padding for pill */
            margin-right: 6px !important;
            margin-bottom: 8px !important; /* Spacing below the pill */
            border-radius: 15px !important; /* Rounded pill corners */
            justify-content: space-between; /* Space out name and date */
            align-items: center; /* Vertical alignment */
        }

        .dashboard-card { background: #fff; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 20px; height: 100%; box-shadow: 0 4px 15px rgba(141, 110, 99, 0.05); }
        .card-history { background-color: #FAFAFA; border-top: 5px solid #AED581; }
        .card-upcoming { background-color: #FAFAFA; border-top: 5px solid #FFD54F; }
        .dashboard-title { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid #EFEBE9; }
        .upcoming-list-container { max-height: 400px; overflow-y: auto; padding-right: 8px; }
        .upcoming-list-container::-webkit-scrollbar { width: 5px; }
        .upcoming-list-container::-webkit-scrollbar-thumb { background-color: #D7CCC8; border-radius: 10px; }
        
        .dashboard-btn { border: none; font-size: 0.9rem; box-shadow: 0 1px 3px rgba(141, 110, 99, 0.1); transition: 0.2s; position: relative; border-radius: 6px; }
        .dashboard-btn:hover { transform: translateY(-1px); opacity: 0.95; }
        
        .btn-act { 
            width: 100%; 
            text-align: left; 
            padding: 8px 15px; 
            margin-bottom: 8px; 
            border-left: 4px solid transparent; 
        }
        /* .btn-act div is used for flex layout in JS rendering */
        .btn-act div {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        
        /* Removed .btn-person style as it conflicted with desired pill style */


        .section-label { font-size: 0.85rem; color: #A1887F; margin-top: 10px; margin-bottom: 5px; font-weight: 700; letter-spacing: 1px; border-left: 3px solid #D7CCC8; padding-left: 8px; }

        .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.2s; display: inline-block; }
        .color-swatch:hover { transform: scale(1.15); }
        .color-swatch.selected { border-color: #8D6E63; transform: scale(1.1); box-shadow: 0 0 0 2px #D7CCC8; }
        .modal-content { border-radius: 15px; border: none; box-shadow: 0 10px 40px rgba(141, 110, 99, 0.15); }
        .modal-header { background-color: #FFF8E1; border-radius: 15px 15px 0 0; border-bottom: 1px solid #FFE0B2; }
        .modal-title { color: #5D4037; font-weight: bold; letter-spacing: 1px; }
        .captcha-box { background: #FFF3E0; color: #5D4037; font-size: 24px; font-weight: bold; letter-spacing: 6px; text-align: center; padding: 8px; border-radius: var(--border-radius); user-select: none; border: 2px dashed #FFCC80; }
        .refresh-icon { cursor: pointer; color: #BCAAA4; transition: 0.3s; font-size: 1.2rem; margin-left: 15px; margin-top: 5px; }
        .refresh-icon:hover { color: #8D6E63; transform: rotate(180deg); }
        #completedSection { background-color: #F1F8E9; border: 1px solid #C5E1A5; border-radius: 12px; margin-bottom: 20px; }
        .completed-badge { color: #558B2F; font-weight: bold; font-size: 0.95rem; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .input-link { background-color: #fff !important; }
        #addLinkContainer { padding-bottom: 15px; border-bottom: 1px dashed #C5E1A5; margin-bottom: 10px; }
        #savedLinksContainer h6 { color: #33691E; font-weight: bold; font-size: 0.9rem; margin-bottom: 10px; }
        .saved-link-item { background-color: #FFFFFF; border: 1px solid #AED581; border-radius: 8px; padding: 8px 12px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .saved-link-info { flex-grow: 1; overflow: hidden; }
        .saved-link-name { font-weight: bold; color: #558B2F; font-size: 0.9rem; display: block; }
        .saved-link-url { color: #0277BD; font-size: 0.85rem; text-decoration: none; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .saved-link-url:hover { text-decoration: underline; }
        .link-safety-badge { font-size: 0.75rem; margin-left: 5px; padding: 1px 5px; border-radius: 4px; vertical-align: middle; }
        .badge-safe { background-color: #E8F5E9; color: #2E7D32; border: 1px solid #A5D6A7; }
        .badge-unsafe { background-color: #FFEBEE; color: #C62828; border: 1px solid #EF9A9A; }
        .btn-save-modal { background-color: var(--primary-action); color: #333; border: none; border-radius: 8px; box-shadow: 0 3px 8px rgba(79, 195, 247, 0.3); transition: all 0.2s; font-weight: 600; }
        .btn-save-modal:hover { background-color: #29B6F6; transform: translateY(-2px); box-shadow: 0 5px 12px rgba(79, 195, 247, 0.5); color: #333; }
        .btn-delete-modal { border: 1px solid #ef9a9a; color: #d32f2f; background-color: transparent; border-radius: 8px; transition: all 0.2s; font-weight: 600; }
        .btn-delete-modal:hover { background-color: #ef9a9a; color: white !important; box-shadow: 0 3px 8px rgba(239, 154, 154, 0.4); transform: translateY(-1px); }
    </style>
</head>
<body>

<div class="container">
    <div id="stickyHeader" class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h2><i class="fa-solid fa-calendar-days me-2" style="color: #A1887F;"></i>æ³°åœ‹å¤©èŒ‚ä½›å ‚_å…±åŒè¡Œäº‹æ›†</h2>
        <button class="btn btn-custom-add" onclick="openAddModal()">
            <i class="fa-solid fa-plus me-1"></i> æ–°å¢è³‡æ–™
        </button>
    </div>
    
    <div id="calendar" class="mb-5"></div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="dashboard-card card-history">
                <div class="dashboard-title"><i class="fa-solid fa-clock-rotate-left me-2 text-secondary"></i>æ­·å²ç´€éŒ„æŸ¥è©¢</div>
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label text-muted small">å¹´ä»½</label>
                        <select class="form-select form-select-sm" id="searchYear" onchange="filterHistoryResult()"><option value="">é¸æ“‡å¹´ä»½...</option></select>
                    </div>
                    <div class="col-6">
                        <label class="form-label text-muted small">é¡å‹</label>
                        <select class="form-select form-select-sm" id="searchType" onchange="filterHistoryResult()"><option value="all">å…¨éƒ¨</option><option value="activity">æ´»å‹•</option><option value="person">äººå“¡åƒèˆ‡</option></select>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label text-muted small">æœå°‹çµæœ</label>
                    <select class="form-select" id="searchResult"><option value="">è«‹å…ˆé¸æ“‡å¹´ä»½èˆ‡é¡å‹...</option></select>
                </div>
                <div class="d-grid">
                    <button class="btn btn-secondary btn-sm" onclick="jumpToSelectedEvent()" style="background-color: #8D6E63; border:none; border-radius: 8px;">å‰å¾€è©²æœˆä»½ <i class="fa-solid fa-arrow-right ms-1"></i></button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="dashboard-card card-upcoming">
                <div class="dashboard-title"><i class="fa-regular fa-calendar-plus me-2 text-secondary"></i>å³å°‡åˆ°ä¾†</div>
                <div class="upcoming-list-container" id="upcomingList"><div class="text-center text-muted py-4">è®€å–ä¸­...</div></div>
            </div>
        </div>
    </div>

    <!-- å›å ±æŒ‰éˆ• (ç§»è‡³åº•éƒ¨å›ºå®šæµ - é å·¦) -->
    <div class="report-bug-container">
        <!-- [v2.32 New Layout] Left side: Report & Share -->
        <div class="d-flex align-items-center gap-2">
            <button class="btn-report-bug" onclick="openReportModal()">
                <i class="fa-solid fa-bug"></i> å›å ±å•é¡Œ
            </button>
            <button class="btn-share" onclick="openShareModal()">
                <i class="fa-solid fa-share-nodes"></i> åˆ†äº«
            </button>
        </div>
        <!-- Right side: Version -->
        <span id="appVersionDisplay" class="text-secondary small fw-bold"></span>
    </div>
</div>

<!-- Modal å€å¡Š (é‚è¼¯ç”± UIManager æ§åˆ¶) -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">æ–°å¢è³‡æ–™</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <!-- [v2.48 New] Add to Calendar Button Container (Hidden by default) -->
                <div id="addToCalendarContainer" class="mb-3 text-center" style="display:none;">
                    <a id="btnAddToGoogle" href="#" target="_blank" class="btn btn-outline-primary w-100">
                        <i class="fa-brands fa-google me-2"></i>åŠ å…¥ Google è¡Œäº‹æ›†
                    </a>
                    <hr class="text-muted my-3">
                </div>

                <form id="eventForm">
                    <input type="hidden" id="eventId">
                    <input type="hidden" id="selectedColor">

                    <div id="completedSection" class="p-3 mb-4" style="display: none;">
                        <div class="completed-badge"><i class="fa-solid fa-circle-check"></i> æ´»å‹•å·²å®Œæˆ - ç´€éŒ„åˆ†äº« <span id="linkCountBadge" class="ms-2 badge rounded-pill bg-secondary" style="font-size:0.7rem;">0/3</span></div>
                        <div id="addLinkContainer">
                            <label class="form-label small text-secondary mb-1 fw-bold"><i class="fa-solid fa-pen"></i> æ–°å¢é€£çµ</label>
                            <div class="input-group mb-1">
                                <input type="text" class="form-control input-link" id="linkName" placeholder="åç¨± (å¦‚: ç›¸ç°¿)">
                            </div>
                            <div class="input-group">
                                <input type="url" class="form-control input-link" id="linkUrl" placeholder="https://..." oninput="checkUrlSafety(this.value)">
                                <button type="button" class="btn btn-sm btn-success" onclick="addLinkToLocal()"><i class="fa-solid fa-plus"></i> åŠ å…¥</button>
                            </div>
                            <div id="urlSafetyFeedback" class="mt-1"></div>
                        </div>
                        <div id="savedLinksContainer" style="display:none;">
                            <h6>å·²å­˜é€£çµåˆ—è¡¨</h6>
                            <div id="savedLinksList"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-secondary small fw-bold">é¡å‹</label>
                        <select class="form-select" id="eventType" onchange="toggleFormFields()"><option value="activity">ğŸ‰ æ´»å‹•</option><option value="person">ğŸ‘¤ äººå“¡åƒèˆ‡</option></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-secondary small fw-bold" id="nameLabel">æ´»å‹•åç¨±</label>
                        <input type="text" class="form-control" id="eventTitle" placeholder="è«‹è¼¸å…¥å…§å®¹..." required>
                    </div>
                    <div class="row mb-3">
                        <label class="form-label text-secondary small fw-bold">é–‹å§‹</label>
                        <!-- [v2.30 Change]: Use bridge function to handle UX logic -->
                        <div class="col-7"><input type="date" class="form-control" id="startDate" required onchange="handleStartChange()"></div>
                        <div class="col-5 time-field-group"><select class="form-select" id="startTime" onchange="syncTimes(); updateTimezoneHint();"></select></div>
                    </div>
                    <div class="row mb-3">
                        <label class="form-label text-secondary small fw-bold">çµæŸ</label>
                        <div class="col-7"><input type="date" class="form-control" id="endDate" required></div>
                        <div class="col-5 time-field-group"><select class="form-select" id="endTime"></select></div>
                    </div>

                    <!-- [v2.42 New] Timezone Selector Block -->
                    <div class="mb-3 time-field-group">
                        <label class="form-label text-secondary small fw-bold">æ™‚å€é¸æ“‡</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="eventTimezone" id="tzTaiwan" value="TW" checked onchange="updateTimezoneHint()">
                                <label class="form-check-label" for="tzTaiwan">ğŸ‡¹ğŸ‡¼ å°ç£æ™‚é–“</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="eventTimezone" id="tzThai" value="TH" onchange="updateTimezoneHint()">
                                <label class="form-check-label" for="tzThai">ğŸ‡¹ğŸ‡­ æ³°åœ‹æ™‚é–“</label>
                            </div>
                        </div>
                        <div id="timezoneHint" class="form-text text-primary" style="display:none; font-size: 0.8rem; margin-top: 5px;">
                            <i class="fa-solid fa-circle-info me-1"></i>å°‡è‡ªå‹•è½‰æ›ä¸¦é¡¯ç¤ºç‚ºå°ç£æ™‚é–“ <span id="convertedTimeDisplay" class="fw-bold"></span>
                        </div>
                    </div>

                    <div class="mb-3" id="colorSection">
                        <label class="form-label text-secondary small fw-bold">æ¨™ç±¤é¡è‰²</label>
                        <div id="colorPalette" class="d-flex flex-wrap gap-2"></div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-secondary small fw-bold">é©—è­‰ç¢¼</label>
                        <div class="d-flex align-items-center">
                            <div id="captchaDisplay" class="captcha-box flex-grow-1"></div>
                            <i class="fa-solid fa-arrows-rotate refresh-icon" onclick="generateCaptcha()" title="æ›´æ›é©—è­‰ç¢¼"></i>
                        </div>
                        <input type="text" class="form-control mt-2" id="captchaInput" placeholder="è«‹è¼¸å…¥ä¸Šæ–¹æ•¸å­—" required>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-save-modal">å„²å­˜è³‡æ–™</button>
                        <button type="button" id="deleteBtn" class="btn btn-delete-modal" style="display:none;" onclick="confirmDelete()">åˆªé™¤æ­¤è³‡æ–™</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// ==========================================
// ğŸ—ï¸ ç³»çµ±æ¶æ§‹ (System Architecture) - v2.54
// ==========================================

// 1. Config: éœæ…‹è¨­å®šæª”
class Config {
    static get API_URL() { return 'https://script.google.com/macros/s/AKfycbwezycs59fxhwvksKUgWzByIj9a5bHRH2ByH0O7848HFxM7Ls2YjflGfqwx4okxROEE/exec'; }
    // [v2.52] Add API Secret (Must match GAS)
    // [v2.53] Moved API Secret here for easier configuration
    static get API_SECRET() { return 'TianMao2025_SecretKey'; } 

    // [v2.54 Update] Application Version
    static get VERSION() { return 'v2.54'; } 
    // [v2.18] Updated Activity Color to Lighter Macaron Pink (#ffe9f3)
    static get COLOR_ACTIVITY() { return '#ffe9f3'; }    
    // [v2.12] Macaron / Pastel Palette
    static get COLORS_PERSON() {    
        return [
            '#DCEDC8', // Light Green
            '#B3E5FC', // Light Blue
            '#C5CAE9', // Indigo
            '#F0F4C3', // Lime
            '#FFE0B2', // Orange
            '#E0E0E0', // Grey
            '#D7CCC8', // Brown
            '#B2DFDB', // Teal
            '#E1BEE7', // Purple
            '#FFF9C4', // Yellow
            '#BBDEFB', // Blue
            '#ECEFF1'  // Blue Grey
        ];
    }
    // [v2.38 Fix] Share Config - Reverted to Original Link
    static get SHARE_URL() { return 'https://reurl.cc/oK5Arj'; }
    // [v2.40 Fix] Use Google Drive Thumbnail API for more reliable embedding
    static get CUSTOM_QR_IMAGE_URL() { return 'https://drive.google.com/thumbnail?id=1Vh82Dt8qsEAtJSP-uzOqbYeK4sSBoHDw&sz=w400'; } 
    // Fallback API
    static get QR_CODE_API() { return 'https://chart.googleapis.com/chart?chs=200x200&cht=qr&chl='; }
}

// 2. DateUtils: æ—¥æœŸå·¥å…· (Pure Functions)
class DateUtils {
    static getLocalDateString(isoStr) {
        if (!isoStr) return '';
        const date = new Date(isoStr);
        const offset = date.getTimezoneOffset() * 60000;
        const localDate = new Date(date.getTime() - offset);
        return localDate.toISOString().split('T')[0];
    }

    static addDaysToDateString(dateStr, days) {
        const parts = dateStr.split('-');
        const y = parseInt(parts[0], 10);
        const m = parseInt(parts[1], 10) - 1;
        const d = parseInt(parts[2], 10);
        const tempDate = new Date(y, m, d);
        tempDate.setDate(tempDate.getDate() + days);
        const newY = tempDate.getFullYear();
        const newM = (tempDate.getMonth() + 1).toString().padStart(2, '0');
        const newD = tempDate.getDate().toString().padStart(2, '0');
        return `${newY}-${newM}-${newD}`;
    }

    static getTodayString() {
        // [v2.50 Fix] Use local timezone string to ensure today is correctly identified across timezones
        const d = new Date();
        const offset = d.getTimezoneOffset() * 60000;
        const localDate = new Date(d.getTime() - offset);
        return localDate.toISOString().split('T')[0];
    }

    // [v2.46 Update] Robust parser for Taiwan Time Strings with implicit or explicit timezone
    static parseTaiwanDateTime(isoStr) {
        if (!isoStr) return null;
        
        let cleanStr = isoStr;
        // Strip existing offset or Z to treat numbers as absolute Taiwan digits
        if (cleanStr.includes('Z')) cleanStr = cleanStr.replace('Z', '');
        cleanStr = cleanStr.replace(/[\+\-]\d{2}:?\d{2}$/, ''); 
        
        // Match standard ISO format YYYY-MM-DDTHH:mm...
        // [v2.50 Fix] Regex extended to support date-only strings (without time)
        const match = cleanStr.match(/^(\d{4})-(\d{2})-(\d{2})(?:[T\s](\d{2}):(\d{2}))?/);
        if (!match) return null;

        const y = parseInt(match[1], 10);
        const m = parseInt(match[2], 10) - 1; // JS Month is 0-indexed
        const d = parseInt(match[3], 10);
        // Default to 00:00 if time is missing
        const h = match[4] ? parseInt(match[4], 10) : 0;
        const min = match[5] ? parseInt(match[5], 10) : 0;

        // 1. Create UTC timestamp from digits (Treating digits as GMT+0)
        const utcMs = Date.UTC(y, m, d, h, min);

        // 2. Shift by -8 Hours to represent the actual moment in time (since digits were GMT+8)
        const taiwanOffsetMs = 8 * 60 * 60 * 1000;
        const absoluteTimeMs = utcMs - taiwanOffsetMs;

        return new Date(absoluteTimeMs);
    }
}

// [v2.48 New] CalendarUtils: Handle Calendar Logic
class CalendarUtils {
    static generateGoogleCalendarUrl(event) {
        // 1. Parse stored time (Taiwan Time +08:00) to Date Object using DateUtils
        const startDate = DateUtils.parseTaiwanDateTime(event.start);
        let endDate = event.end ? DateUtils.parseTaiwanDateTime(event.end) : null;

        if (!startDate) return '#';

        if (!endDate) {
            // If no end time, assume 1 hour duration
             endDate = new Date(startDate.getTime() + (60 * 60 * 1000));
        }

        // 2. Format to Google's UTC requirement: YYYYMMDDTHHMMSSZ
        const formatUTC = (date) => {
            return date.toISOString().replace(/-|:|\.\d\d\d/g, "");
        };

        const startUTC = formatUTC(startDate);
        const endUTC = formatUTC(endDate);

        // 3. Construct URL
        const title = encodeURIComponent(event.title || 'ç„¡æ¨™é¡Œ');
        const details = encodeURIComponent('æ³°åœ‹å¤©èŒ‚ä½›å ‚è¡Œäº‹æ›† - ä¾†è‡ªå…±åŒè¡Œäº‹æ›†çš„æ´»å‹•');
        
        return `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startUTC}/${endUTC}&details=${details}`;
    }
}

// 3. APIService: é›²ç«¯æœå‹™å±¤ (ç„¡ UI)
class APIService {
    static async fetchEvents() {
        try {
            const res = await fetch(Config.API_URL);
            return await res.json();
        } catch (error) {
            console.error("Fetch Error:", error);
            throw error;
        }
    }

    static async saveEvent(data, action) {
        // [v2.52] Attach App Secret
        const payload = { action: action, appSecret: Config.API_SECRET, ...data };
        
        return fetch(Config.API_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(payload)
        });
    }

    static async deleteEvent(id) {
        // [v2.52] Attach App Secret
        return fetch(Config.API_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ action: 'delete', id: id, appSecret: Config.API_SECRET })
        });
    }

    static async sendReport(content) {
        // [v2.52] Attach App Secret (Optional for report, but good practice)
        return fetch(Config.API_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ action: 'send_report', content: content, appSecret: Config.API_SECRET })
        });
    }
}

// 4. CaptchaSystem: é©—è­‰ç¢¼ç³»çµ±
class CaptchaSystem {
    constructor(displayId, inputId) {
        this.displayId = displayId;
        this.inputId = inputId;
        this.currentCode = "";
    }

    generate() {
        const displayEl = document.getElementById(this.displayId);
        const inputEl = document.getElementById(this.inputId);
        this.currentCode = Math.floor(1000 + Math.random() * 9000).toString();
        if (displayEl) displayEl.innerText = this.currentCode;
        if (inputEl) inputEl.value = '';
        return this.currentCode;
    }

    validate() {
        const inputEl = document.getElementById(this.inputId);
        if (!inputEl) return false;
        return inputEl.value === this.currentCode;
    }
}

// 5. LinkManager: é€£çµç®¡ç†é‚è¼¯
class LinkManager {
    constructor() {
        this.links = [];
        this.maxLinks = 3;
    }

    setLinks(links) {
        this.links = Array.isArray(links) ? links : [];
    }

    addLink(name, url) {
        if (this.links.length >= this.maxLinks) throw new Error('æ•¸é‡é™åˆ¶ï¼šæœ€å¤š 3 å€‹é€£çµ');
        if (!name || !url) throw new Error('è«‹è¼¸å…¥åç¨±èˆ‡ç¶²å€');
        this.links.push({ name, url });
    }

    removeLink(index) {
        if (index >= 0 && index < this.links.length) {
            this.links.splice(index, 1);
        }
    }

    getLinks() { return this.links; }
    getJson() { return JSON.stringify(this.links); }
    
    static checkSafety(url) {
        try {
            const u = new URL(url);
            return u.protocol === 'https:';
        } catch { return false; }
    }
}

// 6. EventManager: è³‡æ–™é‚è¼¯å±¤
class EventManager {
    constructor() {
        this.allEvents = [];
    }

    setEvents(rawData) {
        this.allEvents = [];
        if (rawData.result && rawData.result.startsWith("Error")) return [];
        
        rawData.forEach(item => {
            // [v2.49 New] Frontend Filter for Soft Delete (Ignore items marked isDeleted=true by backend)
            if (item.isDeleted === true || item.isDeleted === "true") return;

            // [v2.51 New] Smart Correction for Swapped Columns
            let correctedTitle = item.title;
            let correctedType = item.type;
            
            if ((item.title === 'activity' || item.title === 'person') && 
                (item.type !== 'activity' && item.type !== 'person')) {
                correctedTitle = item.type;
                correctedType = item.title;
            }

            const type = correctedType || (item.extendedProps && item.extendedProps.type) || 'person';
            const isActivity = (type === 'activity');
            const itemOrder = isActivity ? -1 : 10;
            
            this.allEvents.push({
                id: item.id,
                title: correctedTitle || '(ç„¡åç¨±)', // [v2.50 Fix] Default title fallback
                start: item.start,
                end: item.end,
                backgroundColor: item.backgroundColor,
                textColor: item.textColor,
                extendedProps: {
                    type: type,
                    order: itemOrder,
                    // [v2.54 Fix] Deep Access for Link Data (GAS return structure is nested)
                    linkName: item.linkName || (item.extendedProps && item.extendedProps.linkName) || '',
                    linkUrl: item.linkUrl || (item.extendedProps && item.extendedProps.linkUrl) || ''
                },
                order: itemOrder,
                    type: type
            });
        });
    }

    getExplodedEvents() {
        let exploded = [];
        this.allEvents.forEach(item => {
            if (!item.start) return;

            const isActivity = (item.type === 'activity');
            const startDateStr = DateUtils.getLocalDateString(item.start);
            let endDateStr = item.end ? DateUtils.getLocalDateString(item.end) : startDateStr;

            if (isActivity) endDateStr = DateUtils.addDaysToDateString(endDateStr, 1);

            let currentStr = startDateStr;
            let safetyLoop = 0;
            const originalStartTimestamp = new Date(item.start).getTime();

            while (currentStr < endDateStr) {
                if (safetyLoop++ > 365) break;

                const classList = ['hide-time-text'];
                if (isActivity) classList.push('event-type-activity');
                else classList.isActivity ? classList.push('event-type-activity') : classList.push('person-pill');
                
                exploded.push({
                    id: item.id,
                    title: item.title,
                    start: currentStr,
                    end: currentStr,
                    allDay: true,
                    backgroundColor: item.backgroundColor,
                    textColor: item.textColor,
                    extendedProps: item.extendedProps,
                    originalStart: originalStartTimestamp,
                    order: item.extendedProps.order,
                    classNames: classList
                });
                currentStr = DateUtils.addDaysToDateString(currentStr, 1);
            }
        });
        return exploded;
    }

    getUpcomingEvents() {
        const todayStr = DateUtils.getTodayString();
        return this.allEvents.filter(e => DateUtils.getLocalDateString(e.start) >= todayStr);
    }

    getHistoryEvents(year, type) {
        const todayStr = DateUtils.getTodayString();
        return this.allEvents.filter(e => {
            const dateStr = DateUtils.getLocalDateString(e.start);
            const y = dateStr.substring(0, 4);
            const eType = e.type || 'person';
            // [v2.50 Fix] Change < to <= so today's passed events are included if needed
            return y === year && (type === 'all' || eType === type) && (dateStr <= todayStr);
        }).sort((a, b) => new Date(a.start) - new Date(b.start));
    }

    getYearsList() {
        const years = new Set(this.allEvents.map(e => DateUtils.getLocalDateString(e.start).substring(0, 4)));
        return Array.from(years).sort((a, b) => b - a);
    }

    findEventById(id) {
        return this.allEvents.find(e => e.id === id);
    }
}

// 7. UIManager: ä»‹é¢ç¸½ç®¡
class UIManager {
    constructor(app) {
        this.app = app;
        this.linkManager = new LinkManager();
        this.mainCaptcha = new CaptchaSystem('captchaDisplay', 'captchaInput');
        this.reportCaptcha = new CaptchaSystem('reportCaptchaDisplay', 'reportCaptchaInput');
        this.deleteLinkCaptcha = new CaptchaSystem('reportCaptchaDisplay', 'deleteLinkCaptchaInput');    
        
        this.isEditingPastActivity = false;
        
        this.modalEl = new bootstrap.Modal(document.getElementById('eventModal'));
        this.bindEvents();
    }

    bindEvents() {
        document.getElementById('eventForm').addEventListener('submit', (e) => this.handleFormSubmit(e));
        
        const palette = document.getElementById('colorPalette');
        let html = '';
        Config.COLORS_PERSON.forEach((color, index) => {
            html += `<div class="color-swatch" style="background-color: ${color};" data-color="${color}" onclick="app.ui.selectColor('${color}')"></div>`;
        });
        palette.innerHTML = html;
    }

    renderDashboard() {
        const upcoming = this.app.eventManager.getUpcomingEvents();
        const listContainer = document.getElementById('upcomingList');
        
        if (upcoming.length === 0) {
            listContainer.innerHTML = '<div class="text-center text-muted py-4 small">è¿‘æœŸç„¡æ´»å‹•</div>';
        } else {
            const activities = upcoming.filter(e => e.type === 'activity').sort((a,b)=>new Date(a.start)-new Date(b.start));
            const people = upcoming.filter(e => e.type !== 'activity').sort((a,b)=>new Date(a.start)-new Date(b.start));
            
            let html = '';
            if (activities.length > 0) {
                // [v2.47 Update] Add timezone hint text aligned to right
                html += `<div class="section-label d-flex justify-content-between align-items-center">
                            <span>è¿‘æœŸæ´»å‹•</span>
                            <span class="text-secondary fw-normal" style="font-size: 0.65rem; opacity: 0.8;">
                                <i class="fa-solid fa-earth-asia me-1"></i>ä¾ç…§æ‚¨çš„æ‰€åœ¨åœ°è‡ªå‹•åˆ‡æ›ç•¶åœ°æ™‚é–“
                            </span>
                         </div>`;
                activities.forEach(e => {
                    // [v2.46 Fix] Robust Dashboard Timezone Display
                    let dStr = 'NAN', tStr = 'NAN';
                    const eventTime = DateUtils.parseTaiwanDateTime(e.start);

                    if (eventTime && !isNaN(eventTime.getTime())) {
                        // Check if system is in UTC (preview/server env)
                        const isUTCSystem = new Date().getTimezoneOffset() === 0;
                        
                        if (isUTCSystem) {
                            // FORCE Display as Taiwan Time (+8) if system is UTC
                            const twTime = new Date(eventTime.getTime() + (8 * 60 * 60 * 1000));
                            dStr = twTime.toISOString().substring(0, 10);
                            tStr = twTime.toISOString().substring(11, 16);
                        } else {
                            // Normal Browser: Display Local Time (Taiwan or Thailand)
                            dStr = eventTime.getFullYear() + '-' + 
                                      String(eventTime.getMonth() + 1).padStart(2, '0') + '-' + 
                                      String(eventTime.getDate()).padStart(2, '0');
                                      
                            tStr = String(eventTime.getHours()).padStart(2, '0') + ':' + 
                                      String(eventTime.getMinutes()).padStart(2, '0');
                        }
                    } else {
                        // Fallback
                        dStr = e.start.substring(0, 10);
                        tStr = e.start.includes('T') ? e.start.substring(11, 16) : '00:00';
                    }
                    
                    html += `<button class="btn dashboard-btn btn-act" style="background-color:#ffe9f3; color:#5D4037; border-left: 4px solid #fa436b !important; font-weight: bold;" onclick="jumpToDate('${e.start}')">
                                     <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
                                          <strong>${e.title}</strong>
                                          <small class="person-date-text" style="font-weight: bold;">${dStr} ${tStr}</small>
                                     </div>
                             </button>`;
                });
            }
            if (people.length > 0) {
                html += `<div class="section-label">è¿‘æœŸåƒèˆ‡äººå“¡</div><div class="d-block d-flex flex-wrap gap-1">`; // Use flex-wrap here for inline buttons
                people.forEach(e => {
                    const d = DateUtils.getLocalDateString(e.start);
                    // [v2.23 Fix] Use .btn-person-pill for auto width, and ensure inner content is separated (Name | Date)
                    html += `<button class="btn dashboard-btn btn-person-pill" style="background:${e.backgroundColor}; color:#5D4037; border-left: 4px solid transparent !important;" onclick="jumpToDate('${e.start}')">
                                             <strong style="font-weight: bold;">${e.title}</strong>
                                             <span class="person-date-text">${d}</span>
                             </button>`;
                });
                html += `</div>`;
            }
            listContainer.innerHTML = html;
        }
        
        const years = this.app.eventManager.getYearsList();
        const sel = document.getElementById('searchYear');
        sel.innerHTML = '<option value="">é¸æ“‡å¹´ä»½...</option>';
        years.forEach(y => sel.innerHTML += `<option value="${y}">${y}å¹´</option>`);
    }

    renderHistoryResult() {
        const yVal = document.getElementById('searchYear').value;
        const tVal = document.getElementById('searchType').value;
        const resSel = document.getElementById('searchResult');
        resSel.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
        if(!yVal) return;

        const results = this.app.eventManager.getHistoryEvents(yVal, tVal);
        if(results.length === 0) { resSel.innerHTML = '<option value="">æŸ¥ç„¡è³‡æ–™</option>'; return; }
        
        results.forEach(e => {
            const d = DateUtils.getLocalDateString(e.start);
            resSel.innerHTML += `<option value="${e.start}">${d} - ${e.title}</option>`;
        });
    }

    openAddModal() {
        document.getElementById('eventForm').reset();
        document.getElementById('eventId').value = '';
        document.getElementById('modalTitle').innerText = 'æ–°å¢è³‡æ–™';
        document.getElementById('deleteBtn').style.display = 'none';
        
        // [v2.48 New] Hide Add to Calendar button in Add Mode
        document.getElementById('addToCalendarContainer').style.display = 'none';

        this.isEditingPastActivity = false;
        this.linkManager.setLinks([]);
        document.getElementById('completedSection').style.display = 'none';
        document.getElementById('urlSafetyFeedback').innerHTML = '';

        const currentDate = this.app.calendar.getDate();
        const today = new Date();
        let targetDate = (currentDate.getMonth() === today.getMonth()) ? today : currentDate;
        const dStr = DateUtils.getLocalDateString(targetDate.toISOString());
        
        document.getElementById('startDate').value = dStr;
        document.getElementById('endDate').value = dStr;
        
        const r = 15 - (new Date().getMinutes() % 15);
        const now = new Date(); now.setMinutes(now.getMinutes() + r);
        const t = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        document.getElementById('startTime').value = t;    
        document.getElementById('endTime').value = t;

        // [v2.42 New] Default timezone to Taiwan
        document.getElementById('tzTaiwan').checked = true;
        this.updateTimezoneHint();

        this.mainCaptcha.generate();
        document.getElementById('selectedColor').value = '';    
        this.toggleFormFields();
        
        // [v2.30 Change] è¼‰å…¥æ™‚ä¸è¨­å®š UX é è¨­ï¼Œé¿å…è¦†è“‹å¤šæ—¥æ´»å‹•ã€‚
        // è€Œæ˜¯ä¾è³´ syncDates å…§çš„æª¢æŸ¥ logic (v2.29)
        originalStartDate = dStr; // åˆå§‹åŒ–åŸå§‹é–‹å§‹æ—¥æœŸ
        window.syncDates(false); // å‚³é false æ——æ¨™ï¼Œè¡¨ç¤ºéä½¿ç”¨è€…äº’å‹•
        
        this.modalEl.show();
    }

    openEditModal(fcEvent) {
        const e = this.app.eventManager.findEventById(fcEvent.id) || fcEvent;
        const props = e.extendedProps || {};
        const type = props.type || 'person';

        document.getElementById('eventId').value = e.id;
        document.getElementById('modalTitle').innerText = 'ç·¨è¼¯è³‡æ–™';
        document.getElementById('deleteBtn').style.display = 'block';
        document.getElementById('eventType').value = type;
        document.getElementById('eventTitle').value = e.title;

        if(e.backgroundColor) this.selectColor(e.backgroundColor);

        const todayStr = DateUtils.getTodayString();
        this.isEditingPastActivity = false;
        if (e.start && type === 'activity') {
            const endStr = e.end ? DateUtils.getLocalDateString(e.end) : DateUtils.getLocalDateString(e.start);
            if (endStr <= todayStr) this.isEditingPastActivity = true;
        }

        try {
            this.linkManager.setLinks(JSON.parse(props.linkUrl || '[]'));
        } catch {
            if(props.linkUrl && !props.linkUrl.startsWith('[')) {
                this.linkManager.setLinks([{name: props.linkName || 'é€£çµ', url: props.linkUrl}]);
            } else {
                this.linkManager.setLinks([]);
            }
        }
        document.getElementById('linkName').value = '';
        document.getElementById('linkUrl').value = '';
        document.getElementById('urlSafetyFeedback').innerHTML = '';

        this.toggleFormFields();    

        // [v2.48 New] Generate and Show Google Calendar Button in Edit Mode
        const googleUrl = CalendarUtils.generateGoogleCalendarUrl(e);
        const btn = document.getElementById('btnAddToGoogle');
        btn.href = googleUrl;
        document.getElementById('addToCalendarContainer').style.display = 'block';

        // [v2.42] Edit Mode Default Timezone: Always start with System Time (Taiwan)
        document.getElementById('tzTaiwan').checked = true;
        this.updateTimezoneHint();

        if(e.start) {
            const sStr = DateUtils.getLocalDateString(e.start);
            document.getElementById('startDate').value = sStr;
            if (type === 'person') {
                const eStrRaw = e.end ? DateUtils.getLocalDateString(e.end) : sStr;
                const correctEnd = DateUtils.addDaysToDateString(eStrRaw, -1);
                document.getElementById('endDate').value = correctEnd; 
            } else {
                // [v2.41 Fix] Robust time extraction for Date objects or ISO Strings
                const getTimeString = (val) => {
                    if (!val) return '00:00';
                    const d = new Date(val); 
                    if (isNaN(d.getTime())) return '00:00';
                    const h = d.getHours().toString().padStart(2, '0');
                    const m = d.getMinutes().toString().padStart(2, '0');
                    return `${h}:${m}`;
                };

                document.getElementById('startTime').value = getTimeString(e.start);
                
                if(e.end) {
                    document.getElementById('endDate').value = DateUtils.getLocalDateString(e.end);
                    document.getElementById('endTime').value = getTimeString(e.end);
                } else {
                    document.getElementById('endDate').value = sStr;
                    document.getElementById('endTime').value = getTimeString(e.start);
                }
            }
        }

        // [v2.30 Change] è¼‰å…¥æ™‚ä¸è¨­å®š UX é è¨­ï¼Œä¾è³´ syncDates è™•ç†è¼‰å…¥é‚è¼¯ã€‚
        originalStartDate = document.getElementById('startDate').value; // è¨­å®šåŸå§‹é–‹å§‹æ—¥æœŸ
        window.syncDates(false); // å‚³é false æ——æ¨™ï¼Œè¡¨ç¤ºéä½¿ç”¨è€…äº’å‹•
        
        this.mainCaptcha.generate();
        this.modalEl.show();
    }
    
    // [v2.31 New] Share Modal Method
    openShareModal() {
        let qrUrl = Config.CUSTOM_QR_IMAGE_URL;
        const backupUrl = Config.QR_CODE_API + encodeURIComponent(Config.SHARE_URL);

        Swal.fire({
            title: 'åˆ†äº«å…±åŒè¡Œäº‹æ›†',
            html: `
                <div class="text-center p-3">
                    <p class="text-secondary mb-3">æƒææ­¤ QR Code æˆ–é»æ“Šä¸‹æ–¹é€£çµåˆ†äº«çµ¦é“è¦ª</p>
                    <img src="${qrUrl}" alt="QR Code" style="width:200px; height:200px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px;" 
                         referrerpolicy="no-referrer" 
                         onerror="this.onerror=null; this.src='${backupUrl}';">
                    <div class="input-group">
                        <input type="text" id="shareLinkInput" class="form-control" value="${Config.SHARE_URL}" readonly>
                        <button class="btn btn-primary" onclick="copyShareLink()">è¤‡è£½é€£çµ</button>
                    </div>
                    <small class="text-muted d-block mt-2">${Config.SHARE_URL}</small>
                </div>
            `,
            showConfirmButton: false,
            showCloseButton: true,
            width: '400px'
        });
    }


    toggleFormFields() {
        const type = document.getElementById('eventType').value;
        const colorSection = document.getElementById('colorSection');
        const completedSection = document.getElementById('completedSection');
        
        document.getElementById('nameLabel').innerText = type === 'activity' ? 'æ´»å‹•åç¨±' : 'åƒèˆ‡äººå§“å';
        document.querySelectorAll('.time-field-group').forEach(el => el.style.display = type === 'activity' ? 'block' : 'none');

        if (type === 'activity') {
            colorSection.style.display = 'none';
            document.getElementById('selectedColor').value = Config.COLOR_ACTIVITY;
            
            // [v2.53 Fix] Always show Completed Section if Links Exist OR it's a past activity
            // This logic is more robust than date-only checking
            const hasLinks = this.linkManager.getLinks().length > 0;
            
            if (this.isEditingPastActivity || hasLinks) {
                completedSection.style.display = 'block';
                this.renderLinkList();
            } else {
                completedSection.style.display = 'none';
            }
        } else {
            colorSection.style.display = 'block';
            completedSection.style.display = 'none';
            
            if (!document.getElementById('eventId').value) {
                const lastColor = localStorage.getItem('lastPersonColor');
                const defaultColor = (lastColor && Config.COLORS_PERSON.includes(lastColor)) ? lastColor : Config.COLORS_PERSON[0];
                this.selectColor(defaultColor);
            }
        }
    }

    // [v2.42 New] Logic to update the timezone hint text
    updateTimezoneHint() {
        const isThai = document.getElementById('tzThai').checked;
        const hintEl = document.getElementById('timezoneHint');
        const displayEl = document.getElementById('convertedTimeDisplay');
        const sDate = document.getElementById('startDate').value;
        const sTime = document.getElementById('startTime').value;

        if (!isThai || !sDate || !sTime) {
            hintEl.style.display = 'none';
            return;
        }

        // Calculate preview: Thai Input + 1 hour = Taiwan Display Time
        const tempDate = new Date(`${sDate}T${sTime}`);
        tempDate.setHours(tempDate.getHours() + 1);
        
        const h = tempDate.getHours().toString().padStart(2, '0');
        const m = tempDate.getMinutes().toString().padStart(2, '0');
        
        // Check if date changed (e.g., 23:00 TH -> 00:00 TW next day)
        const inputDateStr = sDate;
        const calcDateStr = DateUtils.getLocalDateString(tempDate.toISOString());
        
        let text = `${h}:${m}`;
        if (calcDateStr !== inputDateStr) {
            text += ` (éš”æ—¥)`;
        }

        displayEl.innerText = text;
        hintEl.style.display = 'block';
    }

    selectColor(color) {
        document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('selected'));
        const swatch = document.querySelector(`.color-swatch[data-color="${color}"]`);
        if (swatch) swatch.classList.add('selected');
        document.getElementById('selectedColor').value = color;
    }

    addLink() {
        try {
            const name = document.getElementById('linkName').value.trim();
            const url = document.getElementById('linkUrl').value.trim();
            this.linkManager.addLink(name, url);
            this.renderLinkList();
            document.getElementById('linkName').value = '';
            document.getElementById('linkUrl').value = '';
            document.getElementById('urlSafetyFeedback').innerHTML = '';
        } catch (e) {
            Swal.fire('æç¤º', e.message, 'warning');
        }
    }

    renderLinkList() {
        const list = document.getElementById('savedLinksList');
        const badge = document.getElementById('linkCountBadge');
        const links = this.linkManager.getLinks();
        
        badge.innerText = `${links.length}/3`;
        document.getElementById('savedLinksContainer').style.display = links.length ? 'block' : 'none';
        list.innerHTML = '';

        links.forEach((link, index) => {
            const isSafe = LinkManager.checkSafety(link.url);
            const badgeHtml = isSafe    
                ? '<span class="link-safety-badge badge-safe"><i class="fa-solid fa-lock"></i> å®‰å…¨</span>'
                : '<span class="link-safety-badge badge-unsafe"><i class="fa-solid fa-unlock"></i> ä¸å®‰å…¨</span>';
            
            const html = `
                <div class="saved-link-item">
                    <div class="saved-link-info">
                        <span class="saved-link-name">${link.name}</span>
                        <div><a href="${link.url}" target="_blank" class="saved-link-url">${link.url}</a>${badgeHtml}</div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger border-0 ms-2" onclick="app.ui.openDeleteLinkModal(${index})">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>`;
            list.insertAdjacentHTML('beforeend', html);
        });
    }

    checkUrlSafety(url) {
        const feedback = document.getElementById('urlSafetyFeedback');
        if (!url) { feedback.innerHTML = ''; return; }
        if (LinkManager.checkSafety(url)) {
            feedback.innerHTML = '<span class="text-success small fw-bold"><i class="fa-solid fa-circle-check me-1"></i>é€£çµæ ¼å¼å®‰å…¨ (HTTPS)</span>';
        } else {
            feedback.innerHTML = '<span class="text-warning small fw-bold"><i class="fa-solid fa-triangle-exclamation me-1"></i>éåŠ å¯† (HTTP) æˆ–æ ¼å¼æœ‰èª¤</span>';
        }
    }

    handleFormSubmit(e) {
        e.preventDefault();
        if (document.getElementById('captchaInput').value !== this.mainCaptcha.currentCode) {
            Swal.fire({ icon: 'error', title: 'é©—è­‰ç¢¼éŒ¯èª¤' }); return;
        }

        const sDate = document.getElementById('startDate').value;
        const eDate = document.getElementById('endDate').value;
        
        // [v2.19 Fix] æª¢æŸ¥çµæŸæ—¥æœŸæ˜¯å¦æ—©æ–¼é–‹å§‹æ—¥æœŸ (è¡¨å–®é©—è­‰å±¤ç´š)
        if (sDate > eDate) {
            Swal.fire({
                icon: 'error',
                title: 'æ—¥æœŸç¯„åœéŒ¯èª¤',
                text: 'çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼é–‹å§‹æ—¥æœŸï¼Œè«‹é‡æ–°é¸æ“‡ã€‚'
            });
            return;
        }

        const pName = document.getElementById('linkName').value.trim();
        const pUrl = document.getElementById('linkUrl').value.trim();
        if (pName && pUrl) try { this.linkManager.addLink(pName, pUrl); } catch {}

        const id = document.getElementById('eventId').value;
        const type = document.getElementById('eventType').value;
        
        let startStr, endStr;
        if (type === 'activity') {
            // [v2.42 Update] Timezone Calculation Logic
            // 1. Create Date objects from raw input
            let startObj = new Date(`${sDate}T${document.getElementById('startTime').value}`);
            let endObj = new Date(`${eDate}T${document.getElementById('endTime').value}`);

            // 2. Check Timezone Flag
            const isThai = document.getElementById('tzThai').checked;
            
            // 3. Apply Offset if Thailand Time is selected (+1 Hour to convert to TW System Time)
            if (isThai) {
                startObj.setHours(startObj.getHours() + 1);
                endObj.setHours(endObj.getHours() + 1);
            }

            // 4. Helper to format back to local ISO string (YYYY-MM-DDTHH:mm) for backend
            const formatLocal = (date) => {
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                const hh = String(date.getHours()).padStart(2, '0');
                const mm = String(date.getMinutes()).padStart(2, '0');
                // [v2.46 Update] Explicitly append +08:00 to lock Taiwan Time
                return `${y}-${m}-${d}T${hh}:${mm}:00+08:00`;
            };

            startStr = formatLocal(startObj);
            endStr = formatLocal(endObj);

        } else {
            startStr = sDate;
            endStr = DateUtils.addDaysToDateString(eDate, 1);
        }

        const color = document.getElementById('selectedColor').value;
        if (type !== 'activity') localStorage.setItem('lastPersonColor', color);

        const data = {
            id: id || ('evt_' + Date.now()),
            title: document.getElementById('eventTitle').value,
            type: type, start: startStr, end: endStr,
            backgroundColor: color, textColor: '#333333',
            order: type === 'activity' ? -1 : 10,
            linkName: 'MultiLinks',
            linkUrl: this.linkManager.getJson()
        };

        this.app.saveEvent(data, id ? 'update' : 'create');
    }

    openDeleteLinkModal(index) {
        const code = this.reportCaptcha.generate();    
        
        Swal.fire({
            title: 'åˆªé™¤é€£çµç¢ºèª',
            html: `
                <p class="text-secondary mb-2">è«‹è¼¸å…¥é©—è­‰ç¢¼ä»¥åˆªé™¤æ­¤é€£çµ</p>
                <div class="d-flex align-items-center mb-2">
                    <div id="reportCaptchaDisplay" class="captcha-box flex-grow-1">${code}</div>
                    <i class="fa-solid fa-arrows-rotate refresh-icon" onclick="app.ui.reportCaptcha.generate()"></i>
                </div>
                <input type="text" id="deleteLinkCaptchaInput" class="form-control" placeholder="è«‹è¼¸å…¥ä¸Šæ–¹é©—è­‰ç¢¼">
            `,
            showCancelButton: true, confirmButtonText: 'ç¢ºèªåˆªé™¤', confirmButtonColor: '#d32f2f',
            didOpen: () => {},
            preConfirm: () => {
                const input = document.getElementById('deleteLinkCaptchaInput').value;
                if (input !== this.reportCaptcha.currentCode) { Swal.showValidationMessage('é©—è­‰ç¢¼éŒ¯èª¤'); return false; }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                this.linkManager.removeLink(index);
                this.renderLinkList();
            }
        });
    }

    openReportModal() {
        const code = this.reportCaptcha.generate();
        const appVersion = Config.VERSION; // [v2.21 Update] Get version
        Swal.fire({
            title: 'å›å ±å•é¡Œ',
            html: `
                <textarea id="reportText" class="form-control mb-3" rows="4" placeholder="è«‹æè¿°æ‚¨é‡åˆ°çš„éŒ¯èª¤æˆ–å»ºè­°..."></textarea>
                <div class="d-flex align-items-center mb-2">
                    <div id="reportCaptchaDisplay" class="captcha-box flex-grow-1">${code}</div>
                    <i class="fa-solid fa-arrows-rotate refresh-icon" onclick="app.ui.reportCaptcha.generate()"></i>
                </div>
                <input type="text" id="reportCaptchaInput" class="form-control" placeholder="è«‹è¼¸å…¥ä¸Šæ–¹é©—è­‰ç¢¼">
                <small class="text-muted d-block mt-2">ç³»çµ±å°‡è‡ªå‹•é™„åŠ ç‰ˆæœ¬è™Ÿï¼š${appVersion}</small>
            `,
            showCancelButton: true, confirmButtonText: 'é€å‡ºå›å ±', confirmButtonColor: '#90A4AE',
            preConfirm: () => {
                let content = document.getElementById('reportText').value; 
                const input = document.getElementById('reportCaptchaInput').value;
                if (!content) { Swal.showValidationMessage('è«‹è¼¸å…¥å›å ±å…§å®¹'); return false; }
                if (input !== this.reportCaptcha.currentCode) { Swal.showValidationMessage('é©—è­‰ç¢¼éŒ¯èª¤'); return false; }
                
                // [v2.20 New] Prepend version to content
                const finalContent = `[ç‰ˆæœ¬ ${appVersion}] ${content}`;
                return finalContent;
            }
        }).then((res) => {
            if (res.isConfirmed) this.app.sendReport(res.value);
        });
    }

    confirmDelete() {
        if (!this.mainCaptcha.validate()) { Swal.fire({icon:'error', title:'é©—è­‰ç¢¼éŒ¯èª¤'}); return; }
        // [v2.49 Update] Updated delete confirmation text for Soft Delete strategy
        Swal.fire({
            title: 'ç¢ºå®šåˆªé™¤ï¼Ÿ', 
            html: '<small class="text-muted">è³‡æ–™å°‡ç§»è‡³å›æ”¶å€ï¼Œç³»çµ±æœƒæ¯æ—¥å½™æ•´é€šçŸ¥ç®¡ç†å“¡ã€‚</small>', 
            icon: 'warning', 
            showCancelButton: true, 
            confirmButtonColor: '#ef9a9a', 
            confirmButtonText: 'ç§»è‡³å›æ”¶å€'
        })
            .then(r => {
                if(r.isConfirmed) this.app.deleteEvent(document.getElementById('eventId').value);
            });
    }
}

// 8. App: ä¸»ç¨‹å¼å…¥å£
class App {
    constructor() {
        this.eventManager = new EventManager();
        this.ui = new UIManager(this);
        this.calendar = null;
    }

    init() {
        const opts = this.generateTimeOptions();
        document.getElementById('startTime').innerHTML = opts;
        document.getElementById('endTime').innerHTML = opts;
        this.initCalendar();
        
        // [v2.20 New] Display version
        this.displayVersion(); 
        
        // [v1.9] Listen to resize to adjust mobile/desktop height logic
        window.addEventListener('resize', () => {
            this.adjustCalendarLayout();
        });
    }
    
    // [v2.20 New] Method to display the app version
    displayVersion() {
        const versionEl = document.getElementById('appVersionDisplay');
        if (versionEl) {
            versionEl.textContent = `ç‰ˆæœ¬: ${Config.VERSION}`;
        }
    }

    generateTimeOptions() {
        let opt='';    
        for(let h=0;h<24;h++) for(let m=0;m<60;m+=15) {    
            let t = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;    
            opt+=`<option value="${t}">${t}</option>`;    
        }
        return opt;
    }

    initCalendar() {
        const calendarEl = document.getElementById('calendar');
        this.calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'zh-tw',
            headerToolbar: { left: 'myToday', center: 'prev,title,next', right: 'dayGridMonth,timeGridWeek,listWeek' },
            buttonText: { month: 'æœˆ', week: 'é€±', list: 'åˆ—è¡¨' },
            customButtons: {
                myToday: {
                    text: 'ä»Šå¤©',
                    click: () => {
                        this.calendar.today();
                        this.ui.jumpToDate(DateUtils.getTodayString());
                    }
                }
            },
            
            // [v2.32 New] Customize Day Headers: Strip "é€±" from text
            dayHeaderContent: (args) => {
                return args.text.replace('é€±', '');
            },
            
            // [v2.36 Fix] Remove explicit listDayFormat to restore default (better) formatting.
            // [v2.34 New] Add datesSet hook to track current view type for CSS styling
            datesSet: (info) => {
                document.getElementById('calendar').setAttribute('data-current-view', info.view.type);
            },

            eventDisplay: 'block',
            // [v1.9] Height logic moved to adjustCalendarLayout
            height: 'auto',
            dayMaxEvents: true,    
            
            // [v2.1] Custom More Link Text
            moreLinkContent: function(args) {
                const isDesktop = window.innerWidth >= 768;
                const text = isDesktop ? `+${args.num} more ` : `+${args.num} `;
                return { html: `${text}<i class="fa-solid fa-caret-down"></i>` };
            },
            
            fixedWeekCount: false,        
            eventOrder: 'order,originalStart,title',    
            navLinks: true,
            navLinkDayClick: (date) => this.jumpToDate(date),
            events: (info, success, fail) => this.fetchEventsWrapper(info, success, fail),
            eventClick: (info) => {
                if (info.view.type.includes('list')) this.jumpToDate(info.event.start);
                else this.ui.openEditModal(info.event);
            },
            eventTimeFormat: { hour: '2-digit', minute: '2-digit', meridiem: false, hour12: false }
        });
        this.calendar.render();
        
        // [v1.9] Initial adjustment
        this.adjustCalendarLayout();
        
        this.ui.jumpToDate = (d) => this.jumpToDate(d);
    }
    
    // [v1.9] Logic for switching between Desktop (Fixed Limit) & Mobile (Auto Height)
    adjustCalendarLayout() {
        if (!this.calendar) return;
        
        const isDesktop = window.innerWidth >= 768;
        
        if (isDesktop) {
            // Desktop: 
            // 1. Remove forced height (let it be 'auto' so CSS min-height works)
            // 2. FORCE dayMaxEvents to a number (e.g., 4) to ensure collapsing happens within that CSS height
            this.calendar.setOption('height', 'auto');
            this.calendar.setOption('dayMaxEvents', 4); // [v1.9] Key Fix for Desktop "More" Link
        } else {
            // Mobile: 
            // 1. Calculate available height to fill screen
            // 2. Use dayMaxEvents: true (Auto calc based on row height)
            const headerEl = document.getElementById('stickyHeader');
            const headerHeight = headerEl ? headerEl.offsetHeight : 60;
            const availableHeight = window.innerHeight - headerHeight - 20;    
            
            this.calendar.setOption('height', availableHeight);
            this.calendar.setOption('dayMaxEvents', true);
        }
    }

    fetchEventsWrapper(info, successCallback, failureCallback) {
        if (this.eventManager.allEvents.length === 0) {
            Swal.fire({ title: 'è³‡æ–™åŒæ­¥ä¸­...', didOpen: () => { Swal.showLoading() }, toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
        }
        
        APIService.fetchEvents()
            .then(data => {
                this.eventManager.setEvents(data);
                this.ui.renderDashboard();
                successCallback(this.eventManager.getExplodedEvents());
                Swal.close();
            })
            .catch(err => failureCallback(err));
    }

    saveEvent(data, action) {
        Swal.fire({title:'å„²å­˜ä¸­...', didOpen:()=>{Swal.showLoading()}});
        APIService.saveEvent(data, action)
            .then(() => {
                setTimeout(() => {    
                    Swal.fire({icon:'success', title:'å®Œæˆ', timer:1500, showConfirmButton:false});    
                    this.calendar.refetchEvents();    
                    this.ui.modalEl.hide();    
                }, 2000);
            })
            .catch(() => Swal.fire('é€£ç·šç•°å¸¸','è«‹æª¢æŸ¥ç¶²è·¯','error'));
    }

    deleteEvent(id) {
        Swal.fire({title:'åˆªé™¤ä¸­...', didOpen:()=>{Swal.showLoading()}});
        APIService.deleteEvent(id)
            .then(() => {
                setTimeout(() => {    
                    Swal.fire('å·²åˆªé™¤','','success');    
                    this.calendar.refetchEvents();    
                    this.ui.modalEl.hide();    
                }, 2000);
            });
    }

    sendReport(content) {
        Swal.fire({title:'å‚³é€ä¸­...', didOpen:()=>{Swal.showLoading()}});
        APIService.sendReport(content)
            .then(() => Swal.fire('å·²å›å ±', 'æ„Ÿè¬æ‚¨çš„å›é¥‹', 'success'))
            .catch(() => Swal.fire('å¤±æ•—', 'è«‹ç¨å¾Œå†è©¦', 'error'));
    }

    jumpToDate(dateVal) {
        this.calendar.changeView('dayGridMonth', dateVal);
        document.getElementById('calendar').scrollIntoView({behavior:'smooth'});
        const targetStr = typeof dateVal === 'string' ? DateUtils.getLocalDateString(dateVal) : DateUtils.getLocalDateString(dateVal.toISOString());
        
        setTimeout(() => {
            document.querySelectorAll('.highlight-target-day').forEach(el => el.classList.remove('highlight-target-day'));
            const targetEl = document.querySelector(`.fc-daygrid-day[data-date="${targetStr}"]`);
            if (targetEl) {
                targetEl.classList.add('highlight-target-day');
                targetEl.scrollIntoView({behavior: "smooth", block: "center", inline: "center"});
            }
        }, 200);
    }
}

// ==========================================
// ğŸš€ å•Ÿå‹• & Global Bridge (ç‚ºäº† HTML ç›¸å®¹æ€§)
// ==========================================
let app; // Declare global variable

document.addEventListener('DOMContentLoaded', () => {
    // Initialize App only after DOM is ready
    app = new App();
    app.init();
});

// Bridge functions for HTML onclick attributes
window.openAddModal = () => app.ui.openAddModal();
window.openReportModal = () => app.ui.openReportModal();
window.openShareModal = () => app.ui.openShareModal(); // [v2.31 New]
window.copyShareLink = () => { // [v2.31 New]
    const copyText = document.getElementById("shareLinkInput");
    copyText.select();
    document.execCommand('copy');
    Swal.fire({
        icon: 'success',
        title: 'å·²è¤‡è£½ï¼',
        toast: true,
        position: 'top-end',
        showConfirmButton: false,
        timer: 1500
    });
};
window.jumpToDate = (d) => app.jumpToDate(d);
window.jumpToSelectedEvent = () => {
    const val = document.getElementById('searchResult').value;
    if(val) app.jumpToDate(val);
    else Swal.fire({icon:'info', title:'æç¤º', text:'è«‹å…ˆé¸æ“‡ä¸€å€‹æœå°‹çµæœ'});
};
window.filterHistoryResult = () => app.ui.renderHistoryResult();
window.generateCaptcha = () => app.ui.mainCaptcha.generate();
window.refreshReportCaptcha = () => app.ui.reportCaptcha.generate();
window.confirmDelete = () => app.ui.confirmDelete();
window.addLinkToLocal = () => app.ui.addLink();
window.checkUrlSafety = (v) => app.ui.checkUrlSafety(v);
window.toggleFormFields = () => app.ui.toggleFormFields();
window.openDeleteLinkCaptchaModal = (idx) => app.ui.openDeleteLinkModal(idx);
window.updateTimezoneHint = () => app.ui.updateTimezoneHint();


// [v2.30 New] Global variable to store the original start date value for comparison
let originalStartDate = ''; 

// [v2.30 New] Bridge function to capture user change event and set the flag
window.handleStartChange = () => {
    const s = document.getElementById('startDate').value;
    // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦çœŸçš„è®Šå‹•äº†æ—¥æœŸï¼ˆä¸æ˜¯ç¨‹å¼ç¢¼åœ¨èƒŒæ™¯è¨­å®šï¼‰
    if (s !== originalStartDate) {
        // ç«‹å³å°‡ UX é‡è¨­ç‚ºå–®æ—¥
        document.getElementById('endDate').value = s;
        // æ›´æ–°åŸå§‹å€¼ï¼Œé¿å…ä¸‹æ¬¡å…¶ä»–æ¬„ä½è®Šå‹•æ™‚è¢«åˆ¤æ–·ç‚ºé–‹å§‹æ—¥æœŸè®Šå‹•
        originalStartDate = s;
    }
    
    // åŸ·è¡Œç´„æŸæª¢æŸ¥ (ç¢ºä¿çµæŸæ—¥æœŸ >= é–‹å§‹æ—¥æœŸï¼Œä¸¦åŒæ­¥æ™‚é–“)
    window.syncDates(true); 
};


// [v2.29 Fix] Revert logic to correct invalid range only, preserving multi-day events on load.
// [v2.30 Change] æ¥å—ä¸€å€‹åƒæ•¸ `isUserInteraction`ï¼šè‹¥ç‚º trueï¼Œå‰‡åŸ·è¡Œ UX é‡è¨­ï¼›è‹¥ç‚º false (è¼‰å…¥æ™‚)ï¼Œå‰‡åªåŸ·è¡Œç¯„åœç´„æŸæª¢æŸ¥ã€‚
window.syncDates = (isUserInteraction) => {
    const s = document.getElementById('startDate').value;
    const e = document.getElementById('endDate');
    
    // 1. è¨­å®šæœ€å°æ—¥æœŸç´„æŸ (UI Constraint)
    e.min = s;    

    // 2. åªæœ‰åœ¨ã€ŒçµæŸæ—¥æœŸã€ç„¡æ•ˆ (æˆ–æ¯”é–‹å§‹æ—¥æœŸæ—©) æ™‚ï¼Œæ‰å°‡å…¶è¨­ç‚ºé–‹å§‹æ—¥æœŸã€‚
    // é€™ç¢ºä¿äº†ï¼š
    // a) ç·¨è¼¯å¤šæ—¥æ´»å‹•æ™‚ï¼ŒçµæŸæ—¥æœŸæœƒè¢«ä¿ç•™ï¼ˆ9/15 > 9/9 -> false -> ä¿ç•™ 9/15ï¼‰ã€‚
    // b) å¦‚æœä½¿ç”¨è€…å°‡é–‹å§‹æ—¥æœŸæ”¹æˆ 9/16ï¼ŒèˆŠçš„çµæŸæ—¥æœŸ 9/15 æœƒå¤±æ•ˆï¼Œé€™è£¡å¿…é ˆä¿®æ­£ã€‚
    // c) åªæœ‰åœ¨ä½¿ç”¨è€…äº’å‹•æ™‚ï¼Œæ‰åŸ·è¡Œ UX é è¨­ï¼ˆè¦‹ handleStartChangeï¼‰

    if (!e.value || e.value < s) {
        e.value = s;
    }
    
    // 3. æª¢æŸ¥æ™‚é–“ç´„æŸ (ç•¶æ—¥æœŸç›¸ç­‰æ™‚)
    window.syncTimes();
};

// [v2.10] Add missing syncTimes for HTML compatibility
window.syncTimes = () => {
    const sDate = document.getElementById('startDate').value;
    const eDate = document.getElementById('endDate').value;
    // åªæœ‰åœ¨é–‹å§‹å’ŒçµæŸæ—¥æœŸç›¸åŒæ™‚ï¼Œæ‰éœ€è¦ç´„æŸæ™‚é–“ã€‚
    if (sDate === eDate) {
        const sTime = document.getElementById('startTime').value;
        const eTime = document.getElementById('endTime');
        // ç¢ºä¿çµæŸæ™‚é–“ä¸æ—©æ–¼é–‹å§‹æ™‚é–“
        if(eTime.value < sTime) eTime.value = sTime;
    }
};

</script>
</body>
</html>